<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årea do Motorista - GoT√°xi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
        }
        
        header {
            background-color: #000;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo span {
            color: #ffc107;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 20px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #333;
        }
        
        #map {
            height: calc(100vh - 60px);
            width: 100%;
            display: none;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            gap: 10px;
        }
        
        .btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #e0a800;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .request-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1002;
            display: none;
            width: 90%;
            max-width: 400px;
        }
        
        .request-card h3 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .request-details {
            margin-bottom: 20px;
        }
        
        .request-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .btn-accept {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-reject {
            background-color: #f44336;
            color: white;
        }
        
        .btn-reserve {
            background-color: #2196F3;
            color: white;
        }
        
        .timer {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #f44336;
            font-size: 18px;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 60px);
            background-color: #f5f5f5;
        }
        
        .login-form {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .login-btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .login-btn:hover {
            background-color: #e0a800;
        }

        .driver-name-badge {
            position: absolute;
            top: 80px;
            right: 20px;
            background-color: #ffc107;
            color: #000;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .reservation-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1003;
            display: none;
            width: 90%;
            max-width: 400px;
        }

        .reservation-card h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .reservation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .reservation-option {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .reservation-option:hover {
            background-color: #e0e0e0;
        }

        .reservation-option.selected {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
        }

        .reservation-actions {
            display: flex;
            justify-content: space-between;
        }

        .btn-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .distance-info {
            background-color: #e3f2fd;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: #ffc107;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
        }

        .register-link a {
            color: #2196F3;
            text-decoration: none;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        .success-message {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        /* Perfil do Motorista */
        .profile-container {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 85%;
            max-width: 350px;
            display: none;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .profile-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .profile-actions {
            display: flex;
            gap: 5px;
        }

        .profile-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }

        .btn-close {
            background-color: #f44336;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit {
            background-color: #2196F3;
            color: white;
        }

        .btn-save {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .profile-field {
            margin-bottom: 12px;
        }

        .profile-field label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 12px;
            color: #555;
        }

        .profile-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .profile-field input:read-only {
            background-color: #f9f9f9;
            color: #666;
        }

        .profile-footer {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .report-actions {
            margin-top: 15px;
            text-align: center;
        }

        .btn-report {
            background-color: #2196F3;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            width: 100%;
        }

        /* Relat√≥rio de Corridas */
        .report-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1004;
            display: none;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .report-header h3 {
            margin: 0;
        }

        .close-report {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .rides-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .ride-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .ride-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .ride-date {
            color: #666;
            font-size: 14px;
        }

        .ride-details p {
            margin: 5px 0;
        }

        .no-rides {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        .profile-menu-btn {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background-color: #ffc107;
            color: #000;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
            display: none;
            align-items: center;
            justify-content: center;
        }

        /* Popup de resposta da reserva */
        .reservation-response-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1005;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .reservation-response-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .reservation-response-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .reservation-response-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .reservation-response-title {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .reservation-response-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .reservation-accepted {
            color: #4CAF50;
        }

        .reservation-rejected {
            color: #f44336;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Go<span>T√°xi</span></div>
        <nav>
            <ul>
                <li><a href="index.html">In√≠cio</a></li>
                <li><a href="#" id="logoutBtn" style="display: none;">Sair</a></li>
            </ul>
        </nav>
    </header>
    
    <!-- Tela de Login/Registro -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <div class="tab-container">
                <div class="tab active" id="loginTab">Login</div>
                <div class="tab" id="registerTab">Registrar</div>
            </div>
            
            <!-- Mensagem de sucesso -->
            <div class="success-message" id="successMessage">
                ‚úÖ Registro realizado com sucesso! Fa√ßa login para continuar.
            </div>
            
            <!-- Formul√°rio de Login -->
            <div class="tab-content active" id="loginContent">
                <h2>Login do Motorista</h2>
                <div class="form-group">
                    <label for="username">Usu√°rio ou Email</label>
                    <input type="text" id="username" placeholder="Digite seu usu√°rio ou email">
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha">
                </div>
                <button class="login-btn" onclick="login()">Entrar</button>
                <div id="loginError" style="color: #f44336; text-align: center; margin-top: 15px; display: none;">
                    Usu√°rio ou senha incorretos!
                </div>
                <div class="register-link">
                    <a href="#" id="showRegister">N√£o tem conta? Registre-se</a>
                </div>
            </div>
            
            <!-- Formul√°rio de Registro -->
            <div class="tab-content" id="registerContent">
                <h2>Registro de Motorista</h2>
                <div class="form-group">
                    <label for="regName">Nome Completo</label>
                    <input type="text" id="regName" placeholder="Digite seu nome completo">
                </div>
                <div class="form-group">
                    <label for="regUsername">Usu√°rio</label>
                    <input type="text" id="regUsername" placeholder="Escolha um nome de usu√°rio">
                </div>
                <div class="form-group">
                    <label for="regLicensePlate">Matr√≠cula do Ve√≠culo</label>
                    <input type="text" id="regLicensePlate" placeholder="Ex: AA-00-00">
                </div>
                <div class="form-group">
                    <label for="regNif">NIF</label>
                    <input type="text" id="regNif" placeholder="Digite seu NIF">
                </div>
                <div class="form-group">
                    <label for="regPassword">Senha</label>
                    <input type="password" id="regPassword" placeholder="Crie uma senha">
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">Confirmar Senha</label>
                    <input type="password" id="regConfirmPassword" placeholder="Confirme sua senha">
                </div>
                <button class="login-btn" onclick="register()">Registrar</button>
                <div id="registerError" style="color: #f44336; text-align: center; margin-top: 15px; display: none;">
                    <!-- Mensagens de erro ser√£o exibidas aqui -->
                </div>
                <div class="register-link">
                    <a href="#" id="showLogin">J√° tem conta? Fa√ßa login</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- √Årea do Mapa (ap√≥s login) -->
    <div id="map"></div>
    
    <div class="driver-name-badge" id="driverNameBadge" style="display: none;">
        Motorista: <span id="driverNameDisplay"></span>
    </div>

    <!-- Bot√£o do Menu de Perfil -->
    <button class="profile-menu-btn" id="profileMenuBtn" style="display: none;" onclick="toggleProfile()">üë§</button>
    
    <!-- Perfil do Motorista -->
    <div class="profile-container" id="profileContainer">
        <div class="profile-header">
            <h3>üë§ Meu Perfil</h3>
            <div class="profile-actions">
                <button class="profile-btn btn-close" onclick="toggleProfile()">√ó</button>
            </div>
        </div>
        <div class="profile-fields">
            <div class="profile-field">
                <label for="profileName">Nome Completo</label>
                <input type="text" id="profileName" readonly>
            </div>
            <div class="profile-field">
                <label for="profileUsername">Usu√°rio</label>
                <input type="text" id="profileUsername" readonly>
            </div>
            <div class="profile-field">
                <label for="profileLicensePlate">Matr√≠cula do Ve√≠culo</label>
                <input type="text" id="profileLicensePlate" readonly>
            </div>
            <div class="profile-field">
                <label for="profileNif">NIF</label>
                <input type="text" id="profileNif" readonly>
            </div>
            <div class="profile-field">
                <label for="profilePhone">Telefone</label>
                <input type="tel" id="profilePhone" readonly>
            </div>
        </div>
        <div class="profile-footer">
            <button class="profile-btn btn-edit" id="editProfileBtn" onclick="enableEditMode()">Editar</button>
            <button class="profile-btn btn-save" id="saveProfileBtn" onclick="saveProfile()" style="display: none;">Salvar</button>
            <button class="profile-btn btn-cancel" id="cancelEditBtn" onclick="disableEditMode()" style="display: none;">Cancelar</button>
        </div>
        <div class="report-actions">
            <button class="btn-report" onclick="showReport()">üìä Relat√≥rio de Corridas</button>
        </div>
    </div>

    <!-- Relat√≥rio de Corridas -->
    <div id="reportContainer" class="report-container">
        <div class="report-header">
            <h3>üìä Relat√≥rio de Corridas</h3>
            <button class="close-report" onclick="closeReport()">√ó</button>
        </div>
        <div class="rides-list" id="ridesList">
            <!-- Lista de corridas ser√° preenchida aqui -->
        </div>
    </div>
    
    <div class="controls" id="controls">
        <button id="startTracking" class="btn">Iniciar Rastreamento</button>
        <button id="stopTracking" class="btn" disabled>Parar Rastreamento</button>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <div id="requestCard" class="request-card">
        <h3>üöï Nova Solicita√ß√£o de T√°xi</h3>
        <div class="timer" id="timer">120 segundos</div>
        <div class="distance-info" id="distanceInfo">
            üìç Calculando dist√¢ncia...
        </div>
        <div class="request-details" id="requestDetails">
            <!-- Detalhes da solicita√ß√£o ser√£o preenchidos aqui -->
        </div>
        <div class="request-actions">
            <button id="acceptRequest" class="btn btn-accept">‚úÖ Aceitar</button>
            <button id="reserveRequest" class="btn btn-reserve">‚è∞ Reserva</button>
            <button id="rejectRequest" class="btn btn-reject">‚ùå Rejeitar</button>
        </div>
    </div>

    <!-- Card de Reserva -->
    <div id="reservationCard" class="reservation-card">
        <h3>‚è∞ Propor Reserva</h3>
        <div class="request-details" id="reservationRequestDetails">
            <!-- Detalhes da solicita√ß√£o ser√£o preenchidos aqui -->
        </div>
        <div class="reservation-options">
            <button class="reservation-option" data-time="10">10 min</button>
            <button class="reservation-option" data-time="15">15 min</button>
            <button class="reservation-option" data-time="20">20 min</button>
            <button class="reservation-option" data-time="30">30 min</button>
            <button class="reservation-option" data-time="40">40 min</button>
        </div>
        <div class="reservation-actions">
            <button id="sendReservation" class="btn btn-confirm" disabled>üì§ Enviar Reserva</button>
            <button id="cancelReservation" class="btn btn-cancel">‚ùå Cancelar</button>
        </div>
    </div>

    <!-- Popup de resposta da reserva -->
    <div id="reservationResponsePopup" class="reservation-response-popup">
        <div class="reservation-response-content">
            <div class="reservation-response-icon" id="reservationResponseIcon">‚è∞</div>
            <h3 class="reservation-response-title" id="reservationResponseTitle">Resposta da Reserva</h3>
            <p class="reservation-response-message" id="reservationResponseMessage">
                Aguardando resposta do cliente...
            </p>
            <button class="btn" onclick="closeReservationResponse()" style="margin-top: 20px;">
                üè† Voltar para o Mapa
            </button>
        </div>
    </div>

    <!-- √Åudio para notifica√ß√£o -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAZ4YqmOZz0wUlhBvuSD_fBLcwq1av8yc8",
            authDomain: "gotaxi-4e391.firebaseapp.com",
            databaseURL: "https://gotaxi-4e391-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gotaxi-4e391",
            storageBucket: "gotaxi-4e391.firebasestorage.app",
            messagingSenderId: "597857194128",
            appId: "1:597857194128:web:9b550abd9b5e98bb374815"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Vari√°veis globais
        let map;
        let marker;
        let watchId;
        let isTracking = false;
        let countdown;
        let currentDriver = null;
        let currentRequestId = null;
        let currentRequest = null;
        let directionsService;
        let directionsRenderer;
        let selectedReservationTime = null;
        let reservationMarker;
        let geocoder;
        let lastPosition = null;
        let isEditingProfile = false;
        let originalProfileData = {};
        let currentReservationRequestId = null;

        // Sistema de armazenamento local para motoristas
        const DRIVERS_STORAGE_KEY = 'gotaxi_drivers';
        const RIDES_HISTORY_KEY = 'gotaxi_rides_history';
        
        // Inicializar sistema de motoristas
        function initializeDriversStorage() {
            if (!localStorage.getItem(DRIVERS_STORAGE_KEY)) {
                // Dados de exemplo para teste
                const defaultDrivers = {
                    'mega': {
                        name: 'Mega',
                        username: 'mega',
                        password: '12345',
                        licensePlate: 'AA-00-00',
                        nif: '123456789',
                        phone: '+351 912 345 678',
                        driverId: 'mega'
                    },
                    'heitor': {
                        name: 'Heitor',
                        username: 'heitor',
                        password: '12345',
                        licensePlate: 'BB-11-11',
                        nif: '987654321',
                        phone: '+351 923 456 789',
                        driverId: 'heitor'
                    }
                };
                localStorage.setItem(DRIVERS_STORAGE_KEY, JSON.stringify(defaultDrivers));
            }
        }

        // Obter todos os motoristas
        function getAllDrivers() {
            const drivers = localStorage.getItem(DRIVERS_STORAGE_KEY);
            return drivers ? JSON.parse(drivers) : {};
        }

        // Salvar motorista
        function saveDriver(driverData) {
            const drivers = getAllDrivers();
            drivers[driverData.driverId] = driverData;
            localStorage.setItem(DRIVERS_STORAGE_KEY, JSON.stringify(drivers));
            return true;
        }

        // Verificar se usu√°rio j√° existe
        function userExists(username) {
            const drivers = getAllDrivers();
            for (const driverId in drivers) {
                if (drivers[driverId].username === username) {
                    return true;
                }
            }
            return false;
        }

        // Salvar corrida no hist√≥rico
        function saveRideToHistory(rideData) {
            let ridesHistory = JSON.parse(localStorage.getItem(RIDES_HISTORY_KEY) || '{}');
            
            if (!ridesHistory[currentDriver.driverId]) {
                ridesHistory[currentDriver.driverId] = [];
            }
            
            // Adicionar a nova corrida no in√≠cio do array
            ridesHistory[currentDriver.driverId].unshift(rideData);
            
            // Manter apenas as √∫ltimas 100 corridas
            if (ridesHistory[currentDriver.driverId].length > 100) {
                ridesHistory[currentDriver.driverId] = ridesHistory[currentDriver.driverId].slice(0, 100);
            }
            
            localStorage.setItem(RIDES_HISTORY_KEY, JSON.stringify(ridesHistory));
        }

        // Obter hist√≥rico de corridas do motorista
        function getRidesHistory() {
            const ridesHistory = JSON.parse(localStorage.getItem(RIDES_HISTORY_KEY) || '{}');
            return ridesHistory[currentDriver.driverId] || [];
        }
        
        // Sistema de abas
        document.getElementById('showRegister').addEventListener('click', function(e) {
            e.preventDefault();
            switchToRegister();
        });
        
        document.getElementById('showLogin').addEventListener('click', function(e) {
            e.preventDefault();
            switchToLogin();
        });

        // Alternar para registro
        function switchToRegister() {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginContent').classList.remove('active');
            document.getElementById('registerContent').classList.add('active');
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
        }

        // Alternar para login
        function switchToLogin() {
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerContent').classList.remove('active');
            document.getElementById('loginContent').classList.add('active');
            document.getElementById('loginError').style.display = 'none';
        }
        
        // Fun√ß√£o de registro
        function register() {
            const name = document.getElementById('regName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const licensePlate = document.getElementById('regLicensePlate').value.trim();
            const nif = document.getElementById('regNif').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const registerError = document.getElementById('registerError');
            
            // Resetar mensagens de erro
            registerError.style.display = 'none';
            registerError.textContent = '';
            
            // Valida√ß√µes
            if (!name || !username || !licensePlate || !nif || !password || !confirmPassword) {
                registerError.textContent = "Todos os campos s√£o obrigat√≥rios!";
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                registerError.textContent = "As senhas n√£o coincidem!";
                registerError.style.display = 'block';
                return;
            }
            
            if (password.length < 4) {
                registerError.textContent = "A senha deve ter pelo menos 4 caracteres!";
                registerError.style.display = 'block';
                return;
            }
            
            if (userExists(username)) {
                registerError.textContent = "Este nome de usu√°rio j√° est√° em uso!";
                registerError.style.display = 'block';
                return;
            }
            
            // Criar novo motorista
            const driverId = 'driver_' + Date.now();
            
            // Dados do motorista
            const driverData = {
                name: name,
                username: username,
                licensePlate: licensePlate,
                nif: nif,
                password: password,
                driverId: driverId,
                phone: '',
                createdAt: new Date().toISOString(),
                status: 'offline'
            };
            
            // Salvar localmente
            try {
                saveDriver(driverData);
                console.log('Motorista registrado com sucesso:', driverId);
                
                // Mostrar mensagem de sucesso
                document.getElementById('successMessage').style.display = 'block';
                
                // Limpar formul√°rio de registro
                document.getElementById('regName').value = '';
                document.getElementById('regUsername').value = '';
                document.getElementById('regLicensePlate').value = '';
                document.getElementById('regNif').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regConfirmPassword').value = '';
                
                // Voltar para a tela de login ap√≥s 2 segundos
                setTimeout(() => {
                    switchToLogin();
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao registrar motorista:', error);
                registerError.textContent = "Erro ao registrar. Tente novamente.";
                registerError.style.display = 'block';
            }
        }
        
        // Fun√ß√£o de login
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            // Resetar mensagem de erro
            loginError.style.display = 'none';
            
            if (!username || !password) {
                loginError.textContent = "Por favor, preencha todos os campos!";
                loginError.style.display = 'block';
                return;
            }
            
            // Verificar credenciais localmente
            const drivers = getAllDrivers();
            let loginSuccess = false;
            let driverData = null;
            
            for (const driverId in drivers) {
                const driver = drivers[driverId];
                // Verificar se corresponde ao usu√°rio E senha
                if (driver.username === username && driver.password === password) {
                    loginSuccess = true;
                    driverData = driver;
                    break;
                }
            }
            
            if (loginSuccess) {
                // Login bem-sucedido
                currentDriver = driverData;
                
                // Esconder tela de login e mostrar mapa
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('map').style.display = 'block';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('logoutBtn').style.display = 'block';
                document.getElementById('driverNameBadge').style.display = 'block';
                document.getElementById('profileMenuBtn').style.display = 'flex';
                document.getElementById('driverNameDisplay').textContent = currentDriver.name;
                
                // Inicializar mapa
                initMap();
                
                showNotification(`Bem-vindo, ${currentDriver.name}!`);
                
                // Limpar campos de login
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                
            } else {
                // Login falhou
                loginError.textContent = "Usu√°rio ou senha incorretos!";
                loginError.style.display = 'block';
            }
        }
        
        // Fun√ß√£o de logout
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (isTracking) {
                stopTracking();
            }
            
            // Limpar dados de sess√£o
            currentDriver = null;
            
            // Mostrar tela de login
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('map').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('driverNameBadge').style.display = 'none';
            document.getElementById('profileMenuBtn').style.display = 'none';
            document.getElementById('profileContainer').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'none';
            
            // Limpar campos de login
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        });
        
        // Inicializar mapa
        function initMap() {
            // Posi√ß√£o inicial (Lisboa)
            const lisbon = { lat: 38.7223, lng: -9.1393 };
            
            // Criar mapa
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: lisbon,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                }
            });
            
            // Inicializar servi√ßos de rota (mantidos para c√°lculo de dist√¢ncia)
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: true
            });
            
            // Inicializar geocoder
            geocoder = new google.maps.Geocoder();
            
            // Criar marcador inicial
            marker = new google.maps.Marker({
                position: lisbon,
                map: map,
                title: `Motorista: ${currentDriver.name}`,
                icon: {
                    url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                    scaledSize: new google.maps.Size(40, 60),
                    anchor: new google.maps.Point(20, 20)
                }
            });
            
            // Tentar obter localiza√ß√£o atual
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        marker.setPosition(pos);
                        map.setCenter(pos);
                        lastPosition = pos;
                    },
                    () => {
                        handleLocationError(true, map.getCenter());
                    }
                );
            } else {
                // Navegador n√£o suporta Geolocation
                handleLocationError(false, map.getCenter());
            }
            
            // Carregar dados do perfil
            loadProfileData();
            
            // Configurar bot√µes de reserva
            setupReservationButtons();
            
            // Escutar por notifica√ß√µes de reserva
            listenForReservationNotifications();
        }
        
        function handleLocationError(browserHasGeolocation, pos) {
            console.log(
                browserHasGeolocation
                    ? "Erro: O servi√ßo de geolocaliza√ß√£o falhou."
                    : "Erro: Seu navegador n√£o suporta geolocaliza√ß√£o."
            );
            
            // Mostrar notifica√ß√£o de erro
            showNotification("N√£o foi poss√≠vel obter sua localiza√ß√£o.", true);
        }
        
        // Carregar dados do perfil
        function loadProfileData() {
            if (!currentDriver) return;
            
            document.getElementById('profileName').value = currentDriver.name || '';
            document.getElementById('profileUsername').value = currentDriver.username || '';
            document.getElementById('profileLicensePlate').value = currentDriver.licensePlate || '';
            document.getElementById('profileNif').value = currentDriver.nif || '';
            document.getElementById('profilePhone').value = currentDriver.phone || '';
            
            // Salvar dados originais para cancelamento
            originalProfileData = {
                name: currentDriver.name || '',
                licensePlate: currentDriver.licensePlate || '',
                nif: currentDriver.nif || '',
                phone: currentDriver.phone || ''
            };
        }
        
        // Alternar visibilidade do perfil
        function toggleProfile() {
            const profileContainer = document.getElementById('profileContainer');
            profileContainer.style.display = profileContainer.style.display === 'none' ? 'block' : 'none';
            
            // Fechar relat√≥rio se estiver aberto
            document.getElementById('reportContainer').style.display = 'none';
            
            // Garantir que est√° no modo de visualiza√ß√£o
            disableEditMode();
        }
        
        // Habilitar modo de edi√ß√£o
        function enableEditMode() {
            isEditingProfile = true;
            
            // Habilitar edi√ß√£o dos campos
            document.getElementById('profileName').readOnly = false;
            document.getElementById('profileLicensePlate').readOnly = false;
            document.getElementById('profileNif').readOnly = false;
            document.getElementById('profilePhone').readOnly = false;
            
            // Alterar background dos campos para indicar edi√ß√£o
            document.getElementById('profileName').style.backgroundColor = '#fff';
            document.getElementById('profileLicensePlate').style.backgroundColor = '#fff';
            document.getElementById('profileNif').style.backgroundColor = '#fff';
            document.getElementById('profilePhone').style.backgroundColor = '#fff';
            
            // Mostrar bot√µes de salvar/cancelar e esconder editar
            document.getElementById('editProfileBtn').style.display = 'none';
            document.getElementById('saveProfileBtn').style.display = 'block';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            showNotification("Modo de edi√ß√£o ativado. Fa√ßa suas altera√ß√µes e clique em Salvar.");
        }
        
        // Desabilitar modo de edi√ß√£o (voltar para visualiza√ß√£o)
        function disableEditMode() {
            isEditingProfile = false;
            
            // Desabilitar edi√ß√£o dos campos
            document.getElementById('profileName').readOnly = true;
            document.getElementById('profileLicensePlate').readOnly = true;
            document.getElementById('profileNif').readOnly = true;
            document.getElementById('profilePhone').readOnly = true;
            
            // Restaurar background dos campos
            document.getElementById('profileName').style.backgroundColor = '#f9f9f9';
            document.getElementById('profileLicensePlate').style.backgroundColor = '#f9f9f9';
            document.getElementById('profileNif').style.backgroundColor = '#f9f9f9';
            document.getElementById('profilePhone').style.backgroundColor = '#f9f9f9';
            
            // Mostrar bot√£o de editar e esconder salvar/cancelar
            document.getElementById('editProfileBtn').style.display = 'block';
            document.getElementById('saveProfileBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            // Se foi cancelado, restaurar valores originais
            if (originalProfileData) {
                document.getElementById('profileName').value = originalProfileData.name;
                document.getElementById('profileLicensePlate').value = originalProfileData.licensePlate;
                document.getElementById('profileNif').value = originalProfileData.nif;
                document.getElementById('profilePhone').value = originalProfileData.phone;
            }
            
            showNotification("Edi√ß√£o cancelada.");
        }
        
        // Salvar perfil
        function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const licensePlate = document.getElementById('profileLicensePlate').value.trim();
            const nif = document.getElementById('profileNif').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            
            // Valida√ß√µes b√°sicas
            if (!name) {
                showNotification("O nome √© obrigat√≥rio!", true);
                return;
            }
            
            if (!licensePlate) {
                showNotification("A matr√≠cula √© obrigat√≥ria!", true);
                return;
            }
            
            if (!nif) {
                showNotification("O NIF √© obrigat√≥rio!", true);
                return;
            }
            
            // Atualizar dados do motorista
            currentDriver.name = name;
            currentDriver.licensePlate = licensePlate;
            currentDriver.nif = nif;
            currentDriver.phone = phone;
            
            // Atualizar no armazenamento local
            const drivers = getAllDrivers();
            drivers[currentDriver.driverId] = currentDriver;
            localStorage.setItem(DRIVERS_STORAGE_KEY, JSON.stringify(drivers));
            
            // Atualizar dados originais
            originalProfileData = {
                name: name,
                licensePlate: licensePlate,
                nif: nif,
                phone: phone
            };
            
            // Atualizar badge do nome
            document.getElementById('driverNameDisplay').textContent = currentDriver.name;
            
            // Voltar para modo de visualiza√ß√£o
            disableEditMode();
            
            showNotification("Perfil atualizado com sucesso!");
        }
        
        // Mostrar relat√≥rio de corridas
        function showReport() {
            const rides = getRidesHistory();
            const ridesList = document.getElementById('ridesList');
            
            if (rides.length === 0) {
                ridesList.innerHTML = '<div class="no-rides">Nenhuma corrida realizada ainda.</div>';
            } else {
                let html = '';
                rides.forEach((ride, index) => {
                    html += `
                        <div class="ride-item">
                            <div class="ride-item-header">
                                <span>Corrida #${index + 1}</span>
                                <span class="ride-date">${ride.date || 'Data n√£o dispon√≠vel'}</span>
                            </div>
                            <div class="ride-details">
                                <p><strong>Cliente:</strong> ${ride.clientName || 'N√£o informado'}</p>
                                <p><strong>Origem:</strong> ${ride.origin || 'N√£o informado'}</p>
                                <p><strong>Destino:</strong> ${ride.destination || 'N√£o informado'}</p>
                                <p><strong>Passageiros:</strong> ${ride.passengers || '1'}</p>
                                <p><strong>Contato:</strong> ${ride.contact || 'N√£o informado'}</p>
                            </div>
                        </div>
                    `;
                });
                ridesList.innerHTML = html;
            }
            
            document.getElementById('reportContainer').style.display = 'block';
        }
        
        // Fechar relat√≥rio
        function closeReport() {
            document.getElementById('reportContainer').style.display = 'none';
        }
        
        // Configurar bot√µes de reserva
        function setupReservationButtons() {
            // Bot√£o de reserva na solicita√ß√£o
            document.getElementById("reserveRequest").addEventListener("click", function() {
                showReservationCard();
            });
            
            // Op√ß√µes de tempo de reserva
            document.querySelectorAll('.reservation-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remover sele√ß√£o anterior
                    document.querySelectorAll('.reservation-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Selecionar nova op√ß√£o
                    this.classList.add('selected');
                    selectedReservationTime = this.getAttribute('data-time');
                    
                    // Habilitar bot√£o de enviar
                    document.getElementById('sendReservation').disabled = false;
                });
            });
            
            // Enviar reserva
            document.getElementById('sendReservation').addEventListener('click', sendReservation);
            
            // Cancelar reserva
            document.getElementById('cancelReservation').addEventListener('click', function() {
                document.getElementById('reservationCard').style.display = 'none';
                document.getElementById('requestCard').style.display = 'none';
                clearInterval(countdown);
                currentRequestId = null;
                currentRequest = null;
            });
        }
        
        // Iniciar rastreamento
        document.getElementById("startTracking").addEventListener("click", function() {
            if (!navigator.geolocation) {
                showNotification("Seu navegador n√£o suporta geolocaliza√ß√£o.", true);
                return;
            }
            
            isTracking = true;
            document.getElementById("startTracking").disabled = true;
            document.getElementById("stopTracking").disabled = false;
            
            showNotification("Rastreamento iniciado. Voc√™ est√° vis√≠vel para os clientes.");
            
            // Atualizar status no Firebase
            database.ref(`drivers/${currentDriver.driverId}`).update({
                name: currentDriver.name,
                licensePlate: currentDriver.licensePlate,
                status: 'online',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Iniciar watch de posi√ß√£o com atualiza√ß√µes frequentes
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    
                    // Calcular heading (dire√ß√£o) se tivermos posi√ß√£o anterior
                    let heading = 0;
                    if (lastPosition) {
                        heading = calculateHeading(lastPosition, pos);
                    }
                    
                    // Atualizar marcador localmente
                    marker.setPosition(pos);
                    marker.setIcon({
                        url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                        scaledSize: new google.maps.Size(40, 60),
                        anchor: new google.maps.Point(20, 20),
                        rotation: heading
                    });
                    
                    // Atualizar no Firebase com alta frequ√™ncia para movimento suave
                    database.ref(`drivers/${currentDriver.driverId}`).update({
                        location: pos,
                        heading: heading,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    lastPosition = pos;
                },
                (error) => {
                    console.error("Erro ao obter localiza√ß√£o:", error);
                    showNotification("Erro ao obter localiza√ß√£o.", true);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 3000,  // Atualiza√ß√µes mais r√°pidas
                    maximumAge: 1000 // Atualiza√ß√£o a cada segundo
                }
            );
            
            // Escutar por solicita√ß√µes de clientes
            listenForRequests();
        });
        
        // Calcular dire√ß√£o entre duas posi√ß√µes
        function calculateHeading(from, to) {
            const lat1 = from.lat * Math.PI / 180;
            const lon1 = from.lng * Math.PI / 180;
            const lat2 = to.lat * Math.PI / 180;
            const lon2 = to.lng * Math.PI / 180;
            
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                      Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            let brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }
        
        // Parar rastreamento
        document.getElementById("stopTracking").addEventListener("click", function() {
            isTracking = false;
            document.getElementById("startTracking").disabled = false;
            document.getElementById("stopTracking").disabled = true;
            
            showNotification("Rastreamento parado. Voc√™ n√£o est√° mais vis√≠vel para os clientes.");
            
            // Parar watch de posi√ß√£o
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            // Atualizar status no Firebase
            database.ref(`drivers/${currentDriver.driverId}`).update({
                status: 'offline',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        });
        
        // Escutar por solicita√ß√µes de clientes
        function listenForRequests() {
            database.ref('ride_requests').on('child_added', (snapshot) => {
                const request = snapshot.val();
                const requestId = snapshot.key;
                
                console.log('Nova solicita√ß√£o recebida:', request);
                
                // Verificar se √© uma solicita√ß√£o pendente
                if (request.status === 'pending' && request.paymentStatus === 'free') {
                    // Tocar som de notifica√ß√£o
                    playNotificationSound();
                    
                    // Mostrar card de solicita√ß√£o
                    showRequestCard(request, requestId);
                }
            });
        }
        
        // Tocar som de notifica√ß√£o
        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Erro ao tocar som:', e));
        }
        
        // Mostrar card de solicita√ß√£o
        function showRequestCard(request, requestId) {
            const requestCard = document.getElementById('requestCard');
            const requestDetails = document.getElementById('requestDetails');
            const timerElement = document.getElementById('timer');
            const distanceInfo = document.getElementById('distanceInfo');
            
            currentRequestId = requestId;
            currentRequest = request;
            
            // Calcular dist√¢ncia entre motorista e cliente
            calculateDistance(request.origin).then(distance => {
                distanceInfo.innerHTML = `üìç Dist√¢ncia do cliente: <strong>${distance}</strong>`;
            }).catch(error => {
                console.error('Erro ao calcular dist√¢ncia:', error);
                distanceInfo.innerHTML = 'üìç Dist√¢ncia: N√£o dispon√≠vel';
            });
            
            // Preencher detalhes da solicita√ß√£o
            requestDetails.innerHTML = `
                <p><strong>üë§ Cliente:</strong> ${request.name || 'N√£o informado'}</p>
                <p><strong>üìç De:</strong> ${request.origin}</p>
                <p><strong>üéØ Para:</strong> ${request.destination}</p>
                <p><strong>üë• Passageiros:</strong> ${request.passengers || '1'}</p>
                <p><strong>üìû Contato:</strong> ${request.contact || 'N√£o informado'}</p>
                <p><strong>‚è∞ Chegada:</strong> ${request.arrivalTime || '10'} minutos</p>
                <p><strong>üí≥ Pagamento:</strong> ${getPaymentMethodText(request.paymentMethod)}</p>
                ${request.notes ? `<p><strong>üìù Observa√ß√µes:</strong> ${request.notes}</p>` : ''}
            `;
            
            // Mostrar card
            requestCard.style.display = 'block';
            
            // Iniciar contagem regressiva de 120 segundos (2 minutos)
            let timeLeft = 120;
            updateTimerDisplay(timerElement, timeLeft);
            
            countdown = setInterval(() => {
                timeLeft--;
                updateTimerDisplay(timerElement, timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    // Tempo esgotado, rejeitar automaticamente
                    rejectRequest(requestId);
                }
            }, 1000);
            
            // Configurar bot√µes de aceitar e rejeitar
            document.getElementById('acceptRequest').onclick = () => acceptRequest(requestId, request);
            document.getElementById('rejectRequest').onclick = () => rejectRequest(requestId);
        }
        
        // Calcular dist√¢ncia entre motorista e origem do cliente
        function calculateDistance(originAddress) {
            return new Promise((resolve, reject) => {
                const driverLocation = marker.getPosition();
                
                // Converter endere√ßo de origem em coordenadas
                geocoder.geocode({ address: originAddress }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const originLocation = results[0].geometry.location;
                        
                        // Calcular dist√¢ncia em linha reta
                        const distanceInKm = calculateStraightDistance(
                            driverLocation.lat(),
                            driverLocation.lng(),
                            originLocation.lat(),
                            originLocation.lng()
                        );
                        
                        resolve(`${distanceInKm.toFixed(1)} km`);
                    } else {
                        // Se n√£o conseguir geocodificar, tentar calcular rota
                        directionsService.route({
                            origin: driverLocation,
                            destination: originAddress,
                            travelMode: google.maps.TravelMode.DRIVING
                        }, (response, status) => {
                            if (status === 'OK') {
                                const route = response.routes[0];
                                const distanceInMeters = route.legs[0].distance.value;
                                const distanceInKm = (distanceInMeters / 1000).toFixed(1);
                                resolve(`${distanceInKm} km`);
                            } else {
                                reject('N√£o foi poss√≠vel calcular a dist√¢ncia');
                            }
                        });
                    }
                });
            });
        }
        
        // Calcular dist√¢ncia em linha reta (f√≥rmula de Haversine)
        function calculateStraightDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }
        
        // Atualizar display do timer
        function updateTimerDisplay(timerElement, timeLeft) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 30) {
                timerElement.style.color = '#f44336';
                timerElement.style.fontWeight = 'bold';
            } else if (timeLeft <= 60) {
                timerElement.style.color = '#ff9800';
            } else {
                timerElement.style.color = '#4CAF50';
            }
        }
        
        // Mostrar card de reserva
        function showReservationCard() {
            const reservationCard = document.getElementById('reservationCard');
            const reservationDetails = document.getElementById('reservationRequestDetails');
            
            // Preencher detalhes da solicita√ß√£o
            reservationDetails.innerHTML = `
                <p><strong>üë§ Cliente:</strong> ${currentRequest.name || 'N√£o informado'}</p>
                <p><strong>üìç De:</strong> ${currentRequest.origin}</p>
                <p><strong>üéØ Para:</strong> ${currentRequest.destination}</p>
            `;
            
            // Resetar sele√ß√£o
            selectedReservationTime = null;
            document.querySelectorAll('.reservation-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('sendReservation').disabled = true;
            
            // Mostrar card
            reservationCard.style.display = 'block';
        }
        
        // Enviar proposta de reserva
        function sendReservation() {
            if (!selectedReservationTime) {
                showNotification("Selecione um tempo de reserva.", true);
                return;
            }
            
            clearInterval(countdown);
            
            // Obter localiza√ß√£o atual do motorista
            const driverLocation = marker.getPosition();
            
            // Obter nome do local usando geocoding
            geocoder.geocode({ location: driverLocation }, (results, status) => {
                let locationName = "Local pr√≥ximo";
                
                if (status === "OK" && results[0]) {
                    locationName = results[0].formatted_address;
                }
                
                // Enviar notifica√ß√£o para o cliente
                if (currentRequest.clientId) {
                    database.ref(`notifications/clients/${currentRequest.clientId}`).push({
                        type: 'reservation_proposal',
                        message: `‚è∞ O motorista ${currentDriver.name} prop√µe uma reserva de ${selectedReservationTime} minutos.`,
                        driverName: currentDriver.name,
                        driverId: currentDriver.driverId,
                        licensePlate: currentDriver.licensePlate,
                        reservationTime: selectedReservationTime,
                        reservationLocation: {
                            lat: driverLocation.lat(),
                            lng: driverLocation.lng()
                        },
                        reservationLocationName: locationName,
                        requestId: currentRequestId,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    console.log('Notifica√ß√£o de reserva enviada para o cliente:', currentRequest.clientId);
                    
                    // Atualizar status da solicita√ß√£o
                    database.ref(`ride_requests/${currentRequestId}`).update({
                        status: 'reservation_proposed',
                        reservationTime: selectedReservationTime,
                        driverId: currentDriver.driverId,
                        driverName: currentDriver.name,
                        licensePlate: currentDriver.licensePlate,
                        proposedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Esconder cards
                    document.getElementById('reservationCard').style.display = 'none';
                    document.getElementById('requestCard').style.display = 'none';
                    
                    // Mostrar popup de aguardo
                    showReservationResponsePopup('waiting');
                    
                    // Guardar o ID da solicita√ß√£o atual para escutar a resposta
                    currentReservationRequestId = currentRequestId;
                    
                    // Escutar por resposta da reserva
                    listenForReservationResponse();
                    
                    currentRequestId = null;
                    currentRequest = null;
                    
                } else {
                    console.warn('Cliente ID n√£o encontrado na solicita√ß√£o');
                    showNotification("Erro: ID do cliente n√£o encontrado.", true);
                }
            });
        }
        
        // Escutar por notifica√ß√µes de reserva
        function listenForReservationNotifications() {
            database.ref(`notifications/drivers/${currentDriver.driverId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                
                if (notification.type === 'reservation_accepted') {
                    showNotification(notification.message);
                    
                    // Adicionar marcador de reserva no mapa
                    if (notification.reservationLocation) {
                        addReservationMarker(notification.reservationLocation);
                    }
                    
                    // Remover a notifica√ß√£o ap√≥s process√°-la
                    snapshot.ref.remove();
                } else if (notification.type === 'reservation_rejected') {
                    showNotification(notification.message, true);
                    
                    // Remover a notifica√ß√£o ap√≥s process√°-la
                    snapshot.ref.remove();
                }
            });
        }
        
        // Escutar por resposta da reserva
        function listenForReservationResponse() {
            if (!currentReservationRequestId) return;
            
            database.ref(`ride_requests/${currentReservationRequestId}`).on('value', (snapshot) => {
                const request = snapshot.val();
                
                if (request) {
                    if (request.status === 'reservation_accepted') {
                        // Cliente aceitou a reserva
                        showReservationResponsePopup('accepted');
                        
                        // Salvar corrida no hist√≥rico
                        const rideData = {
                            clientName: request.name,
                            origin: request.origin,
                            destination: request.destination,
                            passengers: request.passengers,
                            contact: request.contact,
                            date: new Date().toLocaleString('pt-PT'),
                            timestamp: Date.now(),
                            type: 'reservation',
                            reservationTime: request.reservationTime
                        };
                        
                        saveRideToHistory(rideData);
                        
                        // Parar de escutar por atualiza√ß√µes
                        database.ref(`ride_requests/${currentReservationRequestId}`).off();
                        currentReservationRequestId = null;
                        
                    } else if (request.status === 'reservation_rejected') {
                        // Cliente rejeitou a reserva
                        showReservationResponsePopup('rejected');
                        
                        // Parar de escutar por atualiza√ß√µes
                        database.ref(`ride_requests/${currentReservationRequestId}`).off();
                        currentReservationRequestId = null;
                    }
                }
            });
        }
        
        // Mostrar popup de resposta da reserva
        function showReservationResponsePopup(status) {
            const popup = document.getElementById('reservationResponsePopup');
            const icon = document.getElementById('reservationResponseIcon');
            const title = document.getElementById('reservationResponseTitle');
            const message = document.getElementById('reservationResponseMessage');
            
            switch(status) {
                case 'waiting':
                    icon.textContent = '‚è∞';
                    icon.style.color = '#ff9800';
                    title.textContent = 'Aguardando Resposta';
                    title.className = 'reservation-response-title';
                    message.textContent = 'Sua proposta de reserva foi enviada ao cliente. Aguardando resposta...';
                    break;
                    
                case 'accepted':
                    icon.textContent = '‚úÖ';
                    icon.style.color = '#4CAF50';
                    title.textContent = 'Reserva Aceita!';
                    title.className = 'reservation-response-title reservation-accepted';
                    message.textContent = 'O cliente aceitou sua proposta de reserva! A corrida foi confirmada.';
                    break;
                    
                case 'rejected':
                    icon.textContent = '‚ùå';
                    icon.style.color = '#f44336';
                    title.textContent = 'Reserva Rejeitada';
                    title.className = 'reservation-response-title reservation-rejected';
                    message.textContent = 'O cliente rejeitou sua proposta de reserva.';
                    break;
            }
            
            popup.classList.add('active');
        }
        
        // Fechar popup de resposta da reserva
        function closeReservationResponse() {
            document.getElementById('reservationResponsePopup').classList.remove('active');
        }
        
        // Adicionar marcador de reserva no mapa
        function addReservationMarker(location) {
            // Remover marcador anterior se existir
            if (reservationMarker) {
                reservationMarker.setMap(null);
            }
            
            // Criar novo marcador
            reservationMarker = new google.maps.Marker({
                position: location,
                map: map,
                title: "Local de Encontro com Cliente",
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
                }
            });
            
            // Centralizar mapa no local de encontro
            map.setCenter(location);
        }
        
        // Aceitar solicita√ß√£o
        function acceptRequest(requestId, request) {
            clearInterval(countdown);
            
            // Salvar corrida no hist√≥rico
            const rideData = {
                clientName: request.name,
                origin: request.origin,
                destination: request.destination,
                passengers: request.passengers,
                contact: request.contact,
                date: new Date().toLocaleString('pt-PT'),
                timestamp: Date.now()
            };
            
            saveRideToHistory(rideData);
            
            // Atualizar status da solicita√ß√£o INCLUINDO A MATR√çCULA
            database.ref(`ride_requests/${requestId}`).update({
                status: 'accepted',
                driverId: currentDriver.driverId,
                driverName: currentDriver.name,
                licensePlate: currentDriver.licensePlate, // ‚Üê MATR√çCULA AQUI
                acceptedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Esconder card de solicita√ß√£o
            document.getElementById('requestCard').style.display = 'none';
            
            // Mostrar notifica√ß√£o
            showNotification("‚úÖ Voc√™ aceitou a solicita√ß√£o!");
            
            // Enviar notifica√ß√£o para o cliente INCLUINDO A MATR√çCULA
            if (request.clientId) {
                database.ref(`notifications/clients/${request.clientId}`).push({
                    type: 'request_accepted',
                    message: `üéâ Seu t√°xi foi aceito! Motorista: ${currentDriver.name} est√° a caminho.`,
                    driverName: currentDriver.name,
                    licensePlate: currentDriver.licensePlate, // ‚Üê MATR√çCULA AQUI
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            currentRequestId = null;
            currentRequest = null;
        }
        
        // Rejeitar solicita√ß√£o
        function rejectRequest(requestId) {
            clearInterval(countdown);
            
            // Atualizar status da solicita√ß√£o
            database.ref(`ride_requests/${requestId}`).update({
                status: 'rejected',
                rejectedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Esconder card de solicita√ß√£o
            document.getElementById('requestCard').style.display = 'none';
            
            // Mostrar notifica√ß√£o
            showNotification("‚ùå Voc√™ rejeitou a solicita√ß√£o.");
            
            currentRequestId = null;
            currentRequest = null;
        }
        
        // Obter texto do m√©todo de pagamento
        function getPaymentMethodText(method) {
            switch(method) {
                case 'cash': return 'üíµ Dinheiro';
                case 'card': return 'üí≥ Cart√£o';
                case 'mbway': return 'üì± MBWay';
                default: return method;
            }
        }
        
        // Mostrar notifica√ß√£o
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Permitir login com Enter
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        document.getElementById('regConfirmPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                register();
            }
        });

        // Inicializar sistema de motoristas quando a p√°gina carregar
        window.addEventListener('load', function() {
            initializeDriversStorage();
        });
    </script>
    
    <!-- Google Maps API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmc6HTJo70N_ueR1qFVgyu74v7FIl7dU4&callback=initMap&libraries=places,directions">
    </script>
</body>
</html>
