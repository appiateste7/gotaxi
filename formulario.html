<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="request_taxi">Solicitar T√°xi - GoT√°xi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        header {
            background-color: #000;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo span {
            color: #ffc107;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
        }
        
        nav ul li {
            margin-left: 15px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #333;
        }

        .language-selector {
            background: transparent;
            border: 1px solid #ffc107;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .language-selector option {
            background: #000;
            color: white;
        }
        
        .container {
            max-width: 600px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .form-card {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-card h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        
        .btn:hover {
            background-color: #e0a800;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-call-taxi {
            background-color: #2196F3;
            color: white;
            font-size: 18px;
            padding: 20px;
        }
        
        .notification {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .notification.info {
            background-color: #2196F3;
        }
        
        .status-indicator {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-accepted {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Popup de sucesso */
        .success-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .success-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.7);
            transition: transform 0.3s;
        }

        .success-popup.active .popup-content {
            transform: scale(1);
        }

        .popup-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .popup-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .popup-message {
            font-size: 16px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Go<span>T√°xi</span></div>
        <nav>
            <ul>
                <li><a href="index.html" data-i18n="home">In√≠cio</a></li>
                <li>
                    <select id="languageSelector" class="language-selector" onchange="changeLanguage(this.value)">
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </li>
            </ul>
        </nav>
    </header>
    
    <div class="container">
        <div id="notification" class="notification"></div>
        <div id="statusIndicator" class="status-indicator" style="display: none;"></div>
        
        <div class="form-card">
            <h2 data-i18n="request_taxi_title">üöï Solicitar T√°xi</h2>
            
            <form id="taxiForm">
                <div class="form-group">
                    <label for="name" data-i18n="full_name">Nome Completo</label>
                    <input type="text" id="name" data-i18n-placeholder="enter_full_name" placeholder="Seu nome completo" required>
                </div>
                
                <div class="form-group">
                    <label for="origin" data-i18n="where_are_you">üìç Onde voc√™ est√°?</label>
                    <input type="text" id="origin" data-i18n-placeholder="enter_departure" placeholder="Endere√ßo de partida" required>
                </div>
                
                <div class="form-group">
                    <label for="destination" data-i18n="where_to">üéØ Pra onde vai?</label>
                    <input type="text" id="destination" data-i18n-placeholder="enter_destination" placeholder="Endere√ßo de destino" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="passengers" data-i18n="passengers">üë• Passageiros</label>
                        <select id="passengers" required>
                            <option value="1" data-i18n="passenger_1">1 passageiro</option>
                            <option value="2" data-i18n="passenger_2">2 passageiros</option>
                            <option value="3" data-i18n="passenger_3">3 passageiros</option>
                            <option value="4" selected data-i18n="passenger_4">4 passageiros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact" data-i18n="contact">üìû Contato</label>
                        <input type="tel" id="contact" data-i18n-placeholder="enter_phone" placeholder="Seu telefone" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="arrivalTime" data-i18n="arrival_time">‚è∞ Tempo de chegada</label>
                    <select id="arrivalTime" required>
                        <option value="5" data-i18n="minutes_5">5 minutos</option>
                        <option value="10" selected data-i18n="minutes_10">10 minutos</option>
                        <option value="15" data-i18n="minutes_15">15 minutos</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod" data-i18n="payment_method">üí≥ Forma de pagamento</label>
                    <select id="paymentMethod" required>
                        <option value="cash" data-i18n="cash">Dinheiro</option>
                        <option value="card" data-i18n="card">Cart√£o</option>
                        <option value="mbway" data-i18n="mbway">MBWay</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notes" data-i18n="notes">üìù Observa√ß√£o (opcional)</label>
                    <textarea id="notes" data-i18n-placeholder="special_notes" placeholder="Alguma observa√ß√£o especial..."></textarea>
                </div>
                
                <button type="button" id="callTaxiButton" class="btn btn-call-taxi" data-i18n="call_taxi_button">
                    üöó Chamar T√°xi
                </button>
            </form>
        </div>
    </div>

    <!-- Popup de sucesso -->
    <div id="successPopup" class="success-popup">
        <div class="popup-content">
            <div class="popup-icon">‚úÖ</div>
            <h2 class="popup-title" data-i18n="taxi_confirmed">T√°xi Confirmado!</h2>
            <p class="popup-message" id="popupDriverMessage" data-i18n="taxi_accepted_message">Seu t√°xi foi aceito e est√° a caminho!</p>
            <p class="popup-message" data-i18n="driver_contact">O motorista entrar√° em contato com voc√™ em breve.</p>
            <button onclick="closePopupAndRedirect()" class="btn" style="margin-top: 20px;" data-i18n="back_home">
                üè† Voltar para o In√≠cio
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Sistema de Internacionaliza√ß√£o
        const translations = {
            pt: {
                // Interface
                "request_taxi": "Solicitar T√°xi - GoT√°xi",
                "home": "In√≠cio",
                "request_taxi_title": "üöï Solicitar T√°xi",
                "full_name": "Nome Completo",
                "enter_full_name": "Seu nome completo",
                "where_are_you": "üìç Onde voc√™ est√°?",
                "enter_departure": "Endere√ßo de partida",
                "where_to": "üéØ Pra onde vai?",
                "enter_destination": "Endere√ßo de destino",
                "passengers": "üë• Passageiros",
                "passenger_1": "1 passageiro",
                "passenger_2": "2 passageiros",
                "passenger_3": "3 passageiros",
                "passenger_4": "4 passageiros",
                "contact": "üìû Contato",
                "enter_phone": "Seu telefone",
                "arrival_time": "‚è∞ Tempo de chegada",
                "minutes_5": "5 minutos",
                "minutes_10": "10 minutos",
                "minutes_15": "15 minutos",
                "payment_method": "üí≥ Forma de pagamento",
                "cash": "Dinheiro",
                "card": "Cart√£o",
                "mbway": "MBWay",
                "notes": "üìù Observa√ß√£o (opcional)",
                "special_notes": "Alguma observa√ß√£o especial...",
                "call_taxi_button": "üöó Chamar T√°xi",
                "taxi_confirmed": "T√°xi Confirmado!",
                "taxi_accepted_message": "Seu t√°xi foi aceito e est√° a caminho!",
                "driver_contact": "O motorista entrar√° em contato com voc√™ em breve.",
                "back_home": "üè† Voltar para o In√≠cio",
                
                // Notifica√ß√µes
                "fill_all_fields": "‚ùå Por favor, preencha todos os campos obrigat√≥rios.",
                "sending_request": "‚è≥ Enviando solicita√ß√£o...",
                "request_sent": "üöï Solicita√ß√£o enviada! Aguardando motorista...",
                "request_error": "‚ùå Erro ao enviar solicita√ß√£o. Tente novamente.",
                "address_error": "‚ùå Erro ao processar endere√ßo. Tente novamente.",
                "waiting_driver": "üïí Aguardando resposta do motorista...",
                "request_sent_confirm": "‚úÖ Solicita√ß√£o Enviada",
                "taxi_accepted": "üéâ Seu t√°xi foi aceito! Motorista: ",
                "no_drivers": "‚ùå Nenhum motorista dispon√≠vel. Tente novamente.",
                "reservation_confirmed": "‚úÖ Reserva confirmada para daqui a ",
                "reservation_rejected": "‚ùå Reserva rejeitada."
            },
            en: {
                // Interface
                "request_taxi": "Request Taxi - GoT√°xi",
                "home": "Home",
                "request_taxi_title": "üöï Request Taxi",
                "full_name": "Full Name",
                "enter_full_name": "Your full name",
                "where_are_you": "üìç Where are you?",
                "enter_departure": "Departure address",
                "where_to": "üéØ Where to?",
                "enter_destination": "Destination address",
                "passengers": "üë• Passengers",
                "passenger_1": "1 passenger",
                "passenger_2": "2 passengers",
                "passenger_3": "3 passengers",
                "passenger_4": "4 passengers",
                "contact": "üìû Contact",
                "enter_phone": "Your phone number",
                "arrival_time": "‚è∞ Arrival time",
                "minutes_5": "5 minutes",
                "minutes_10": "10 minutes",
                "minutes_15": "15 minutes",
                "payment_method": "üí≥ Payment Method",
                "cash": "Cash",
                "card": "Card",
                "mbway": "MBWay",
                "notes": "üìù Notes (optional)",
                "special_notes": "Any special notes...",
                "call_taxi_button": "üöó Call Taxi",
                "taxi_confirmed": "Taxi Confirmed!",
                "taxi_accepted_message": "Your taxi has been accepted and is on the way!",
                "driver_contact": "The driver will contact you shortly.",
                "back_home": "üè† Back to Home",
                
                // Notifications
                "fill_all_fields": "‚ùå Please fill all required fields.",
                "sending_request": "‚è≥ Sending request...",
                "request_sent": "üöï Request sent! Waiting for driver...",
                "request_error": "‚ùå Error sending request. Try again.",
                "address_error": "‚ùå Error processing address. Try again.",
                "waiting_driver": "üïí Waiting for driver response...",
                "request_sent_confirm": "‚úÖ Request Sent",
                "taxi_accepted": "üéâ Your taxi was accepted! Driver: ",
                "no_drivers": "‚ùå No drivers available. Try again.",
                "reservation_confirmed": "‚úÖ Reservation confirmed for ",
                "reservation_rejected": "‚ùå Reservation rejected."
            },
            es: {
                // Interface
                "request_taxi": "Solicitar Taxi - GoT√°xi",
                "home": "Inicio",
                "request_taxi_title": "üöï Solicitar Taxi",
                "full_name": "Nombre Completo",
                "enter_full_name": "Tu nombre completo",
                "where_are_you": "üìç ¬øD√≥nde est√°s?",
                "enter_departure": "Direcci√≥n de salida",
                "where_to": "üéØ ¬øA d√≥nde vas?",
                "enter_destination": "Direcci√≥n de destino",
                "passengers": "üë• Pasajeros",
                "passenger_1": "1 pasajero",
                "passenger_2": "2 pasajeros",
                "passenger_3": "3 pasajeros",
                "passenger_4": "4 pasajeros",
                "contact": "üìû Contacto",
                "enter_phone": "Tu tel√©fono",
                "arrival_time": "‚è∞ Tiempo de llegada",
                "minutes_5": "5 minutos",
                "minutes_10": "10 minutos",
                "minutes_15": "15 minutos",
                "payment_method": "üí≥ M√©todo de Pago",
                "cash": "Efectivo",
                "card": "Tarjeta",
                "mbway": "MBWay",
                "notes": "üìù Observaci√≥n (opcional)",
                "special_notes": "Alguna observaci√≥n especial...",
                "call_taxi_button": "üöó Llamar Taxi",
                "taxi_confirmed": "¬°Taxi Confirmado!",
                "taxi_accepted_message": "¬°Tu taxi ha sido aceptado y est√° en camino!",
                "driver_contact": "El conductor se pondr√° en contacto contigo pronto.",
                "back_home": "üè† Volver al Inicio",
                
                // Notifications
                "fill_all_fields": "‚ùå Por favor, complete todos los campos obligatorios.",
                "sending_request": "‚è≥ Enviando solicitud...",
                "request_sent": "üöï ¬°Solicitud enviada! Esperando conductor...",
                "request_error": "‚ùå Error al enviar solicitud. Intente nuevamente.",
                "address_error": "‚ùå Error al procesar direcci√≥n. Intente nuevamente.",
                "waiting_driver": "üïí Esperando respuesta del conductor...",
                "request_sent_confirm": "‚úÖ Solicitud Enviada",
                "taxi_accepted": "üéâ ¬°Tu taxi fue aceptado! Conductor: ",
                "no_drivers": "‚ùå No hay conductores disponibles. Intente nuevamente.",
                "reservation_confirmed": "‚úÖ Reserva confirmada para dentro de ",
                "reservation_rejected": "‚ùå Reserva rechazada."
            },
            fr: {
                // Interface
                "request_taxi": "Demander un Taxi - GoT√°xi",
                "home": "Accueil",
                "request_taxi_title": "üöï Demander un Taxi",
                "full_name": "Nom Complet",
                "enter_full_name": "Votre nom complet",
                "where_are_you": "üìç O√π √™tes-vous?",
                "enter_departure": "Adresse de d√©part",
                "where_to": "üéØ O√π allez-vous?",
                "enter_destination": "Adresse de destination",
                "passengers": "üë• Passagers",
                "passenger_1": "1 passager",
                "passenger_2": "2 passagers",
                "passenger_3": "3 passagers",
                "passenger_4": "4 passagers",
                "contact": "üìû Contact",
                "enter_phone": "Votre num√©ro de t√©l√©phone",
                "arrival_time": "‚è∞ Temps d'arriv√©e",
                "minutes_5": "5 minutes",
                "minutes_10": "10 minutes",
                "minutes_15": "15 minutes",
                "payment_method": "üí≥ Mode de Paiement",
                "cash": "Esp√®ces",
                "card": "Carte",
                "mbway": "MBWay",
                "notes": "üìù Remarque (optionnelle)",
                "special_notes": "Remarque sp√©ciale...",
                "call_taxi_button": "üöó Appeler Taxi",
                "taxi_confirmed": "Taxi Confirm√©!",
                "taxi_accepted_message": "Votre taxi a √©t√© accept√© et est en route!",
                "driver_contact": "Le chauffeur vous contactera sous peu.",
                "back_home": "üè† Retour √† l'Accueil",
                
                // Notifications
                "fill_all_fields": "‚ùå Veuillez remplir tous les champs obligatoires.",
                "sending_request": "‚è≥ Envoi de la demande...",
                "request_sent": "üöï Demande envoy√©e! En attente du chauffeur...",
                "request_error": "‚ùå Erreur lors de l'envoi. R√©essayez.",
                "address_error": "‚ùå Erreur de traitement de l'adresse. R√©essayez.",
                "waiting_driver": "üïí En attente de la r√©ponse du chauffeur...",
                "request_sent_confirm": "‚úÖ Demande Envoy√©e",
                "taxi_accepted": "üéâ Votre taxi a √©t√© accept√©! Chauffeur: ",
                "no_drivers": "‚ùå Aucun chauffeur disponible. R√©essayez.",
                "reservation_confirmed": "‚úÖ R√©servation confirm√©e pour dans ",
                "reservation_rejected": "‚ùå R√©servation rejet√©e."
            }
        };

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAZ4YqmOZz0wUlhBvuSD_fBLcwq1av8yc8",
            authDomain: "gotaxi-4e391.firebaseapp.com",
            databaseURL: "https://gotaxi-4e391-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gotaxi-4e391",
            storageBucket: "gotaxi-4e391.firebasestorage.app",
            messagingSenderId: "597857194128",
            appId: "1:597857194128:web:9b550abd9b5e98bb374815"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Elementos do DOM
        const callTaxiButton = document.getElementById('callTaxiButton');
        const notification = document.getElementById('notification');
        const statusIndicator = document.getElementById('statusIndicator');
        const successPopup = document.getElementById('successPopup');
        const popupDriverMessage = document.getElementById('popupDriverMessage');
        
        let clientId = 'client_' + Math.random().toString(36).substr(2, 9);
        let currentRequestId = null;
        let currentLanguage = 'pt';

        // Fun√ß√£o para mudar idioma
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            localStorage.setItem('preferredLanguage', lang);
        }

        // Fun√ß√£o para atualizar textos
        function updateTexts() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage][key]) {
                    element.setAttribute('placeholder', translations[currentLanguage][key]);
                }
            });

            // Atualizar op√ß√µes do select
            const selects = document.querySelectorAll('select option');
            selects.forEach(option => {
                const key = option.getAttribute('data-i18n');
                if (key && translations[currentLanguage][key]) {
                    option.textContent = translations[currentLanguage][key];
                }
            });
        }

        // Fun√ß√£o para obter tradu√ß√£o
        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        // Carregar idioma salvo
        function loadSavedLanguage() {
            const savedLanguage = localStorage.getItem('preferredLanguage');
            const urlParams = new URLSearchParams(window.location.search);
            const urlLang = urlParams.get('lang');
            
            if (urlLang && translations[urlLang]) {
                currentLanguage = urlLang;
            } else if (savedLanguage && translations[savedLanguage]) {
                currentLanguage = savedLanguage;
            }
            
            document.getElementById('languageSelector').value = currentLanguage;
            updateTexts();
        }

        // Verificar se h√° par√¢metros na URL e preencher os campos
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const origin = urlParams.get('origin');
            const destination = urlParams.get('destination');
            
            if (origin) {
                document.getElementById('origin').value = origin;
            }
            
            if (destination) {
                document.getElementById('destination').value = destination;
            }
        }
        
        // Inicializar autocomplete para os campos de endere√ßo
        function initAutocomplete() {
            if (typeof google !== 'undefined') {
                const originInput = document.getElementById('origin');
                const destinationInput = document.getElementById('destination');
                
                const originAutocomplete = new google.maps.places.Autocomplete(originInput);
                const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput);
            }
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedLanguage();
            checkUrlParams();
            initAutocomplete();
            
            // Escutar por notifica√ß√µes de reserva
            listenForReservationProposals();
        });
        
        // Chamar t√°xi
        callTaxiButton.addEventListener('click', function() {
            // Validar formul√°rio
            if (!validateForm()) {
                showNotification(t("fill_all_fields"), true);
                return;
            }
            
            // Desabilitar bot√£o durante o processamento
            callTaxiButton.disabled = true;
            callTaxiButton.textContent = t("sending_request");
            
            // Coletar dados do formul√°rio
            const formData = getFormData();
            
            // Obter coordenadas do endere√ßo de origem
            getCoordinates(formData.origin).then(originCoords => {
                // Criar solicita√ß√£o no Firebase
                currentRequestId = database.ref('ride_requests').push().key;
                
                const requestData = {
                    ...formData,
                    clientId: clientId,
                    status: 'pending',
                    paymentStatus: 'free',
                    originCoords: originCoords,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                database.ref(`ride_requests/${currentRequestId}`).set(requestData)
                    .then(() => {
                        showNotification(t("request_sent"), false, 'info');
                        updateStatusIndicator('pending', t("waiting_driver"));
                        
                        // Alterar texto do bot√£o
                        callTaxiButton.textContent = t("request_sent_confirm");
                        
                        // Escutar por atualiza√ß√µes na solicita√ß√£o
                        listenForRequestUpdates();
                    })
                    .catch((error) => {
                        console.error('Erro ao enviar solicita√ß√£o:', error);
                        showNotification(t("request_error"), true);
                        
                        // Reabilitar bot√£o
                        callTaxiButton.disabled = false;
                        callTaxiButton.textContent = t("call_taxi_button");
                    });
            }).catch(error => {
                console.error('Erro ao obter coordenadas:', error);
                showNotification(t("address_error"), true);
                callTaxiButton.disabled = false;
                callTaxiButton.textContent = t("call_taxi_button");
            });
        });
        
        // Fun√ß√£o para obter coordenadas do endere√ßo
        function getCoordinates(address) {
            return new Promise((resolve, reject) => {
                if (typeof google === 'undefined') {
                    reject('Google Maps n√£o carregado');
                    return;
                }
                
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: address }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({
                            lat: location.lat(),
                            lng: location.lng()
                        });
                    } else {
                        reject('Endere√ßo n√£o encontrado: ' + status);
                    }
                });
            });
        }
        
        // Escutar por atualiza√ß√µes na solicita√ß√£o
        function listenForRequestUpdates() {
            if (!currentRequestId) return;
            
            database.ref(`ride_requests/${currentRequestId}`).on('value', (snapshot) => {
                const request = snapshot.val();
                
                if (request) {
                    if (request.status === 'accepted') {
                        updateStatusIndicator('accepted', `‚úÖ ${t("taxi_accepted")} ${request.driverName || t('driver')}!`);
                        showNotification(`${t("taxi_accepted")} ${request.driverName || t('driver')}`, false, 'info');
                        
                        // Mostrar popup de sucesso
                        showSuccessPopup(request.driverName);
                        
                    } else if (request.status === 'rejected') {
                        updateStatusIndicator('rejected', t("no_drivers"));
                        showNotification(t("no_drivers"), true);
                        
                        // Reabilitar o formul√°rio para nova tentativa
                        resetFormForNewRequest();
                    }
                }
            });
        }
        
        // Escutar por propostas de reserva
        function listenForReservationProposals() {
            database.ref(`notifications/clients/${clientId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                
                if (notification.type === 'reservation_proposal') {
                    // Mostrar confirma√ß√£o de reserva
                    showReservationConfirmation(notification);
                    
                    // Remover a notifica√ß√£o ap√≥s processar
                    snapshot.ref.remove();
                }
            });
        }
        
        // Mostrar confirma√ß√£o de reserva
        function showReservationConfirmation(notification) {
            const userResponse = confirm(
                `üìÖ ${notification.message}\n\n` +
                `${t('reservation_details')}:\n` +
                `‚Ä¢ ${t('driver')}: ${notification.driverName}\n` +
                `‚Ä¢ ${t('wait_time')}: ${notification.reservationTime} ${t('minutes')}\n\n` +
                `${t('click_accept_reject')}`
            );
            
            if (userResponse) {
                // Cliente aceitou a reserva
                acceptReservation(notification);
            } else {
                // Cliente rejeitou a reserva
                rejectReservation(notification);
            }
        }
        
        // Aceitar reserva
        function acceptReservation(notification) {
            // Enviar notifica√ß√£o de aceita√ß√£o para o motorista
            database.ref(`notifications/drivers/${notification.driverId}`).push({
                type: 'reservation_accepted',
                message: `‚úÖ ${t('client_accepted_reservation')} ${notification.reservationTime} ${t('minutes')}!`,
                reservationTime: notification.reservationTime,
                requestId: notification.requestId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                showNotification(`${t("reservation_confirmed")} ${notification.reservationTime} ${t('minutes')}!`, false, 'info');
                
                // Atualizar status da solicita√ß√£o
                database.ref(`ride_requests/${notification.requestId}`).update({
                    status: 'reservation_accepted',
                    driverId: notification.driverId,
                    driverName: notification.driverName,
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Mostrar popup de sucesso
                showReservationSuccessPopup(notification.driverName, notification.reservationTime);
                
            }).catch((error) => {
                console.error('Erro ao aceitar reserva:', error);
                showNotification(t("request_error"), true);
            });
        }
        
        // Rejeitar reserva
        function rejectReservation(notification) {
            // Enviar notifica√ß√£o de rejei√ß√£o para o motorista
            database.ref(`notifications/drivers/${notification.driverId}`).push({
                type: 'reservation_rejected',
                message: `‚ùå ${t('client_rejected_reservation')}`,
                requestId: notification.requestId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                showNotification(t("reservation_rejected"), true);
                
                // Atualizar status da solicita√ß√£o
                database.ref(`ride_requests/${notification.requestId}`).update({
                    status: 'reservation_rejected'
                });
                
            }).catch((error) => {
                console.error('Erro ao rejeitar reserva:', error);
                showNotification(t("request_error"), true);
            });
        }
        
        // Mostrar popup de sucesso
        function showSuccessPopup(driverName) {
            // Atualizar mensagem do popup
            popupDriverMessage.textContent = `${t("taxi_accepted_message")} ${driverName || t('driver')}!`;
            
            // Mostrar popup
            successPopup.classList.add('active');
        }
        
        // Mostrar popup de sucesso para reserva
        function showReservationSuccessPopup(driverName, reservationTime) {
            const popupContent = document.querySelector('.popup-content');
            popupContent.innerHTML = `
                <div class="popup-icon">üìÖ</div>
                <h2 class="popup-title">${t('reservation_confirmed_title')}</h2>
                <p class="popup-message">${t('reservation_with')} ${driverName} ${t('confirmed_for')} ${reservationTime} ${t('minutes')}!</p>
                <p class="popup-message">${t('driver_contact')}</p>
                <button onclick="closePopupAndRedirect()" class="btn" style="margin-top: 20px;">
                    ${t('back_home')}
                </button>
            `;
            
            // Mostrar popup
            successPopup.classList.add('active');
        }
        
        // Fechar popup e redirecionar
        function closePopupAndRedirect() {
            successPopup.classList.remove('active');
            // Redirecionar para a p√°gina inicial
            window.location.href = 'index.html';
        }
        
        // Reconfigurar formul√°rio para nova tentativa
        function resetFormForNewRequest() {
            // Reabilitar bot√£o de chamar t√°xi
            callTaxiButton.disabled = false;
            callTaxiButton.textContent = t("call_taxi_button");
            
            // Limpar request ID atual
            currentRequestId = null;
        }
        
        // Validar formul√°rio
        function validateForm() {
            const requiredFields = ['name', 'origin', 'destination', 'contact'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            
            return true;
        }
        
        // Coletar dados do formul√°rio
        function getFormData() {
            return {
                name: document.getElementById('name').value,
                origin: document.getElementById('origin').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                contact: document.getElementById('contact').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toLocaleString('pt-PT', { timeZone: 'Europe/Lisbon' })
            };
        }
        
        // Atualizar indicador de status
        function updateStatusIndicator(status, message) {
            statusIndicator.textContent = message;
            statusIndicator.className = `status-indicator status-${status}`;
            statusIndicator.style.display = 'block';
        }
        
        // Mostrar notifica√ß√£o
        function showNotification(message, isError = false, type = '') {
            notification.textContent = message;
            
            if (type === 'info') {
                notification.className = 'notification info';
            } else {
                notification.className = isError ? 'notification error' : 'notification';
            }
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Adicionar tradu√ß√µes faltantes
        Object.assign(translations.pt, {
            'reservation_details': 'Detalhes da reserva',
            'wait_time': 'Tempo de espera',
            'minutes': 'minutos',
            'click_accept_reject': 'Clique em "OK" para aceitar ou "Cancelar" para rejeitar.',
            'client_accepted_reservation': 'Cliente aceitou sua proposta de reserva de',
            'client_rejected_reservation': 'Cliente rejeitou sua proposta de reserva.',
            'reservation_confirmed_title': 'Reserva Confirmada!',
            'reservation_with': 'Sua reserva com',
            'confirmed_for': 'foi confirmada para daqui a'
        });

        Object.assign(translations.en, {
            'reservation_details': 'Reservation details',
            'wait_time': 'Wait time',
            'minutes': 'minutes',
            'click_accept_reject': 'Click "OK" to accept or "Cancel" to reject.',
            'client_accepted_reservation': 'Client accepted your reservation proposal of',
            'client_rejected_reservation': 'Client rejected your reservation proposal.',
            'reservation_confirmed_title': 'Reservation Confirmed!',
            'reservation_with': 'Your reservation with',
            'confirmed_for': 'was confirmed for'
        });

        Object.assign(translations.es, {
            'reservation_details': 'Detalles de la reserva',
            'wait_time': 'Tiempo de espera',
            'minutes': 'minutos',
            'click_accept_reject': 'Haga clic en "Aceptar" para aceptar o "Cancelar" para rechazar.',
            'client_accepted_reservation': 'Cliente acept√≥ su propuesta de reserva de',
            'client_rejected_reservation': 'Cliente rechaz√≥ su propuesta de reserva.',
            'reservation_confirmed_title': '¬°Reserva Confirmada!',
            'reservation_with': 'Su reserva con',
            'confirmed_for': 'fue confirmada para dentro de'
        });

        Object.assign(translations.fr, {
            'reservation_details': 'D√©tails de la r√©servation',
            'wait_time': 'Temps d\'attente',
            'minutes': 'minutes',
            'click_accept_reject': 'Cliquez sur "OK" pour accepter ou "Annuler" pour rejeter.',
            'client_accepted_reservation': 'Le client a accept√© votre proposition de r√©servation de',
            'client_rejected_reservation': 'Le client a rejet√© votre proposition de r√©servation.',
            'reservation_confirmed_title': 'R√©servation Confirm√©e!',
            'reservation_with': 'Votre r√©servation avec',
            'confirmed_for': 'a √©t√© confirm√©e pour dans'
        });
    </script>
    
    <!-- Google Maps API com biblioteca de geometria -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmc6HTJo70N_ueR1qFVgyu74v7FIl7dU4&libraries=places,geometry&callback=initAutocomplete">
    </script>
</body>
</html>
