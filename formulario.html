<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title data-i18n="app_title">GoT√°xi - Solicitar T√°xi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        
        header {
            background-color: #000;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo span {
            color: #ffc107;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
        }
        
        nav ul li {
            margin-left: 15px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #333;
        }

        .language-selector {
            background: transparent;
            border: 1px solid #ffc107;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .language-selector option {
            background: #000;
            color: white;
        }
        
        .container {
            max-width: 600px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .form-card {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffc107;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .submit-btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            background-color: #e0a800;
        }
        
        .submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.7);
            transition: transform 0.3s;
        }
        
        .loading-overlay.active .loading-content {
            transform: scale(1);
        }
        
        .loading-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ffc107;
        }
        
        .loading-message {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }
        
        .loading-details {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            line-height: 1.5;
        }
        
        .loading-details.error {
            color: #f44336;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ffc107;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-btn {
            display: inline-block;
            background-color: #f5f5f5;
            color: #333;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        
        .back-btn:hover {
            background-color: #e0e0e0;
        }
        
        .payment-methods {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .payment-method {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method:hover {
            border-color: #ffc107;
            background-color: #fff9e6;
        }
        
        .payment-method.selected {
            border-color: #ffc107;
            background-color: #ffc107;
            color: #000;
            font-weight: bold;
        }
        
        .payment-method i {
            font-size: 24px;
            margin-bottom: 5px;
            display: block;
        }
        
        .info-card {
            background-color: #e8f5e9;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .info-card h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-card p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }
        
        .driver-distance {
            font-weight: bold;
            color: #ff9800;
        }
        
        .success-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .success-popup.active {
            opacity: 1;
            visibility: visible;
        }
        
        .success-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.7);
            transition: transform 0.3s;
        }
        
        .success-popup.active .success-content {
            transform: scale(1);
        }
        
        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #4CAF50;
        }
        
        .success-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #4CAF50;
        }
        
        .success-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .driver-details {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: left;
        }
        
        .driver-details h4 {
            margin-bottom: 10px;
            color: #2e7d32;
        }
        
        .driver-details p {
            margin: 5px 0;
        }
        
        .license-plate {
            display: inline-block;
            background-color: #ffc107;
            color: #000;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-family: monospace;
            margin-top: 5px;
        }
        
        .reservation-proposal {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
        }
        
        .reservation-proposal h4 {
            color: #856404;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .reservation-driver-info {
            background-color: #e8f5e9;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        
        .reservation-driver-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .reservation-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-accept {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }
        
        .btn-reject {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }
        
        .nearest-driver-info {
            background-color: #e8f5e9;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .nearest-driver-info h3 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .driver-distance {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .loading-message {
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }

        .loading-message.error {
            color: #f44336;
        }

        .loading-message.success {
            color: #4CAF50;
        }

        .driver-distance-info {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .distance-value {
            font-weight: bold;
            color: #2196F3;
        }
        
        .reservation-response-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10002;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .reservation-response-popup.active {
            opacity: 1;
            visibility: visible;
        }
        
        .reservation-response-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .reservation-response-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .reservation-response-title {
            font-size: 24px;
            margin-bottom: 15px;
        }
        
        .reservation-response-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .reservation-response-success {
            color: #4CAF50;
        }
        
        .reservation-response-error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Go<span>T√°xi</span></div>
        <nav>
            <ul>
                <li><a href="index.html" data-i18n="home">In√≠cio</a></li>
                <li>
                    <select id="languageSelector" class="language-selector" onchange="changeLanguage(this.value)">
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </li>
            </ul>
        </nav>
    </header>
    
    <div class="container">
        <a href="index.html" class="back-btn" data-i18n="back">‚Üê Voltar</a>
        
        <div id="nearestDriverInfo" class="nearest-driver-info">
            <h3>üöó Motorista Mais Pr√≥ximo Encontrado!</h3>
            <p>Seu pedido ser√° enviado diretamente para o motorista mais pr√≥ximo da sua localiza√ß√£o.</p>
            <p class="driver-distance" id="driverDistance">Dist√¢ncia: calculando...</p>
        </div>
        
        <div class="form-card">
            <h1 class="form-title" data-i18n="request_taxi">Solicitar T√°xi</h1>
            
            <form id="taxiForm" onsubmit="event.preventDefault(); submitRequest();">
                <div class="form-group">
                    <label for="name" data-i18n="full_name">Nome Completo</label>
                    <input type="text" id="name" data-i18n-placeholder="enter_full_name" placeholder="Digite seu nome completo" required>
                </div>
                
                <div class="form-group">
                    <label for="origin" data-i18n="where_are_you">Onde est√°?</label>
                    <input type="text" id="origin" data-i18n-placeholder="enter_current_location" placeholder="Digite sua localiza√ß√£o atual" required>
                </div>
                
                <div class="form-group">
                    <label for="destination" data-i18n="where_to">Pra onde vai?</label>
                    <input type="text" id="destination" data-i18n-placeholder="enter_destination" placeholder="Digite seu destino" required>
                </div>
                
                <div class="form-group">
                    <label for="passengers" data-i18n="passengers">Passageiros</label>
                    <select id="passengers" required>
                        <option value="1" data-i18n="passenger_1">1 passageiro</option>
                        <option value="2">2 passageiros</option>
                        <option value="3">3 passageiros</option>
                        <option value="4">4 passageiros</option>
                        <option value="5">5 passageiros</option>
                        <option value="6">6 passageiros</option>
                        <option value="7">7 passageiros</option>
                        <option value="8">8 passageiros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="contact" data-i18n="contact">Contato</label>
                    <input type="tel" id="contact" data-i18n-placeholder="enter_phone" placeholder="Digite seu telefone" required>
                </div>
                
                <div class="form-group">
                    <label for="arrivalTime" data-i18n="arrival_time">Tempo de Chegada</label>
                    <select id="arrivalTime" required>
                        <option value="10">10 minutos</option>
                        <option value="15" selected>15 minutos</option>
                        <option value="20">20 minutos</option>
                        <option value="30">30 minutos</option>
                        <option value="40">40 minutos</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label data-i18n="payment_method">M√©todo de Pagamento</label>
                    <div class="payment-methods">
                        <div class="payment-method" data-value="cash" onclick="selectPaymentMethod('cash')">
                            <div>üíµ</div>
                            <span data-i18n="cash">Dinheiro</span>
                        </div>
                        <div class="payment-method" data-value="card" onclick="selectPaymentMethod('card')">
                            <div>üí≥</div>
                            <span data-i18n="card">Cart√£o</span>
                        </div>
                        <div class="payment-method" data-value="mbway" onclick="selectPaymentMethod('mbway')">
                            <div>üì±</div>
                            <span data-i18n="mbway">MBWay</span>
                        </div>
                    </div>
                    <input type="hidden" id="paymentMethod" value="cash" required>
                </div>
                
                <div class="form-group">
                    <label for="notes" data-i18n="notes">Observa√ß√µes</label>
                    <textarea id="notes" data-i18n-placeholder="additional_notes" placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                </div>
                
                <button type="submit" class="submit-btn" data-i18n="submit_request">Enviar Solicita√ß√£o</button>
            </form>
        </div>
    </div>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-message" id="loadingMessage" data-i18n="searching_drivers">Buscando motoristas...</div>
            <div class="loading-details" id="loadingDetails"></div>
        </div>
    </div>
    
    <div id="successPopup" class="success-popup">
        <div class="success-content">
            <div class="success-icon">‚úÖ</div>
            <h2 class="success-title" data-i18n="taxi_confirmed">T√°xi Confirmado!</h2>
            <div class="driver-details" id="driverDetailsPopup">
            </div>
            <p class="success-message" data-i18n="driver_contact">O motorista entrar√° em contato com voc√™ em breve.</p>
            <button onclick="goToHome()" class="submit-btn" data-i18n="back_home">
                üè† Voltar para o In√≠cio
            </button>
        </div>
    </div>
    
    <div id="reservationPopup" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-icon">‚è∞</div>
            <h2 class="loading-message" data-i18n="reservation_proposal">Proposta de Reserva</h2>
            <div class="reservation-proposal" id="reservationDetails">
            </div>
            <div class="reservation-actions">
                <button id="acceptReservation" class="btn-accept" data-i18n="accept_reservation">Aceitar</button>
                <button id="rejectReservation" class="btn-reject" data-i18n="reject_reservation">Rejeitar</button>
            </div>
        </div>
    </div>
    
    <div id="reservationResponsePopup" class="reservation-response-popup">
        <div class="reservation-response-content">
            <div class="reservation-response-icon" id="reservationResponseIcon">‚è∞</div>
            <h3 class="reservation-response-title" id="reservationResponseTitle">Resposta da Reserva</h3>
            <p class="reservation-response-message" id="reservationResponseMessage">
                Aguardando resposta do cliente...
            </p>
            <button class="btn-accept" onclick="goToHomeAfterReservation()" style="margin-top: 20px; width: 100%;">
                üè† Voltar para o In√≠cio
            </button>
        </div>
    </div>
    
    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        const translations = {
            pt: {
                "app_title": "GoT√°xi - Solicitar T√°xi",
                "home": "In√≠cio",
                "back": "‚Üê Voltar",
                "request_taxi": "Solicitar T√°xi",
                "full_name": "Nome Completo",
                "enter_full_name": "Digite seu nome completo",
                "where_are_you": "Onde est√°?",
                "enter_current_location": "Digite sua localiza√ß√£o atual",
                "where_to": "Pra onde vai?",
                "enter_destination": "Digite seu destino",
                "passengers": "Passageiros",
                "passenger_1": "1 passageiro",
                "contact": "Contato",
                "enter_phone": "Digite seu telefone",
                "arrival_time": "Tempo de Chegada",
                "payment_method": "M√©todo de Pagamento",
                "cash": "Dinheiro",
                "card": "Cart√£o",
                "mbway": "MBWay",
                "notes": "Observa√ß√µes",
                "additional_notes": "Observa√ß√µes adicionais (opcional)",
                "submit_request": "Enviar Solicita√ß√£o",
                "searching_drivers": "Buscando motoristas...",
                "taxi_confirmed": "T√°xi Confirmado!",
                "driver_contact": "O motorista entrar√° em contato com voc√™ em breve.",
                "back_home": "üè† Voltar para o In√≠cio",
                "reservation_proposal": "Proposta de Reserva",
                "accept_reservation": "Aceitar",
                "reject_reservation": "Rejeitar",
                "location_updated": "Localiza√ß√£o atualizada!",
                "location_error": "N√£o foi poss√≠vel obter sua localiza√ß√£o.",
                "fill_all_fields": "Por favor, preencha todos os campos obrigat√≥rios.",
                "select_payment": "Por favor, selecione um m√©todo de pagamento.",
                "request_sent": "Solicita√ß√£o enviada com sucesso!",
                "request_error": "Erro ao enviar solicita√ß√£o. Tente novamente.",
                "driver_accepted": "Motorista aceitou sua corrida!",
                "driver_rejected": "Motorista n√£o dispon√≠vel.",
                "searching_another_driver": "Buscando outro motorista...",
                "no_drivers": "Nenhum motorista dispon√≠vel no momento.",
                "nearest_driver_found": "Motorista encontrado a {distance} km!"
            },
            en: {
                "app_title": "GoT√°xi - Request Taxi",
                "home": "Home",
                "back": "‚Üê Back",
                "request_taxi": "Request Taxi",
                "full_name": "Full Name",
                "enter_full_name": "Enter your full name",
                "where_are_you": "Where are you?",
                "enter_current_location": "Enter your current location",
                "where_to": "Where to?",
                "enter_destination": "Enter your destination",
                "passengers": "Passengers",
                "passenger_1": "1 passenger",
                "contact": "Contact",
                "enter_phone": "Enter your phone number",
                "arrival_time": "Arrival Time",
                "payment_method": "Payment Method",
                "cash": "Cash",
                "card": "Card",
                "mbway": "MBWay",
                "notes": "Notes",
                "additional_notes": "Additional notes (optional)",
                "submit_request": "Submit Request",
                "searching_drivers": "Searching for drivers...",
                "taxi_confirmed": "Taxi Confirmed!",
                "driver_contact": "The driver will contact you shortly.",
                "back_home": "üè† Back to Home",
                "reservation_proposal": "Reservation Proposal",
                "accept_reservation": "Accept",
                "reject_reservation": "Reject",
                "location_updated": "Location updated!",
                "location_error": "Could not get your location.",
                "fill_all_fields": "Please fill all required fields.",
                "select_payment": "Please select a payment method.",
                "request_sent": "Request sent successfully!",
                "request_error": "Error sending request. Please try again.",
                "driver_accepted": "Driver accepted your ride!",
                "driver_rejected": "Driver not available.",
                "searching_another_driver": "Searching for another driver...",
                "no_drivers": "No drivers available at the moment.",
                "nearest_driver_found": "Driver found {distance} km away!"
            },
            es: {
                "app_title": "GoT√°xi - Solicitar Taxi",
                "home": "Inicio",
                "back": "‚Üê Volver",
                "request_taxi": "Solicitar Taxi",
                "full_name": "Nombre Completo",
                "enter_full_name": "Ingrese su nombre completo",
                "where_are_you": "¬øD√≥nde est√°s?",
                "enter_current_location": "Ingrese su ubicaci√≥n actual",
                "where_to": "¬øA d√≥nde vas?",
                "enter_destination": "Ingrese su destino",
                "passengers": "Pasajeros",
                "passenger_1": "1 pasajero",
                "contact": "Contacto",
                "enter_phone": "Ingrese su n√∫mero de tel√©fono",
                "arrival_time": "Tiempo de Llegada",
                "payment_method": "M√©todo de Pago",
                "cash": "Efectivo",
                "card": "Tarjeta",
                "mbway": "MBWay",
                "notes": "Observaciones",
                "additional_notes": "Observaciones adicionales (opcional)",
                "submit_request": "Enviar Solicitud",
                "searching_drivers": "Buscando conductores...",
                "taxi_confirmed": "¬°Taxi Confirmado!",
                "driver_contact": "El conductor se pondr√° en contacto contigo pronto.",
                "back_home": "üè† Volver al Inicio",
                "reservation_proposal": "Propuesta de Reserva",
                "accept_reservation": "Aceptar",
                "reject_reservation": "Rechazar",
                "location_updated": "¬°Ubicaci√≥n actualizada!",
                "location_error": "No se pudo obtener su ubicaci√≥n.",
                "fill_all_fields": "Por favor, complete todos los campos obligatorios.",
                "select_payment": "Por favor, seleccione un m√©todo de pago.",
                "request_sent": "¬°Solicitud enviada con √©xito!",
                "request_error": "Error al enviar la solicitud. Intente nuevamente.",
                "driver_accepted": "¬°Conductor acept√≥ tu viaje!",
                "driver_rejected": "Conductor no disponible.",
                "searching_another_driver": "Buscando otro conductor...",
                "no_drivers": "No hay conductores disponibles en este momento.",
                "nearest_driver_found": "¬°Conductor encontrado a {distance} km!"
            },
            fr: {
                "app_title": "GoT√°xi - Demander un Taxi",
                "home": "Accueil",
                "back": "‚Üê Retour",
                "request_taxi": "Demander un Taxi",
                "full_name": "Nom Complet",
                "enter_full_name": "Entrez votre nom complet",
                "where_are_you": "O√π √™tes-vous?",
                "enter_current_location": "Entrez votre position actuelle",
                "where_to": "O√π allez-vous?",
                "enter_destination": "Entrez votre destination",
                "passengers": "Passagers",
                "passenger_1": "1 passager",
                "contact": "Contact",
                "enter_phone": "Entrez votre num√©ro de t√©l√©phone",
                "arrival_time": "Temps d'Arriv√©e",
                "payment_method": "M√©thode de Paiement",
                "cash": "Esp√®ces",
                "card": "Carte",
                "mbway": "MBWay",
                "notes": "Remarques",
                "additional_notes": "Remarques suppl√©mentaires (facultatif)",
                "submit_request": "Envoyer la Demande",
                "searching_drivers": "Recherche de chauffeurs...",
                "taxi_confirmed": "Taxi Confirm√©!",
                "driver_contact": "Le chauffeur vous contactera sous peu.",
                "back_home": "üè† Retour √† l'Accueil",
                "reservation_proposal": "Proposition de R√©servation",
                "accept_reservation": "Accepter",
                "reject_reservation": "Rejeter",
                "location_updated": "Position mise √† jour!",
                "location_error": "Impossible d'obtenir votre position.",
                "fill_all_fields": "Veuillez remplir tous les champs obligatoires.",
                "select_payment": "Veuillez s√©lectionner un m√©thode de paiement.",
                "request_sent": "Demande envoy√©e avec succ√®s!",
                "request_error": "Erreur lors de l'envoi de la demande. Veuillez r√©essayer.",
                "driver_accepted": "Chauffeur a accept√© votre course!",
                "driver_rejected": "Chauffeur non disponible.",
                "searching_another_driver": "Recherche d'un autre chauffeur...",
                "no_drivers": "Aucun chauffeur disponible pour le moment.",
                "nearest_driver_found": "Chauffeur trouv√© √† {distance} km!"
            }
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAZ4YqmOZz0wUlhBvuSD_fBLcwq1av8yc8",
            authDomain: "gotaxi-4e391.firebaseapp.com",
            databaseURL: "https://gotaxi-4e391-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gotaxi-4e391",
            storageBucket: "gotaxi-4e391.firebasestorage.app",
            messagingSenderId: "597857194128",
            appId: "1:597857194128:web:9b550abd9b5e98bb374815"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let clientId;
        let userLocation;
        let currentLanguage = 'pt';
        let nearestDriverId = null;
        let currentRequestId = null;

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            localStorage.setItem('preferredLanguage', lang);
        }

        function updateTexts() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage][key]) {
                    element.setAttribute('placeholder', translations[currentLanguage][key]);
                }
            });
        }

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        function loadSavedLanguage() {
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage && translations[savedLanguage]) {
                currentLanguage = savedLanguage;
                document.getElementById('languageSelector').value = savedLanguage;
            }
            updateTexts();
        }

        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`.payment-method[data-value="${method}"]`).classList.add('selected');
            document.getElementById('paymentMethod').value = method;
        }

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function showLoading(message = '') {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            
            if (message) {
                messageEl.textContent = message;
            }
            
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        function showSuccessPopup(driverName, licensePlate) {
            const popup = document.getElementById('successPopup');
            const driverDetails = document.getElementById('driverDetailsPopup');
            
            let driverDetailsHTML = `
                <h4 data-i18n="driver_details">Detalhes do Motorista</h4>
                <p><strong data-i18n="driver_name">Nome do Motorista:</strong> ${driverName}</p>
            `;
            
            if (licensePlate && licensePlate !== 'N√£o informada') {
                driverDetailsHTML += `<p><strong data-i18n="license_plate_display">Matr√≠cula:</strong> <span class="license-plate">${licensePlate}</span></p>`;
            } else {
                driverDetailsHTML += `<p><strong data-i18n="license_plate_display">Matr√≠cula:</strong> N√£o informada</p>`;
            }
            
            driverDetails.innerHTML = driverDetailsHTML;
            updateTexts();
            
            hideLoading();
            popup.classList.add('active');
        }

        function goToHome() {
            window.location.href = 'index.html';
        }

        function goToHomeAfterReservation() {
            document.getElementById('reservationResponsePopup').classList.remove('active');
            window.location.href = 'index.html';
        }

        function showReservationProposal(request) {
            const popup = document.getElementById('reservationPopup');
            const details = document.getElementById('reservationDetails');
            
            details.innerHTML = `
                <h4>‚è∞ Proposta de Reserva</h4>
                <p>O motorista <strong>${request.driverName}</strong> prop√µe uma reserva de <strong>${request.reservationTime} minutos</strong>.</p>
                
                <div class="reservation-driver-info">
                    <h5>Detalhes do Motorista</h5>
                    <p><strong>Nome do Motorista:</strong> ${request.driverName}</p>
                    <p><strong>Matr√≠cula:</strong> <span class="license-plate">${request.licensePlate || 'N√£o informada'}</span></p>
                    ${request.reservationLocationName ? `<p><strong>Local de Encontro:</strong> ${request.reservationLocationName}</p>` : ''}
                </div>
                
                <p>Voc√™ aceita esta proposta?</p>
            `;
            
            document.getElementById('acceptReservation').onclick = () => acceptReservation(request.requestId);
            document.getElementById('rejectReservation').onclick = () => rejectReservation(request.requestId);
            
            popup.classList.add('active');
        }

        function showReservationResponse(message, isSuccess = true) {
            const popup = document.getElementById('reservationResponsePopup');
            const icon = document.getElementById('reservationResponseIcon');
            const title = document.getElementById('reservationResponseTitle');
            const msg = document.getElementById('reservationResponseMessage');
            
            if (isSuccess) {
                icon.textContent = '‚úÖ';
                icon.style.color = '#4CAF50';
                title.textContent = 'Reserva Aceita!';
                title.className = 'reservation-response-title reservation-response-success';
            } else {
                icon.textContent = '‚ùå';
                icon.style.color = '#f44336';
                title.textContent = 'Reserva Rejeitada';
                title.className = 'reservation-response-title reservation-response-error';
            }
            
            msg.textContent = message;
            popup.classList.add('active');
        }

        function submitRequest() {
            const name = document.getElementById('name').value.trim();
            const origin = document.getElementById('origin').value.trim();
            const destination = document.getElementById('destination').value.trim();
            const contact = document.getElementById('contact').value.trim();
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (!name || !origin || !destination || !contact) {
                showNotification(t("fill_all_fields"), true);
                return;
            }
            
            if (!paymentMethod) {
                showNotification(t("select_payment"), true);
                return;
            }
            
            const requestData = {
                name: name,
                origin: origin,
                destination: destination,
                passengers: document.getElementById('passengers').value,
                contact: contact,
                arrivalTime: document.getElementById('arrivalTime').value,
                paymentMethod: paymentMethod,
                paymentStatus: 'free',
                notes: document.getElementById('notes').value,
                clientId: clientId,
                status: 'pending',
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                clientLocation: userLocation
            };
            
            const urlParams = new URLSearchParams(window.location.search);
            nearestDriverId = urlParams.get('nearestDriverId');
            
            showLoading(t("searching_drivers"));
            
            if (nearestDriverId) {
                sendRequestToDriver(requestData, nearestDriverId);
            } else {
                sendRequestToAllDrivers(requestData);
            }
        }

        function sendRequestToDriver(requestData, driverId) {
            const newRequestRef = database.ref('ride_requests').push();
            const requestId = newRequestRef.key;
            
            requestData.requestId = requestId;
            requestData.assignedDriverId = driverId;
            
            newRequestRef.set(requestData)
                .then(() => {
                    database.ref(`notifications/drivers/${driverId}`).push({
                        type: 'new_request',
                        requestId: requestId,
                        clientName: requestData.name,
                        clientLocation: requestData.clientLocation,
                        origin: requestData.origin,
                        destination: requestData.destination,
                        passengers: requestData.passengers,
                        contact: requestData.contact,
                        arrivalTime: requestData.arrivalTime,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    document.getElementById('loadingMessage').textContent = 
                        "‚úÖ Solicita√ß√£o enviada para o motorista mais pr√≥ximo! Aguardando resposta...";
                    
                    listenForDriverResponse(requestId, driverId);
                    
                })
                .catch((error) => {
                    console.error('Erro ao enviar solicita√ß√£o:', error);
                    document.getElementById('loadingMessage').textContent = 
                        "‚ùå Erro ao enviar solicita√ß√£o. Por favor, tente novamente.";
                    document.getElementById('loadingMessage').classList.add('error');
                    
                    setTimeout(() => {
                        hideLoading();
                    }, 3000);
                });
        }

        function listenForDriverResponse(requestId, driverId) {
            currentRequestId = requestId;
            
            database.ref(`ride_requests/${requestId}`).on('value', (snapshot) => {
                const request = snapshot.val();
                
                if (!request) return;
                
                if (request.status === 'accepted') {
                    showSuccessPopup(request.driverName, request.licensePlate);
                    
                    database.ref(`notifications/clients/${clientId}`).push({
                        type: 'request_accepted',
                        message: `üéâ Motorista ${request.driverName} aceitou sua corrida!`,
                        driverName: request.driverName,
                        driverId: request.driverId,
                        licensePlate: request.licensePlate,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    database.ref(`ride_requests/${requestId}`).off();
                    
                } else if (request.status === 'rejected') {
                    handleRequestRejected(requestId, driverId);
                    
                    database.ref(`ride_requests/${requestId}`).off();
                } else if (request.status === 'reservation_proposed') {
                    showReservationProposal(request);
                }
            });
            
            setTimeout(() => {
                database.ref(`ride_requests/${requestId}`).once('value').then((snapshot) => {
                    const request = snapshot.val();
                    if (request && request.status === 'pending') {
                        handleRequestRejected(requestId, driverId);
                    }
                });
            }, 120000);
        }

        function handleRequestRejected(requestId, driverId) {
            database.ref(`ride_requests/${requestId}`).update({
                status: 'rejected_by_driver',
                rejectedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            document.getElementById('loadingMessage').textContent = 
                "‚ùå Motorista n√£o dispon√≠vel. Buscando outro motorista...";
            
            findAnotherDriver(requestId);
        }

        async function findAnotherDriver(requestId) {
            try {
                const requestSnapshot = await database.ref(`ride_requests/${requestId}`).once('value');
                const request = requestSnapshot.val();
                
                if (!request || !request.clientLocation) {
                    fallbackToAllDrivers(requestId, request);
                    return;
                }
                
                const driversSnapshot = await database.ref('drivers').once('value');
                const drivers = driversSnapshot.val();
                let nearestDriver = null;
                let minDistance = Infinity;
                
                for (const driverId in drivers) {
                    const driver = drivers[driverId];
                    
                    if (driver.status === 'online' && driver.location && 
                        driverId !== request.assignedDriverId) {
                        
                        const distance = calculateDistance(
                            request.clientLocation.lat, request.clientLocation.lng,
                            driver.location.lat, driver.location.lng
                        );
                        
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearestDriver = {
                                id: driverId,
                                name: driver.name,
                                licensePlate: driver.licensePlate,
                                location: driver.location,
                                distance: distance
                            };
                        }
                    }
                }
                
                if (nearestDriver) {
                    await database.ref(`ride_requests/${requestId}`).update({
                        status: 'pending',
                        assignedDriverId: nearestDriver.id,
                        previousDriverId: request.assignedDriverId
                    });
                    
                    database.ref(`notifications/drivers/${nearestDriver.id}`).push({
                        type: 'new_request',
                        requestId: requestId,
                        clientName: request.name,
                        clientLocation: request.clientLocation,
                        origin: request.origin,
                        destination: request.destination,
                        passengers: request.passengers,
                        contact: request.contact,
                        arrivalTime: request.arrivalTime,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        note: 'Corrida recusada por outro motorista, voc√™ √© o mais pr√≥ximo agora!'
                    });
                    
                    document.getElementById('loadingMessage').textContent = 
                        "üîÑ Enviando para outro motorista pr√≥ximo...";
                    
                    listenForDriverResponse(requestId, nearestDriver.id);
                    
                } else {
                    fallbackToAllDrivers(requestId, request);
                }
                
            } catch (error) {
                console.error('Erro ao buscar outro motorista:', error);
                fallbackToAllDrivers(requestId, null);
            }
        }

        function fallbackToAllDrivers(requestId, requestData) {
            database.ref(`ride_requests/${requestId}`).update({
                status: 'pending',
                assignedDriverId: null
            });
            
            database.ref('notifications/drivers').push({
                type: 'new_request_all',
                requestId: requestId,
                clientName: requestData?.name,
                origin: requestData?.origin,
                destination: requestData?.destination,
                passengers: requestData?.passengers,
                contact: requestData?.contact,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                note: 'Nenhum motorista pr√≥ximo dispon√≠vel, enviando para todos.'
            });
            
            document.getElementById('loadingMessage').textContent = 
                "üîç Buscando motoristas dispon√≠veis...";
        }

        function sendRequestToAllDrivers(requestData) {
            const newRequestRef = database.ref('ride_requests').push();
            const requestId = newRequestRef.key;
            
            requestData.requestId = requestId;
            
            newRequestRef.set(requestData)
                .then(() => {
                    database.ref('notifications/drivers').push({
                        type: 'new_request_all',
                        requestId: requestId,
                        clientName: requestData.name,
                        origin: requestData.origin,
                        destination: requestData.destination,
                        passengers: requestData.passengers,
                        contact: requestData.contact,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    document.getElementById('loadingMessage').textContent = 
                        "üîç Buscando motoristas dispon√≠veis...";
                    
                    listenForAnyDriverResponse(requestId);
                    
                })
                .catch((error) => {
                    console.error('Erro ao enviar solicita√ß√£o:', error);
                    document.getElementById('loadingMessage').textContent = 
                        "‚ùå Erro ao enviar solicita√ß√£o. Por favor, tente novamente.";
                    document.getElementById('loadingMessage').classList.add('error');
                    
                    setTimeout(() => {
                        hideLoading();
                    }, 3000);
                });
        }

        function listenForAnyDriverResponse(requestId) {
            database.ref(`ride_requests/${requestId}`).on('value', (snapshot) => {
                const request = snapshot.val();
                
                if (!request) return;
                
                if (request.status === 'accepted') {
                    showSuccessPopup(request.driverName, request.licensePlate);
                    database.ref(`ride_requests/${requestId}`).off();
                } else if (request.status === 'reservation_proposed') {
                    showReservationProposal(request);
                }
            });
        }

        function acceptReservation(requestId) {
            database.ref(`ride_requests/${requestId}`).update({
                status: 'reservation_accepted',
                acceptedAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('reservationPopup').classList.remove('active');
                showReservationResponse('‚úÖ Reserva aceita! O motorista ser√° notificado.', true);
            });
        }

        function rejectReservation(requestId) {
            database.ref(`ride_requests/${requestId}`).update({
                status: 'reservation_rejected',
                rejectedAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                document.getElementById('reservationPopup').classList.remove('active');
                showReservationResponse('‚ùå Reserva rejeitada. Buscando outro motorista...', false);
                findAnotherDriver(requestId);
            });
        }

        function showNearestDriverInfo() {
            const urlParams = new URLSearchParams(window.location.search);
            const nearestDriverId = urlParams.get('nearestDriverId');
            const distance = urlParams.get('distance');
            
            if (nearestDriverId) {
                document.getElementById('nearestDriverInfo').style.display = 'block';
                
                if (distance) {
                    document.getElementById('driverDistance').textContent = 
                        `Dist√¢ncia aproximada: ${distance} km`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            clientId = 'client_' + Math.random().toString(36).substr(2, 9);
            
            loadSavedLanguage();
            
            selectPaymentMethod('cash');
            
            const urlParams = new URLSearchParams(window.location.search);
            const origin = urlParams.get('origin');
            const destination = urlParams.get('destination');
            
            if (origin) {
                document.getElementById('origin').value = origin;
            }
            
            if (destination) {
                document.getElementById('destination').value = destination;
            }
            
            showNearestDriverInfo();
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                    },
                    (error) => {
                        console.log('N√£o foi poss√≠vel obter localiza√ß√£o:', error);
                    }
                );
            }
            
            listenForNotifications();
        });

        function listenForNotifications() {
            database.ref(`notifications/clients/${clientId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                
                if (notification.type === 'request_accepted' && currentRequestId) {
                    database.ref(`ride_requests/${currentRequestId}`).once('value').then((snapshot) => {
                        const request = snapshot.val();
                        if (request && request.status === 'accepted') {
                            showSuccessPopup(request.driverName, request.licensePlate);
                        }
                    });
                    
                    snapshot.ref.remove();
                }
                
                if (notification.type === 'reservation_proposal') {
                    database.ref(`ride_requests/${notification.requestId}`).once('value').then((snapshot) => {
                        const request = snapshot.val();
                        if (request) {
                            showReservationProposal(request);
                        }
                    });
                    
                    snapshot.ref.remove();
                }
            });
        }
    </script>
</body>
</html>