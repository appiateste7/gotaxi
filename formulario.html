<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio - GoT√°xi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        header {
            background-color: #000;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo span {
            color: #ffc107;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 20px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #333;
        }
        
        .container {
            max-width: 600px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        .form-card {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-card h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        
        .btn:hover {
            background-color: #e0a800;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .btn-call-taxi {
            background-color: #2196F3;
            color: white;
            font-size: 18px;
            padding: 20px;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
            display: none;
        }
        
        .notification {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .notification.info {
            background-color: #2196F3;
        }
        
        .status-indicator {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-accepted {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status-rejected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Popup de sucesso */
        .success-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .success-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .popup-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0.7);
            transition: transform 0.3s;
        }

        .success-popup.active .popup-content {
            transform: scale(1);
        }

        .popup-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .popup-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .popup-message {
            font-size: 16px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .countdown {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Go<span>T√°xi</span></div>
        <nav>
            <ul>
                <li><a href="index.html">In√≠cio</a></li>
                <li><a href="motorista.html">√Årea do Motorista</a></li>
            </ul>
        </nav>
    </header>
    
    <div class="container">
        <div id="notification" class="notification"></div>
        <div id="statusIndicator" class="status-indicator" style="display: none;"></div>
        
        <div class="form-card">
            <h2>üöï Solicitar T√°xi</h2>
            
            <form id="taxiForm">
                <div class="form-group">
                    <label for="name">Nome Completo</label>
                    <input type="text" id="name" placeholder="Seu nome completo" required>
                </div>
                
                <div class="form-group">
                    <label for="origin">üìç Onde voc√™ est√°?</label>
                    <input type="text" id="origin" placeholder="Endere√ßo de partida" required>
                </div>
                
                <div class="form-group">
                    <label for="destination">üéØ Pra onde vai?</label>
                    <input type="text" id="destination" placeholder="Endere√ßo de destino" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="passengers">üë• Passageiros</label>
                        <select id="passengers" required>
                            <option value="1">1 passageiro</option>
                            <option value="2">2 passageiros</option>
                            <option value="3">3 passageiros</option>
                            <option value="4" selected>4 passageiros</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contact">üìû Contato</label>
                        <input type="tel" id="contact" placeholder="Seu telefone" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="arrivalTime">‚è∞ Tempo de chegada</label>
                    <select id="arrivalTime" required>
                        <option value="5">5 minutos</option>
                        <option value="10" selected>10 minutos</option>
                        <option value="15">15 minutos</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">üí≥ Forma de pagamento</label>
                    <select id="paymentMethod" required>
                        <option value="cash">Dinheiro</option>
                        <option value="card">Cart√£o</option>
                        <option value="mbway">MBWay</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notes">üìù Observa√ß√£o (opcional)</label>
                    <textarea id="notes" placeholder="Alguma observa√ß√£o especial..."></textarea>
                </div>
                
                <button type="button" id="callTaxiButton" class="btn btn-call-taxi">
                    üöó Chamar T√°xi
                </button>
                
                <button type="button" id="whatsappButton" class="btn btn-whatsapp" disabled>
                    üì± Enviar Via WhatsApp
                </button>
            </form>
        </div>
    </div>

    <!-- Popup de sucesso -->
    <div id="successPopup" class="success-popup">
        <div class="popup-content">
            <div class="popup-icon">‚úÖ</div>
            <h2 class="popup-title">T√°xi Confirmado!</h2>
            <p class="popup-message" id="popupDriverMessage">Seu t√°xi foi aceito e est√° a caminho!</p>
            <p class="popup-message">Voc√™ ser√° redirecionado para a p√°gina inicial em <span id="countdown">3</span> segundos...</p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAZ4YqmOZz0wUlhBvuSD_fBLcwq1av8yc8",
            authDomain: "gotaxi-4e391.firebaseapp.com",
            databaseURL: "https://gotaxi-4e391-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gotaxi-4e391",
            storageBucket: "gotaxi-4e391.firebasestorage.app",
            messagingSenderId: "597857194128",
            appId: "1:597857194128:web:9b550abd9b5e98bb374815"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Elementos do DOM
        const callTaxiButton = document.getElementById('callTaxiButton');
        const whatsappButton = document.getElementById('whatsappButton');
        const notification = document.getElementById('notification');
        const statusIndicator = document.getElementById('statusIndicator');
        const successPopup = document.getElementById('successPopup');
        const popupDriverMessage = document.getElementById('popupDriverMessage');
        const countdownElement = document.getElementById('countdown');
        
        // N√∫meros dos motoristas
        const driverNumbers = {
            'marcelo': '351939057350',
            'heitor': '351910603136', 
            'suzane': '351967903210',
            'mega': '351939354112' // N√∫mero padr√£o
        };
        
        let clientId = 'client_' + Math.random().toString(36).substr(2, 9);
        let currentRequestId = null;
        let redirectCountdown = null;
        
        // Verificar se h√° par√¢metros na URL e preencher os campos
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const origin = urlParams.get('origin');
            const destination = urlParams.get('destination');
            
            if (origin) {
                document.getElementById('origin').value = origin;
            }
            
            if (destination) {
                document.getElementById('destination').value = destination;
            }
        }
        
        // Inicializar autocomplete para os campos de endere√ßo
        function initAutocomplete() {
            if (typeof google !== 'undefined') {
                const originInput = document.getElementById('origin');
                const destinationInput = document.getElementById('destination');
                
                const originAutocomplete = new google.maps.places.Autocomplete(originInput);
                const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput);
            }
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            checkUrlParams();
            initAutocomplete();
        });
        
        // Chamar t√°xi
        callTaxiButton.addEventListener('click', function() {
            // Validar formul√°rio
            if (!validateForm()) {
                showNotification("‚ùå Por favor, preencha todos os campos obrigat√≥rios.", true);
                return;
            }
            
            // Desabilitar bot√£o durante o processamento
            callTaxiButton.disabled = true;
            callTaxiButton.textContent = "‚è≥ Enviando solicita√ß√£o...";
            
            // Coletar dados do formul√°rio
            const formData = getFormData();
            
            // Criar solicita√ß√£o no Firebase
            currentRequestId = database.ref('ride_requests').push().key;
            
            const requestData = {
                ...formData,
                clientId: clientId,
                status: 'pending',
                paymentStatus: 'free',
                createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            database.ref(`ride_requests/${currentRequestId}`).set(requestData)
                .then(() => {
                    showNotification("üöï Solicita√ß√£o enviada! Aguardando motorista...", false, 'info');
                    updateStatusIndicator('pending', 'üïí Aguardando resposta do motorista...');
                    
                    // Habilitar bot√£o do WhatsApp
                    whatsappButton.disabled = false;
                    whatsappButton.style.display = 'block';
                    
                    // Alterar texto do bot√£o
                    callTaxiButton.textContent = "‚úÖ Solicita√ß√£o Enviada";
                    
                    // Escutar por atualiza√ß√µes na solicita√ß√£o
                    listenForRequestUpdates();
                })
                .catch((error) => {
                    console.error('Erro ao enviar solicita√ß√£o:', error);
                    showNotification("‚ùå Erro ao enviar solicita√ß√£o. Tente novamente.", true);
                    
                    // Reabilitar bot√£o
                    callTaxiButton.disabled = false;
                    callTaxiButton.textContent = "üöó Chamar T√°xi";
                });
        });
        
        // Escutar por atualiza√ß√µes na solicita√ß√£o
        function listenForRequestUpdates() {
            if (!currentRequestId) return;
            
            database.ref(`ride_requests/${currentRequestId}`).on('value', (snapshot) => {
                const request = snapshot.val();
                
                if (request) {
                    if (request.status === 'accepted') {
                        updateStatusIndicator('accepted', `‚úÖ T√°xi aceito por ${request.driverName || 'motorista'}!`);
                        showNotification(`üéâ Seu t√°xi foi aceito! Motorista: ${request.driverName || 'N√£o informado'}`, false, 'info');
                        
                        // Enviar mensagem WhatsApp para o motorista
                        sendWhatsAppToDriver(request.driverId, request);
                        
                        // Mostrar popup de sucesso e redirecionar
                        showSuccessPopup(request.driverName);
                        
                    } else if (request.status === 'rejected') {
                        updateStatusIndicator('rejected', '‚ùå Nenhum motorista dispon√≠vel no momento.');
                        showNotification("‚ùå Nenhum motorista dispon√≠vel. Tente novamente.", true);
                        
                        // Reabilitar o formul√°rio para nova tentativa
                        resetFormForNewRequest();
                    }
                }
            });
        }
        
        // Enviar mensagem WhatsApp para o motorista
        function sendWhatsAppToDriver(driverId, requestData) {
            // Obter n√∫mero do motorista baseado no ID
            const driverNumber = driverNumbers[driverId] || driverNumbers['mega'];
            
            // Formatar mensagem para o motorista
            const message = formatDriverMessage(requestData);
            
            // Codificar mensagem para URL
            const encodedMessage = encodeURIComponent(message);
            
            // Criar URL do WhatsApp
            const whatsappUrl = `https://wa.me/${driverNumber}?text=${encodedMessage}`;
            
            // Abrir WhatsApp em nova aba (silenciosamente)
            setTimeout(() => {
                window.open(whatsappUrl, '_blank');
            }, 1000);
        }
        
        // Formatar mensagem para o motorista
        function formatDriverMessage(data) {
            return `üöï *NOVA CORRIDA ACEITA - GoT√°xi* üöï

*Detalhes do Cliente:*
*Nome:* ${data.name}
*Contato:* ${data.contact}
*De:* ${data.origin}
*Para:* ${data.destination}

*Detalhes da Corrida:*
*Passageiros:* ${data.passengers}
*Tempo de Chegada:* ${data.arrivalTime} minutos
*Pagamento:* ${getPaymentMethodText(data.paymentMethod)}
${data.notes ? `*Observa√ß√µes:* ${data.notes}` : ''}

*Solicitado em:* ${data.timestamp}

_Cliente est√° aguardando. Por favor, confirme a chegada._`;
        }
        
        // Mostrar popup de sucesso e iniciar contagem regressiva para redirecionamento
        function showSuccessPopup(driverName) {
            // Atualizar mensagem do popup com o nome do motorista
            popupDriverMessage.textContent = `Seu t√°xi foi aceito por ${driverName || 'um motorista'} e est√° a caminho!`;
            
            // Mostrar popup
            successPopup.classList.add('active');
            
            // Iniciar contagem regressiva
            let seconds = 3;
            countdownElement.textContent = seconds;
            
            redirectCountdown = setInterval(() => {
                seconds--;
                countdownElement.textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(redirectCountdown);
                    // Redirecionar para a p√°gina inicial
                    window.location.href = 'index.html';
                }
            }, 1000);
        }
        
        // Reconfigurar formul√°rio para nova tentativa
        function resetFormForNewRequest() {
            // Reabilitar bot√£o de chamar t√°xi
            callTaxiButton.disabled = false;
            callTaxiButton.textContent = "üöó Chamar T√°xi Novamente";
            
            // Desabilitar bot√£o do WhatsApp
            whatsappButton.disabled = true;
            whatsappButton.style.display = 'none';
            
            // Limpar request ID atual
            currentRequestId = null;
        }
        
        // Enviar via WhatsApp (para o cliente enviar manualmente)
        whatsappButton.addEventListener('click', function() {
            // Coletar dados do formul√°rio
            const formData = getFormData();
            
            // Formatar mensagem para WhatsApp
            const message = formatWhatsAppMessage(formData);
            
            // Codificar mensagem para URL
            const encodedMessage = encodeURIComponent(message);
            
            // N√∫mero padr√£o para envio manual
            const phoneNumber = "351939354112";
            
            // Criar URL do WhatsApp
            const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
            
            // Abrir WhatsApp em nova aba
            window.open(whatsappUrl, '_blank');
        });
        
        // Validar formul√°rio
        function validateForm() {
            const requiredFields = ['name', 'origin', 'destination', 'contact'];
            
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    field.focus();
                    return false;
                }
            }
            
            return true;
        }
        
        // Coletar dados do formul√°rio
        function getFormData() {
            return {
                name: document.getElementById('name').value,
                origin: document.getElementById('origin').value,
                destination: document.getElementById('destination').value,
                passengers: document.getElementById('passengers').value,
                contact: document.getElementById('contact').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                notes: document.getElementById('notes').value,
                timestamp: new Date().toLocaleString('pt-PT', { timeZone: 'Europe/Lisbon' })
            };
        }
        
        // Formatar mensagem para WhatsApp (envio manual)
        function formatWhatsAppMessage(data) {
            return `üöï *SOLICITA√á√ÉO DE T√ÅXI - GoT√°xi* üöï

*Nome:* ${data.name}
*De:* ${data.origin}
*Para:* ${data.destination}
*Passageiros:* ${data.passengers}
*Contato:* ${data.contact}
*Tempo de Chegada:* ${data.arrivalTime} minutos
*Pagamento:* ${getPaymentMethodText(data.paymentMethod)}
${data.notes ? `*Observa√ß√µes:* ${data.notes}` : ''}

*Solicitado em:* ${data.timestamp}

_Por favor, confirme esta solicita√ß√£o._`;
        }
        
        // Obter texto do m√©todo de pagamento
        function getPaymentMethodText(method) {
            switch(method) {
                case 'cash': return 'Dinheiro';
                case 'card': return 'Cart√£o';
                case 'mbway': return 'MBWay';
                default: return method;
            }
        }
        
        // Atualizar indicador de status
        function updateStatusIndicator(status, message) {
            statusIndicator.textContent = message;
            statusIndicator.className = `status-indicator status-${status}`;
            statusIndicator.style.display = 'block';
        }
        
        // Mostrar notifica√ß√£o
        function showNotification(message, isError = false, type = '') {
            notification.textContent = message;
            
            if (type === 'info') {
                notification.className = 'notification info';
            } else {
                notification.className = isError ? 'notification error' : 'notification';
            }
            
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
    </script>
    
    <!-- Google Maps API para autocomplete -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmc6HTJo70N_ueR1qFVgyu74v7FIl7dU4&libraries=places&callback=initAutocomplete">
    </script>
</body>
</html>