<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoTáxi - Seu Táxi em Lisboa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmc6HTJo70N_ueR1qFVgyu74v7FIl7dU4&libraries=places"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            overflow: hidden;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #000;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .logo {
            display: flex;
            flex-direction: column;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .logo p {
            font-size: 14px;
            color: #ccc;
        }

        .header-buttons {
            display: flex;
            gap: 15px;
        }

        .header-buttons button {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .header-buttons button:hover {
            background-color: #555;
        }

        /* Mapa */
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
        }

        /* Botão de chamar táxi */
        .call-taxi-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffcc00;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 999;
            transition: all 0.3s;
        }

        .call-taxi-btn:hover {
            background-color: #ffd633;
            transform: translateX(-50%) scale(1.05);
        }

        /* Modal de formulário */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #777;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input {
            width: auto;
            margin-right: 5px;
        }

        .submit-btn {
            background-color: #ffcc00;
            color: #000;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #ffd633;
        }

        .submit-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
        }

        .whatsapp-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Modal de login */
        .login-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .login-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #777;
        }

        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #f5f5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .login-option.active {
            background-color: #ffcc00;
            font-weight: bold;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .auth-tab.active {
            border-bottom: 3px solid #ffcc00;
            font-weight: bold;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .demo-credentials {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            font-size: 14px;
        }

        .demo-credentials h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .demo-credentials ul {
            list-style: none;
            padding: 0;
        }

        .demo-credentials li {
            margin-bottom: 5px;
            padding: 5px;
            background-color: white;
            border-radius: 3px;
        }

        .warning-message {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .driver-panel {
            display: none;
            position: fixed;
            top: 70px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            z-index: 999;
            width: 300px;
        }

        .driver-panel h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .driver-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .driver-btn {
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .online-btn {
            background-color: #4CAF50;
            color: white;
        }

        .online-btn:hover {
            background-color: #45a049;
        }

        .offline-btn {
            background-color: #f44336;
            color: white;
        }

        .offline-btn:hover {
            background-color: #d32f2f;
        }

        .tracking-btn {
            background-color: #2196F3;
            color: white;
        }

        .tracking-btn:hover {
            background-color: #0b7dda;
        }

        .request-notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            z-index: 999;
            width: 300px;
            display: none;
        }

        .request-notification h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .request-info {
            margin-bottom: 15px;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .accept-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }

        .reject-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
        }

        .countdown {
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
            color: #f44336;
        }

        .confirmation-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            text-align: center;
            display: none;
            max-width: 400px;
            width: 90%;
        }

        .confirmation-message h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .confirmation-message p {
            margin-bottom: 10px;
            color: #555;
        }

        .payment-form {
            display: none;
        }

        .payment-form h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .stripe-element {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .payment-btn {
            background-color: #5469d4;
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        .payment-btn:hover {
            background-color: #4252a8;
        }

        /* Estilo para o marcador do motorista */
        .driver-marker {
            background-color: white;
            border: 3px solid black;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .driver-marker::after {
            content: "";
            width: 10px;
            height: 10px;
            background-color: black;
            border-radius: 50%;
        }

        .user-info {
            position: fixed;
            top: 70px;
            left: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
        }

        .user-info p {
            margin-bottom: 10px;
            color: #333;
        }

        .logout-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo">
            <h1>GoTáxi</h1>
            <p>Seu Táxi Em Lisboa, Quando Precisar</p>
        </div>
        <div class="header-buttons">
            <button id="driver-btn">Área do Motorista</button>
            <button id="client-btn">Cliente</button>
        </div>
    </header>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Botão de chamar táxi -->
    <button class="call-taxi-btn" id="call-taxi-btn">Chame GoTáxi - €0,50</button>

    <!-- Informações do usuário -->
    <div class="user-info" id="user-info">
        <p id="user-welcome">Bem-vindo, </p>
        <button class="logout-btn" id="logout-btn">Sair</button>
    </div>

    <!-- Modal de formulário -->
    <div class="modal" id="form-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Solicitar Táxi</h2>
                <button class="close-btn" id="close-form-btn">&times;</button>
            </div>
            <form id="taxi-form">
                <div class="form-group">
                    <label for="name">Nome</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="pickup">Onde você está?</label>
                    <input type="text" id="pickup" required>
                </div>
                <div class="form-group">
                    <label for="destination">Pra onde vai?</label>
                    <input type="text" id="destination" required>
                </div>
                <div class="form-group">
                    <label for="passengers">Passageiros</label>
                    <select id="passengers" required>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="contact">Contato</label>
                    <input type="tel" id="contact" required>
                </div>
                <div class="form-group">
                    <label>Tempo de chegada</label>
                    <div class="radio-group">
                        <label><input type="radio" name="time" value="5min" required> 5min</label>
                        <label><input type="radio" name="time" value="10min"> 10min</label>
                        <label><input type="radio" name="time" value="15min"> 15min</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="payment">Forma de pagamento</label>
                    <select id="payment" required>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="cartao">Cartão</option>
                        <option value="mbway">MBWay</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="notes">Observação</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                
                <div class="payment-form" id="payment-form">
                    <h3>Pagamento - €0,50</h3>
                    <div id="card-element" class="stripe-element"></div>
                    <button type="button" class="payment-btn" id="confirm-payment-btn">Confirmar Pagamento</button>
                </div>
                
                <button type="button" class="submit-btn" id="submit-form-btn">Finalizar Chamada</button>
                <button type="button" class="whatsapp-btn" id="whatsapp-btn" disabled>
                    <i class="fab fa-whatsapp"></i> Enviar Via WhatsApp
                </button>
            </form>
        </div>
    </div>

    <!-- Modal de login -->
    <div class="login-modal" id="login-modal">
        <div class="login-content">
            <div class="login-header">
                <h2 id="login-title">Login</h2>
                <p id="login-subtitle">Entre na sua conta</p>
            </div>
            <div class="warning-message" id="auth-warning" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                Sistema de autenticação temporariamente indisponível. Use as credenciais de demonstração.
            </div>
            <div class="login-options">
                <div class="login-option active" id="client-option">Cliente</div>
                <div class="login-option" id="driver-option">Motorista</div>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="login-tab">Entrar</div>
                <div class="auth-tab" id="register-tab">Registrar</div>
            </div>
            
            <form id="login-form" class="auth-form active">
                <div class="form-group">
                    <label for="username">Usuário</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="submit-btn">Entrar</button>
            </form>
            
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <label for="reg-name">Nome Completo</label>
                    <input type="text" id="reg-name" required>
                </div>
                <div class="form-group">
                    <label for="reg-username">Usuário</label>
                    <input type="text" id="reg-username" required>
                </div>
                <div class="form-group">
                    <label for="reg-email">Email</label>
                    <input type="email" id="reg-email" required>
                </div>
                <div class="form-group">
                    <label for="reg-phone">Telefone</label>
                    <input type="tel" id="reg-phone" required>
                </div>
                <div class="form-group">
                    <label for="reg-password">Senha</label>
                    <input type="password" id="reg-password" required>
                </div>
                <div class="form-group">
                    <label for="reg-confirm-password">Confirmar Senha</label>
                    <input type="password" id="reg-confirm-password" required>
                </div>
                <button type="submit" class="submit-btn">Registrar</button>
            </form>

            <div class="demo-credentials">
                <h4>Credenciais de Demonstração:</h4>
                <ul>
                    <li><strong>Motoristas:</strong> Mega / Heitor / Marcelo | Senha: 12345</li>
                    <li><strong>Cliente:</strong> cliente | Senha: 12345</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Painel do motorista -->
    <div class="driver-panel" id="driver-panel">
        <h3>Painel do Motorista</h3>
        <div class="driver-controls">
            <button class="driver-btn online-btn" id="online-btn">Ficar Online</button>
            <button class="driver-btn tracking-btn" id="tracking-btn">Iniciar Rastreamento</button>
            <button class="driver-btn offline-btn" id="offline-btn">Ficar Offline</button>
        </div>
    </div>

    <!-- Notificação de solicitação -->
    <div class="request-notification" id="request-notification">
        <h3>Solicitação de Táxi</h3>
        <div class="request-info" id="request-info">
            <!-- Informações da solicitação serão preenchidas aqui -->
        </div>
        <div class="request-actions">
            <button class="accept-btn" id="accept-btn">Aceitar</button>
            <button class="reject-btn" id="reject-btn">Rejeitar</button>
        </div>
        <div class="countdown" id="countdown">60s</div>
    </div>

    <!-- Mensagem de confirmação -->
    <div class="confirmation-message" id="confirmation-message">
        <h3>Chamada Confirmada!</h3>
        <p id="driver-info">Seu motorista está a caminho.</p>
        <p>Aguarde a chegada do táxi.</p>
        <button class="submit-btn" id="close-confirmation-btn">OK</button>
    </div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB2ljIwjmbPF1vfCgth4bLd3d7hhLdxKIk",
            authDomain: "lisboago-app.firebaseapp.com",
            projectId: "lisboago-app",
            storageBucket: "lisboago-app.firebasestorage.app",
            messagingSenderId: "467502556237",
            appId: "1:467502556237:web:ff0074a42a664f7efba804"
        };

        // Inicializar Firebase
        let firebaseApp;
        let auth;
        let db;
        let rtdb;
        let firebaseInitialized = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            rtdb = firebase.database();
            firebaseInitialized = true;
            console.log('Firebase inicializado com sucesso');
        } catch (error) {
            console.warn('Erro ao inicializar Firebase, usando modo de demonstração:', error);
            firebaseInitialized = false;
            document.getElementById('auth-warning').style.display = 'block';
        }

        // Configuração do Stripe
        const stripe = Stripe('pk_live_51SGN5U2HvDIJYgktaJbjaVG6KwJY1vavWq1OW4XOj5mMGsTrIZ1yqRX4mhOV76G9XVYn4CTWl6kUYcM1OzFa1r2P00QncLSuPE');
        const elements = stripe.elements();
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        // Variáveis globais
        let map;
        let userLocation = null;
        let userMarker = null;
        let drivers = {};
        let currentUser = null;
        let userType = null;
        let isTracking = false;
        let isOnline = false;
        let currentRequest = null;
        let countdownInterval = null;
        let selectedDriver = null;

        // Sistema de usuários local (fallback)
        const localUsers = {
            // Motoristas pré-definidos
            'Mega': { 
                password: '12345', 
                type: 'driver', 
                phone: '939354112',
                name: 'Mega'
            },
            'Heitor': { 
                password: '12345', 
                type: 'driver', 
                phone: '351910603136',
                name: 'Heitor'
            },
            'Marcelo': { 
                password: '12345', 
                type: 'driver', 
                phone: '351939057350',
                name: 'Marcelo'
            },
            // Cliente de demonstração
            'cliente': { 
                password: '12345', 
                type: 'client',
                name: 'Cliente Demo'
            }
        };

        // Usuários registrados localmente
        const registeredUsers = JSON.parse(localStorage.getItem('gotaxi_users') || '{}');

        // Inicializar mapa
        function initMap() {
            const lisbon = { lat: 38.7223, lng: -9.1393 };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: lisbon,
                zoom: 13,
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "geometry.fill",
                        "stylers": [{ "weight": "2.00" }]
                    },
                    {
                        "featureType": "all",
                        "elementType": "geometry.stroke",
                        "stylers": [{ "color": "#9c9c9c" }]
                    },
                    {
                        "featureType": "landscape",
                        "elementType": "all",
                        "stylers": [{ "color": "#f2f2f2" }]
                    },
                    {
                        "featureType": "road",
                        "elementType": "all",
                        "stylers": [
                            { "saturation": -100 },
                            { "lightness": 45 }
                        ]
                    },
                    {
                        "featureType": "road.highway",
                        "elementType": "all",
                        "stylers": [{ "visibility": "simplified" }]
                    },
                    {
                        "featureType": "water",
                        "elementType": "all",
                        "stylers": [
                            { "color": "#46bcec" },
                            { "visibility": "on" }
                        ]
                    }
                ]
            });

            // Obter localização do usuário
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        map.setCenter(userLocation);
                        
                        userMarker = new google.maps.Marker({
                            position: userLocation,
                            map: map,
                            title: 'Sua localização',
                            icon: {
                                url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="10" cy="10" r="8" fill="#4285F4" stroke="white" stroke-width="2"/>
                                    </svg>
                                `),
                                scaledSize: new google.maps.Size(20, 20)
                            }
                        });
                    },
                    () => {
                        userLocation = lisbon;
                    }
                );
            } else {
                userLocation = lisbon;
            }

            // Inicializar autocomplete
            const pickupInput = document.getElementById('pickup');
            const destinationInput = document.getElementById('destination');
            
            const pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput);
            const destinationAutocomplete = new google.maps.places.Autocomplete(destinationInput);
            
            listenForDrivers();
        }

        // Sistema de autenticação simplificado
        function registerUser(userData) {
            return new Promise((resolve, reject) => {
                // Verificar se o usuário já existe
                if (localUsers[userData.username] || registeredUsers[userData.username]) {
                    reject('Nome de usuário já existe. Escolha outro.');
                    return;
                }
                
                // Adicionar usuário localmente
                registeredUsers[userData.username] = {
                    password: userData.password,
                    type: 'client',
                    name: userData.name,
                    email: userData.email,
                    phone: userData.phone
                };
                
                // Salvar no localStorage
                localStorage.setItem('gotaxi_users', JSON.stringify(registeredUsers));
                
                const user = {
                    uid: 'local_' + userData.username,
                    displayName: userData.name,
                    ...userData,
                    type: 'client'
                };
                
                resolve(user);
            });
        }

        function loginUser(username, password, type) {
            return new Promise((resolve, reject) => {
                // Verificar usuários pré-definidos primeiro
                if (localUsers[username] && localUsers[username].password === password && localUsers[username].type === type) {
                    const userData = localUsers[username];
                    currentUser = {
                        uid: 'predef_' + username,
                        displayName: userData.name || username,
                        ...userData
                    };
                    userType = type;
                    resolve(currentUser);
                    return;
                }
                
                // Verificar usuários registrados
                if (registeredUsers[username] && registeredUsers[username].password === password && registeredUsers[username].type === type) {
                    const userData = registeredUsers[username];
                    currentUser = {
                        uid: 'local_' + username,
                        displayName: userData.name || username,
                        ...userData
                    };
                    userType = type;
                    resolve(currentUser);
                    return;
                }
                
                reject('Usuário não encontrado ou senha incorreta. Use as credenciais de demonstração.');
            });
        }

        // Resto das funções permanecem iguais...
        function listenForDrivers() {
            if (!firebaseInitialized) {
                createDemoDrivers();
                return;
            }

            rtdb.ref('drivers').on('value', (snapshot) => {
                const driversData = snapshot.val();
                
                Object.values(drivers).forEach(driver => {
                    if (driver.marker) {
                        driver.marker.setMap(null);
                    }
                });
                
                drivers = {};
                
                if (driversData) {
                    Object.keys(driversData).forEach(driverId => {
                        const driver = driversData[driverId];
                        if (driver.isOnline && driver.location) {
                            createDriverMarker(driverId, driver);
                        }
                    });
                }
            });
        }

        function createDemoDrivers() {
            const demoDrivers = {
                'Mega': {
                    name: 'Mega',
                    isOnline: true,
                    location: userLocation ? 
                        { lat: userLocation.lat + 0.005, lng: userLocation.lng + 0.005 } :
                        { lat: 38.7273, lng: -9.1343 }
                },
                'Heitor': {
                    name: 'Heitor',
                    isOnline: true,
                    location: userLocation ? 
                        { lat: userLocation.lat - 0.003, lng: userLocation.lng + 0.007 } :
                        { lat: 38.7193, lng: -9.1323 }
                },
                'Marcelo': {
                    name: 'Marcelo',
                    isOnline: true,
                    location: userLocation ? 
                        { lat: userLocation.lat + 0.007, lng: userLocation.lng - 0.004 } :
                        { lat: 38.7293, lng: -9.1433 }
                }
            };

            Object.keys(demoDrivers).forEach(driverId => {
                createDriverMarker(driverId, demoDrivers[driverId]);
            });
        }

        function createDriverMarker(driverId, driver) {
            const driverMarker = new google.maps.Marker({
                position: driver.location,
                map: map,
                title: `Motorista ${driver.name}`,
                icon: {
                    url: 'https://www.flaticon.com/free-icon/transport_16062688', // URL do ícone do carrinho
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            
            driverMarker.addListener('click', () => {
                if (currentUser && userType === 'client') {
                    selectedDriver = driverId;
                    alert(`Motorista ${driver.name} selecionado. Você pode agora solicitar um táxi.`);
                }
            });
            
            drivers[driverId] = {
                ...driver,
                marker: driverMarker
            };
        }

        // Funções restantes (goOnline, goOffline, etc.) permanecem iguais
        function goOnline() {
            if (currentUser) {
                isOnline = true;
                if (firebaseInitialized) {
                    rtdb.ref(`drivers/${currentUser.uid}`).update({
                        isOnline: true,
                        name: currentUser.displayName || 'Motorista'
                    });
                }
                
                document.getElementById('online-btn').style.display = 'none';
                document.getElementById('offline-btn').style.display = 'block';
                
                listenForRequests();
            }
        }

        function goOffline() {
            if (currentUser) {
                isOnline = false;
                if (firebaseInitialized) {
                    rtdb.ref(`drivers/${currentUser.uid}`).update({
                        isOnline: false
                    });
                }
                
                document.getElementById('online-btn').style.display = 'block';
                document.getElementById('offline-btn').style.display = 'none';
                
                stopTracking();
            }
        }

        function startTracking() {
            isTracking = true;
            updateDriverLocation();
            document.getElementById('tracking-btn').textContent = 'Rastreamento Ativo';
            document.getElementById('tracking-btn').style.backgroundColor = '#4CAF50';
        }

        function stopTracking() {
            isTracking = false;
            document.getElementById('tracking-btn').textContent = 'Iniciar Rastreamento';
            document.getElementById('tracking-btn').style.backgroundColor = '#2196F3';
        }

        function updateDriverLocation() {
            if (navigator.geolocation && isTracking && isOnline && currentUser) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        if (firebaseInitialized) {
                            rtdb.ref(`drivers/${currentUser.uid}`).update({
                                location: location,
                                lastUpdate: firebase.database.ServerValue.TIMESTAMP
                            });
                        }
                    },
                    (error) => {
                        console.error('Erro ao obter localização:', error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }

        function showUserInfo() {
            if (currentUser) {
                document.getElementById('user-welcome').textContent = `Bem-vindo, ${currentUser.name || currentUser.displayName}`;
                document.getElementById('user-info').style.display = 'block';
            }
        }

        function logout() {
            if (userType === 'driver' && isOnline) {
                goOffline();
            }
            
            currentUser = null;
            userType = null;
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('driver-panel').style.display = 'none';
            alert('Logout realizado com sucesso.');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            
            document.getElementById('driver-btn').addEventListener('click', () => {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('login-title').textContent = 'Área do Motorista';
                document.getElementById('login-subtitle').textContent = 'Entre na sua conta de motorista';
                document.getElementById('driver-option').click();
            });
            
            document.getElementById('client-btn').addEventListener('click', () => {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('login-title').textContent = 'Área do Cliente';
                document.getElementById('login-subtitle').textContent = 'Entre na sua conta de cliente';
                document.getElementById('client-option').click();
            });
            
            document.getElementById('call-taxi-btn').addEventListener('click', () => {
                if (currentUser && userType === 'client') {
                    document.getElementById('form-modal').style.display = 'flex';
                } else {
                    alert('Por favor, faça login como cliente primeiro.');
                    document.getElementById('client-btn').click();
                }
            });
            
            document.getElementById('close-form-btn').addEventListener('click', () => {
                document.getElementById('form-modal').style.display = 'none';
            });
            
            document.getElementById('client-option').addEventListener('click', () => {
                document.getElementById('client-option').classList.add('active');
                document.getElementById('driver-option').classList.remove('active');
                userType = 'client';
                document.getElementById('register-tab').style.display = 'flex';
            });
            
            document.getElementById('driver-option').addEventListener('click', () => {
                document.getElementById('driver-option').classList.add('active');
                document.getElementById('client-option').classList.remove('active');
                userType = 'driver';
                document.getElementById('register-tab').style.display = 'none';
            });
            
            document.getElementById('login-tab').addEventListener('click', () => {
                document.getElementById('login-tab').classList.add('active');
                document.getElementById('register-tab').classList.remove('active');
                document.getElementById('login-form').classList.add('active');
                document.getElementById('register-form').classList.remove('active');
            });
            
            document.getElementById('register-tab').addEventListener('click', () => {
                if (userType === 'client') {
                    document.getElementById('register-tab').classList.add('active');
                    document.getElementById('login-tab').classList.remove('active');
                    document.getElementById('register-form').classList.add('active');
                    document.getElementById('login-form').classList.remove('active');
                } else {
                    alert('Registro disponível apenas para clientes. Motoristas devem usar as credenciais pré-definidas.');
                }
            });
            
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                loginUser(username, password, userType)
                    .then((user) => {
                        document.getElementById('login-modal').style.display = 'none';
                        showUserInfo();
                        
                        if (userType === 'driver') {
                            document.getElementById('driver-panel').style.display = 'block';
                            alert('Login como motorista realizado com sucesso!');
                        } else {
                            alert('Login como cliente realizado com sucesso! Agora você pode selecionar um motorista no mapa.');
                        }
                    })
                    .catch((error) => {
                        alert(error);
                    });
            });
            
            document.getElementById('register-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const userData = {
                    name: document.getElementById('reg-name').value,
                    username: document.getElementById('reg-username').value,
                    email: document.getElementById('reg-email').value,
                    phone: document.getElementById('reg-phone').value,
                    password: document.getElementById('reg-password').value
                };
                
                const confirmPassword = document.getElementById('reg-confirm-password').value;
                
                if (userData.password !== confirmPassword) {
                    alert('As senhas não coincidem.');
                    return;
                }
                
                if (userData.password.length < 6) {
                    alert('A senha deve ter pelo menos 6 caracteres.');
                    return;
                }
                
                registerUser(userData)
                    .then((user) => {
                        document.getElementById('login-modal').style.display = 'none';
                        showUserInfo();
                        alert('Registro realizado com sucesso! Agora você pode selecionar um motorista no mapa.');
                    })
                    .catch((error) => {
                        alert(error);
                    });
            });
            
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            document.getElementById('online-btn').addEventListener('click', goOnline);
            document.getElementById('offline-btn').addEventListener('click', goOffline);
            document.getElementById('tracking-btn').addEventListener('click', startTracking);
        });

        window.addEventListener('click', (e) => {
            if (e.target === document.getElementById('form-modal')) {
                document.getElementById('form-modal').style.display = 'none';
            }
            if (e.target === document.getElementById('login-modal')) {
                document.getElementById('login-modal').style.display = 'none';
            }
        });
    </script>
</body>
</html>