<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoT√°xi - Seu T√°xi Em Lisboa</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#ffc107">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GoT√°xi">
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        header {
            background-color: #000;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo span {
            color: #ffc107;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            align-items: center;
        }
        
        nav ul li {
            margin-left: 15px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #333;
        }
        
        .language-selector {
            background: transparent;
            border: 1px solid #ffc107;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .language-selector option {
            background: #000;
            color: white;
        }
        
        #map {
            height: calc(100vh - 60px);
            width: 100%;
            background-color: #e0e0e0;
        }
        
        .map-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            text-align: center;
            padding: 20px;
        }
        
        .location-card {
            position: absolute;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .call-taxi-btn {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: background-color 0.3s;
        }
        
        .call-taxi-btn:hover {
            background-color: #e0a800;
        }
        
        .call-taxi-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .call-taxi-btn.active {
            background-color: #ffc107;
            cursor: pointer;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .driver-info {
            position: absolute;
            bottom: 100px;
            left: 20px;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .floating-buttons {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .floating-btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-btn:hover {
            background-color: #e0a800;
        }
        
        .center-map-btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .center-map-btn:hover {
            background-color: #e0a800;
        }
        
        .center-map-btn.active {
            background-color: #4CAF50;
            color: white;
        }

        .online-drivers-counter {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .reservation-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1002;
            display: none;
            width: 90%;
            max-width: 400px;
        }

        .reservation-card h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .reservation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .reservation-option {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .reservation-option:hover {
            background-color: #e0e0e0;
        }

        .reservation-option.selected {
            background-color: #ffc107;
            color: #000;
            font-weight: bold;
        }

        .reservation-actions {
            display: flex;
            justify-content: space-between;
        }

        .btn-confirm {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
            max-width: 90%;
            text-align: center;
        }

        .install-prompt button {
            background: #ffc107;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 0 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Go<span>T√°xi</span></div>
        <nav>
            <ul>
                <li>
                    <select id="languageSelector" class="language-selector" onchange="changeLanguage(this.value)">
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                    </select>
                </li>
            </ul>
        </nav>
    </header>
    
    <div id="map">
        <div class="map-error">
            <h2>üöó GoT√°xi</h2>
            <p data-i18n="loading_map">Carregando mapa...</p>
            <p data-i18n="check_connection">Se o mapa n√£o carregar, verifique sua conex√£o com a internet</p>
        </div>
    </div>

    <div id="onlineDriversCounter" class="online-drivers-counter" style="display: none;">
        üöó <span id="driversCount">0</span> <span data-i18n="drivers_online">motoristas online</span>
    </div>
    
    <div class="location-card">
        <div class="form-group">
            <label for="origin" data-i18n="where_are_you">Onde est√°?</label>
            <input type="text" id="origin" data-i18n-placeholder="enter_current_location" placeholder="Digite sua localiza√ß√£o atual">
        </div>
        <div class="form-group">
            <label for="destination" data-i18n="where_to">Pra onde vai?</label>
            <input type="text" id="destination" data-i18n-placeholder="enter_destination" placeholder="Digite seu destino">
        </div>
    </div>

    <div class="floating-buttons">
        <button class="floating-btn" onclick="goToForm()" data-i18n-title="call_taxi" title="Chamar T√°xi">
            üöó
        </button>
        <button class="floating-btn" onclick="getCurrentLocation()" data-i18n-title="my_location" title="Minha Localiza√ß√£o">
            üìç
        </button>
        <button id="centerMapBtn" class="center-map-btn" onclick="centerMap()" data-i18n-title="center_map" title="Centralizar Mapa">
            üß≠
        </button>
    </div>
    
    <button id="callTaxi" class="call-taxi-btn" onclick="goToForm()" data-i18n="call_gotaxi">Chame GoT√°xi</button>
    
    <div id="notification" class="notification"></div>
    
    <div id="driverInfo" class="driver-info">
        <h3 data-i18n="driver_on_way">Motorista a caminho</h3>
        <p id="driverDetails"></p>
        <p id="estimatedTime"></p>
    </div>

    <div id="reservationCard" class="reservation-card">
        <h3>‚è∞ <span data-i18n="reservation_proposal">Proposta de Reserva</span></h3>
        <div id="reservationDetails" class="request-details">
            <!-- Detalhes da reserva ser√£o preenchidos aqui -->
        </div>
        <div class="reservation-actions">
            <button id="acceptReservation" class="btn-confirm" data-i18n="accept_reservation">‚úÖ Aceitar Reserva</button>
            <button id="rejectReservation" class="btn-cancel" data-i18n="reject_reservation">‚ùå Rejeitar Reserva</button>
        </div>
    </div>

    <div id="installPrompt" class="install-prompt">
        <p>üì≤ <span data-i18n="install_app">Instalar o GoT√°xi no seu celular?</span></p>
        <button id="installBtn" data-i18n="install_now">Instalar Agora</button>
        <button id="cancelInstall" data-i18n="not_now">Agora N√£o</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Sistema de Internacionaliza√ß√£o
        const translations = {
            pt: {
                // Interface
                "loading_map": "Carregando mapa...",
                "check_connection": "Se o mapa n√£o carregar, verifique sua conex√£o com a internet",
                "drivers_online": "motoristas online",
                "where_are_you": "Onde est√°?",
                "where_to": "Pra onde vai?",
                "enter_current_location": "Digite sua localiza√ß√£o atual",
                "enter_destination": "Digite seu destino",
                "call_taxi": "Chamar T√°xi",
                "my_location": "Minha Localiza√ß√£o",
                "center_map": "Centralizar Mapa",
                "call_gotaxi": "Chame GoT√°xi",
                "driver_on_way": "Motorista a caminho",
                "reservation_proposal": "Proposta de Reserva",
                "accept_reservation": "‚úÖ Aceitar Reserva",
                "reject_reservation": "‚ùå Rejeitar Reserva",
                "install_app": "Instalar o GoT√°xi no seu celular?",
                "install_now": "Instalar Agora",
                "not_now": "Agora N√£o",
                
                // Notifica√ß√µes
                "location_updated": "Localiza√ß√£o atualizada!",
                "map_centered": "Mapa centralizado!",
                "location_unavailable": "Localiza√ß√£o n√£o dispon√≠vel. Ative a localiza√ß√£o.",
                "location_error": "N√£o foi poss√≠vel obter sua localiza√ß√£o. Digite manualmente.",
                "reservation_accepted": "‚úÖ Voc√™ aceitou a reserva! Aguarde a chegada do motorista.",
                "reservation_rejected": "‚ùå Voc√™ rejeitou a reserva.",
                "driver_accepted": "Motorista aceitou sua corrida!",
                "driver_rejected": "Nenhum motorista dispon√≠vel no momento.",
                "estimated_time": "Tempo estimado: 5-10 minutos",
                "map_error": "Erro ao carregar o mapa. Verifique sua conex√£o.",
                "auth_error": "Erro de autentica√ß√£o do Google Maps. Verifique a chave da API."
            },
            en: {
                // Interface
                "loading_map": "Loading map...",
                "check_connection": "If the map doesn't load, check your internet connection",
                "drivers_online": "drivers online",
                "where_are_you": "Where are you?",
                "where_to": "Where to?",
                "enter_current_location": "Enter your current location",
                "enter_destination": "Enter your destination",
                "call_taxi": "Call Taxi",
                "my_location": "My Location",
                "center_map": "Center Map",
                "call_gotaxi": "Call GoT√°xi",
                "driver_on_way": "Driver on the way",
                "reservation_proposal": "Reservation Proposal",
                "accept_reservation": "‚úÖ Accept Reservation",
                "reject_reservation": "‚ùå Reject Reservation",
                "install_app": "Install GoT√°xi on your phone?",
                "install_now": "Install Now",
                "not_now": "Not Now",
                
                // Notifications
                "location_updated": "Location updated!",
                "map_centered": "Map centered!",
                "location_unavailable": "Location unavailable. Please enable location services.",
                "location_error": "Could not get your location. Please enter manually.",
                "reservation_accepted": "‚úÖ You accepted the reservation! Wait for the driver's arrival.",
                "reservation_rejected": "‚ùå You rejected the reservation.",
                "driver_accepted": "Driver accepted your ride!",
                "driver_rejected": "No drivers available at the moment.",
                "estimated_time": "Estimated time: 5-10 minutes",
                "map_error": "Error loading map. Check your connection.",
                "auth_error": "Google Maps authentication error. Check the API key."
            },
            es: {
                // Interface
                "loading_map": "Cargando mapa...",
                "check_connection": "Si el mapa no carga, verifica tu conexi√≥n a internet",
                "drivers_online": "conductores en l√≠nea",
                "where_are_you": "¬øD√≥nde est√°s?",
                "where_to": "¬øA d√≥nde vas?",
                "enter_current_location": "Ingresa tu ubicaci√≥n actual",
                "enter_destination": "Ingresa tu destino",
                "call_taxi": "Llamar Taxi",
                "my_location": "Mi Ubicaci√≥n",
                "center_map": "Centrar Mapa",
                "call_gotaxi": "Llamar GoT√°xi",
                "driver_on_way": "Conductor en camino",
                "reservation_proposal": "Propuesta de Reserva",
                "accept_reservation": "‚úÖ Aceptar Reserva",
                "reject_reservation": "‚ùå Rechazar Reserva",
                "install_app": "¬øInstalar GoT√°xi en tu tel√©fono?",
                "install_now": "Instalar Ahora",
                "not_now": "Ahora No",
                
                // Notifications
                "location_updated": "¬°Ubicaci√≥n actualizada!",
                "map_centered": "¬°Mapa centrado!",
                "location_unavailable": "Ubicaci√≥n no disponible. Active los servicios de ubicaci√≥n.",
                "location_error": "No se pudo obtener su ubicaci√≥n. Ingrese manualmente.",
                "reservation_accepted": "‚úÖ ¬°Aceptaste la reserva! Espera la llegada del conductor.",
                "reservation_rejected": "‚ùå Rechazaste la reserva.",
                "driver_accepted": "¬°Conductor acept√≥ tu viaje!",
                "driver_rejected": "No hay conductores disponibles en este momento.",
                "estimated_time": "Tiempo estimado: 5-10 minutos",
                "map_error": "Error al cargar el mapa. Verifica tu conexi√≥n.",
                "auth_error": "Error de autenticaci√≥n de Google Maps. Verifique la clave API."
            },
            fr: {
                // Interface
                "loading_map": "Chargement de la carte...",
                "check_connection": "Si la carte ne se charge pas, v√©rifiez votre connexion Internet",
                "drivers_online": "conducteurs en ligne",
                "where_are_you": "O√π √™tes-vous?",
                "where_to": "O√π allez-vous?",
                "enter_current_location": "Entrez votre position actuelle",
                "enter_destination": "Entrez votre destination",
                "call_taxi": "Appeler un Taxi",
                "my_location": "Ma Position",
                "center_map": "Centrer la Carte",
                "call_gotaxi": "Appeler GoT√°xi",
                "driver_on_way": "Chauffeur en route",
                "reservation_proposal": "Proposition de R√©servation",
                "accept_reservation": "‚úÖ Accepter la R√©servation",
                "reject_reservation": "‚ùå Rejeter la R√©servation",
                "install_app": "Installer GoT√°xi sur votre t√©l√©phone?",
                "install_now": "Installer Maintenant",
                "not_now": "Pas Maintenant",
                
                // Notifications
                "location_updated": "Position mise √† jour!",
                "map_centered": "Carte centr√©e!",
                "location_unavailable": "Position non disponible. Activez les services de localisation.",
                "location_error": "Impossible d'obtenir votre position. Veuillez saisir manuellement.",
                "reservation_accepted": "‚úÖ Vous avez accept√© la r√©servation! Attendez l'arriv√©e du chauffeur.",
                "reservation_rejected": "‚ùå Vous avez rejet√© la r√©servation.",
                "driver_accepted": "Chauffeur a accept√© votre course!",
                "driver_rejected": "Aucun chauffeur disponible pour le moment.",
                "estimated_time": "Temps estim√©: 5-10 minutes",
                "map_error": "Erreur de chargement de la carte. V√©rifiez votre connexion.",
                "auth_error": "Erreur d'authentification Google Maps. V√©rifiez la cl√© API."
            }
        };

        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAZ4YqmOZz0wUlhBvuSD_fBLcwq1av8yc8",
            authDomain: "gotaxi-4e391.firebaseapp.com",
            databaseURL: "https://gotaxi-4e391-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gotaxi-4e391",
            storageBucket: "gotaxi-4e391.firebasestorage.app",
            messagingSenderId: "597857194128",
            appId: "1:597857194128:web:9b550abd9b5e98bb374815"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Vari√°veis globais
        let map;
        let userMarker;
        let originAutocomplete;
        let destinationAutocomplete;
        let userLocation;
        let clientId;
        let reservationMarker;
        let deferredPrompt;
        let mapInitialized = false;
        let currentLanguage = 'pt';

        // Fun√ß√£o para mudar idioma
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            // Salvar prefer√™ncia no localStorage
            localStorage.setItem('preferredLanguage', lang);
        }

        // Fun√ß√£o para atualizar todos os textos
        function updateTexts() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            // Atualizar placeholders
            const placeholders = document.querySelectorAll('[data-i18n-placeholder]');
            placeholders.forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                if (translations[currentLanguage][key]) {
                    element.setAttribute('placeholder', translations[currentLanguage][key]);
                }
            });

            // Atualizar titles
            const titles = document.querySelectorAll('[data-i18n-title]');
            titles.forEach(element => {
                const key = element.getAttribute('data-i18n-title');
                if (translations[currentLanguage][key]) {
                    element.setAttribute('title', translations[currentLanguage][key]);
                }
            });
        }

        // Fun√ß√£o para obter tradu√ß√£o
        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        // Sistema de movimento suave
        class SmoothMovementSystem {
            constructor() {
                this.cars = new Map();
                this.animationId = null;
                this.isAnimating = false;
            }

            updateCarPosition(carId, newPosition, newHeading) {
                if (!this.cars.has(carId)) {
                    this.cars.set(carId, {
                        marker: this.createCarMarker(newPosition, newHeading),
                        currentPos: newPosition,
                        targetPos: newPosition,
                        currentHeading: newHeading,
                        targetHeading: newHeading,
                        startTime: Date.now(),
                        duration: 0,
                        lastUpdate: Date.now()
                    });
                } else {
                    const car = this.cars.get(carId);
                    
                    const distance = this.calculateDistance(car.currentPos, newPosition);
                    const timeDiff = Date.now() - car.lastUpdate;
                    const expectedDuration = this.calculateDuration(distance, timeDiff);
                    
                    car.currentPos = car.marker.getPosition();
                    car.targetPos = newPosition;
                    car.currentHeading = this.getCarRotation(car.marker);
                    car.targetHeading = newHeading;
                    car.startTime = Date.now();
                    car.duration = Math.max(1000, Math.min(5000, expectedDuration));
                    car.lastUpdate = Date.now();
                }

                if (!this.isAnimating) {
                    this.startAnimationLoop();
                }
            }

            createCarMarker(position, heading) {
                return new google.maps.Marker({
                    position: position,
                    map: map,
                    title: "Motorista",
                    icon: {
                        url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                        scaledSize: new google.maps.Size(40, 60),
                        anchor: new google.maps.Point(20, 30),
                        rotation: heading
                    }
                });
            }

            getCarRotation(marker) {
                return marker.getIcon().rotation || 0;
            }

            startAnimationLoop() {
                this.isAnimating = true;
                
                const animate = () => {
                    const currentTime = Date.now();
                    let hasActiveAnimations = false;

                    this.cars.forEach((car, carId) => {
                        const elapsed = currentTime - car.startTime;
                        let progress = Math.min(elapsed / car.duration, 1);

                        if (progress < 1) {
                            hasActiveAnimations = true;
                            
                            progress = this.easeInOutCubic(progress);
                            
                            const newPos = this.interpolatePosition(
                                car.currentPos, 
                                car.targetPos, 
                                progress
                            );
                            
                            const newHeading = this.interpolateHeading(
                                car.currentHeading,
                                car.targetHeading,
                                progress
                            );
                            
                            car.marker.setPosition(newPos);
                            car.marker.setIcon({
                                url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                                scaledSize: new google.maps.Size(40, 60),
                                anchor: new google.maps.Point(20, 30),
                                rotation: newHeading
                            });
                            
                            car.currentHeading = newHeading;
                        } else {
                            car.marker.setPosition(car.targetPos);
                            car.marker.setIcon({
                                url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                                scaledSize: new google.maps.Size(40, 60),
                                anchor: new google.maps.Point(20, 30),
                                rotation: car.targetHeading
                            });
                            
                            car.currentHeading = car.targetHeading;
                        }
                    });

                    if (hasActiveAnimations) {
                        this.animationId = requestAnimationFrame(animate);
                    } else {
                        this.isAnimating = false;
                    }
                };

                this.animationId = requestAnimationFrame(animate);
            }

            interpolatePosition(start, end, progress) {
                const lat1 = typeof start.lat === 'function' ? start.lat() : start.lat;
                const lng1 = typeof start.lng === 'function' ? start.lng() : start.lng;
                const lat2 = typeof end.lat === 'function' ? end.lat() : end.lat;
                const lng2 = typeof end.lng === 'function' ? end.lng() : end.lng;
                
                return {
                    lat: lat1 + (lat2 - lat1) * progress,
                    lng: lng1 + (lng2 - lng1) * progress
                };
            }

            interpolateHeading(start, end, progress) {
                let diff = end - start;
                if (Math.abs(diff) > 180) {
                    diff = diff > 0 ? diff - 360 : diff + 360;
                }
                return start + diff * progress;
            }

            calculateDistance(pos1, pos2) {
                const lat1 = typeof pos1.lat === 'function' ? pos1.lat() : pos1.lat;
                const lng1 = typeof pos1.lng === 'function' ? pos1.lng() : pos1.lng;
                const lat2 = typeof pos2.lat === 'function' ? pos2.lat() : pos2.lat;
                const lng2 = typeof pos2.lng === 'function' ? pos2.lng() : pos2.lng;
                
                const R = 6371000;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            calculateDuration(distance, timeDiff) {
                const averageSpeed = 8.33;
                const expectedTime = distance / averageSpeed * 1000;
                return Math.max(expectedTime, timeDiff * 1.2);
            }

            easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
            }

            removeCar(carId) {
                if (this.cars.has(carId)) {
                    const car = this.cars.get(carId);
                    car.marker.setMap(null);
                    this.cars.delete(carId);
                }
            }

            clearAll() {
                this.cars.forEach(car => car.marker.setMap(null));
                this.cars.clear();
                this.isAnimating = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
            }
        }

        const smoothMovement = new SmoothMovementSystem();
        
        // Gerar ID √∫nico para o cliente
        clientId = 'client_' + Math.random().toString(36).substr(2, 9);
        
        // Fun√ß√£o para ir para o formul√°rio
        function goToForm() {
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            
            const params = new URLSearchParams();
            if (origin) params.append('origin', origin);
            if (destination) params.append('destination', destination);
            params.append('lang', currentLanguage);
            
            window.location.href = `formulario.html?${params.toString()}`;
        }
        
        // Inicializar mapa
        function initMap() {
            try {
                const lisbon = { lat: 38.7223, lng: -9.1393 };
                
                map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 12,
                    center: lisbon,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: true,
                    tilt: 0,
                    heading: 0,
                    gestureHandling: "greedy",
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                });
                
                userMarker = new google.maps.Marker({
                    position: lisbon,
                    map: map,
                    title: "Sua Localiza√ß√£o",
                    icon: {
                        url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                    }
                });
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };
                            
                            userMarker.setPosition(userLocation);
                            map.setCenter(userLocation);
                            
                            const geocoder = new google.maps.Geocoder();
                            geocoder.geocode({ location: userLocation }, (results, status) => {
                                if (status === "OK" && results[0]) {
                                    document.getElementById('origin').value = results[0].formatted_address;
                                }
                            });
                        },
                        () => {
                            handleLocationError(true, map.getCenter());
                        }
                    );
                } else {
                    handleLocationError(false, map.getCenter());
                }
                
                originAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('origin'),
                    { types: ['geocode'] }
                );
                
                destinationAutocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('destination'),
                    { types: ['geocode'] }
                );
                
                listenForDrivers();
                listenForNotifications();
                
                document.getElementById('acceptReservation').onclick = acceptReservation;
                document.getElementById('rejectReservation').onclick = rejectReservation;
                
                mapInitialized = true;
                
            } catch (error) {
                console.error("Erro ao inicializar o mapa:", error);
                showNotification(t("map_error"), true);
            }
        }
        
        // Fun√ß√£o para centralizar o mapa
        function centerMap() {
            if (userLocation && map) {
                map.setCenter(userLocation);
                showNotification(t("map_centered"));
            } else {
                showNotification(t("location_unavailable"), true);
            }
        }
        
        function handleLocationError(browserHasGeolocation, pos) {
            showNotification(t("location_error"), true);
        }

        // Obter localiza√ß√£o atual
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        if (userMarker) {
                            userMarker.setPosition(userLocation);
                        }
                        if (map) {
                            map.setCenter(userLocation);
                        }
                        
                        const geocoder = new google.maps.Geocoder();
                        if (geocoder) {
                            geocoder.geocode({ location: userLocation }, (results, status) => {
                                if (status === "OK" && results[0]) {
                                    document.getElementById('origin').value = results[0].formatted_address;
                                }
                            });
                        }
                        
                        showNotification(t("location_updated"));
                    },
                    () => {
                        handleLocationError(true, map ? map.getCenter() : { lat: 38.7223, lng: -9.1393 });
                    }
                );
            }
        }
        
        // Escutar por motoristas online
        function listenForDrivers() {
            database.ref('drivers').on('value', (snapshot) => {
                const drivers = snapshot.val();
                let onlineDriversCount = 0;
                
                if (drivers) {
                    for (const driverId in drivers) {
                        const driver = drivers[driverId];
                        
                        if (driver.status === 'online' && driver.location && map) {
                            onlineDriversCount++;
                            
                            smoothMovement.updateCarPosition(
                                driverId,
                                driver.location,
                                driver.heading || 0
                            );
                        } else {
                            smoothMovement.removeCar(driverId);
                        }
                    }
                }
                
                smoothMovement.cars.forEach((car, carId) => {
                    if (!drivers || !drivers[carId] || drivers[carId].status !== 'online') {
                        smoothMovement.removeCar(carId);
                    }
                });
                
                updateOnlineDriversCounter(onlineDriversCount);
                
                if (onlineDriversCount > 0) {
                    document.getElementById('callTaxi').disabled = false;
                    document.getElementById('callTaxi').classList.add('active');
                } else {
                    document.getElementById('callTaxi').disabled = true;
                    document.getElementById('callTaxi').classList.remove('active');
                }
            });
        }
        
        // Atualizar contador de motoristas online
        function updateOnlineDriversCounter(count) {
            const counterElement = document.getElementById('onlineDriversCounter');
            const countElement = document.getElementById('driversCount');
            
            countElement.textContent = count;
            
            if (count > 0) {
                counterElement.style.display = 'block';
                counterElement.style.backgroundColor = count >= 3 ? '#4CAF50' : 
                                                     count === 2 ? '#ff9800' : 
                                                     '#f44336';
            } else {
                counterElement.style.display = 'none';
            }
        }
        
        // Escutar por notifica√ß√µes
        function listenForNotifications() {
            database.ref(`notifications/clients/${clientId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                
                if (notification.type === 'request_accepted') {
                    showNotification(notification.message);
                    showDriverInfo(notification.driverName);
                    snapshot.ref.remove();
                } else if (notification.type === 'request_rejected') {
                    showNotification(notification.message, true);
                    snapshot.ref.remove();
                } else if (notification.type === 'reservation_proposal') {
                    showReservationCard(notification);
                    snapshot.ref.remove();
                } else if (notification.type === 'reservation_accepted') {
                    showNotification(notification.message);
                    showDriverInfo(notification.driverName);
                    if (notification.reservationLocation) {
                        addReservationMarker(notification.reservationLocation);
                    }
                    snapshot.ref.remove();
                } else if (notification.type === 'reservation_rejected') {
                    showNotification(notification.message, true);
                    snapshot.ref.remove();
                }
            });
        }
        
        // Mostrar card de reserva
        function showReservationCard(notification) {
            const reservationCard = document.getElementById('reservationCard');
            const reservationDetails = document.getElementById('reservationDetails');
            
            window.currentReservation = notification;
            
            reservationDetails.innerHTML = `
                <p><strong>üöó ${t('driver')}:</strong> ${notification.driverName}</p>
                <p><strong>‚è∞ ${t('wait_time')}:</strong> ${notification.reservationTime} ${t('minutes')}</p>
                <p><strong>üìç ${t('meeting_point')}:</strong> ${notification.reservationLocationName}</p>
                <p><em>${t('driver_will_arrive')} ${notification.reservationTime} ${t('minutes')}.</em></p>
            `;
            
            reservationCard.style.display = 'block';
        }
        
        // Aceitar reserva
        function acceptReservation() {
            const reservationCard = document.getElementById('reservationCard');
            const reservation = window.currentReservation;
            
            if (!reservation) return;
            
            reservationCard.style.display = 'none';
            
            database.ref(`notifications/drivers/${reservation.driverId}`).push({
                type: 'reservation_accepted',
                message: `‚úÖ ${t('client_accepted_reservation')} ${reservation.reservationTime} ${t('minutes')}.`,
                clientId: clientId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            database.ref(`ride_requests/${reservation.requestId}`).update({
                status: 'reservation_accepted',
                reservationTime: reservation.reservationTime,
                acceptedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            showNotification(t("reservation_accepted"));
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            
            window.currentReservation = null;
        }
        
        // Rejeitar reserva
        function rejectReservation() {
            const reservationCard = document.getElementById('reservationCard');
            const reservation = window.currentReservation;
            
            if (!reservation) return;
            
            reservationCard.style.display = 'none';
            
            database.ref(`notifications/drivers/${reservation.driverId}`).push({
                type: 'reservation_rejected',
                message: `‚ùå ${t('client_rejected_reservation')}`,
                clientId: clientId,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            database.ref(`ride_requests/${reservation.requestId}`).update({
                status: 'reservation_rejected',
                rejectedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            showNotification(t("reservation_rejected"), true);
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
            
            window.currentReservation = null;
        }
        
        // Adicionar marcador de reserva no mapa
        function addReservationMarker(location) {
            if (reservationMarker) {
                reservationMarker.setMap(null);
            }
            
            if (map) {
                reservationMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    title: "Local de Encontro",
                    icon: {
                        url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
                    }
                });
                
                map.setCenter(location);
            }
        }
        
        // Mostrar informa√ß√µes do motorista
        function showDriverInfo(driverName) {
            const driverInfo = document.getElementById('driverInfo');
            const driverDetails = document.getElementById('driverDetails');
            
            driverDetails.textContent = `${t('driver')}: ${driverName}`;
            document.getElementById('estimatedTime').textContent = t("estimated_time");
            
            driverInfo.style.display = 'block';
        }
        
        // Mostrar notifica√ß√£o
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // PWA - Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(function(error) {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        // PWA - Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            setTimeout(() => {
                showInstallPrompt();
            }, 5000);
        });

        function showInstallPrompt() {
            const installPrompt = document.getElementById('installPrompt');
            installPrompt.style.display = 'block';

            document.getElementById('installBtn').addEventListener('click', async () => {
                installPrompt.style.display = 'none';
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        console.log('Usu√°rio aceitou a instala√ß√£o');
                    }
                    deferredPrompt = null;
                }
            });

            document.getElementById('cancelInstall').addEventListener('click', () => {
                installPrompt.style.display = 'none';
            });
        }

        // Carregar idioma salvo
        function loadSavedLanguage() {
            const savedLanguage = localStorage.getItem('preferredLanguage');
            if (savedLanguage && translations[savedLanguage]) {
                currentLanguage = savedLanguage;
                document.getElementById('languageSelector').value = savedLanguage;
            }
            updateTexts();
        }

        // Tratamento de erro do Google Maps
        window.gm_authFailure = function() {
            showNotification(t("auth_error"), true);
        };

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedLanguage();
        });
    </script>
    
    <!-- Google Maps API com fallback -->
    <script>
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBmc6HTJo70N_ueR1qFVgyu74v7FIl7dU4&callback=initMap&libraries=places';
            script.async = true;
            script.defer = true;
            script.onerror = function() {
                showNotification(t("map_error"), true);
            };
            document.head.appendChild(script);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGoogleMaps);
        } else {
            loadGoogleMaps();
        }
    </script>
</body>
</html>
