<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årea do Motorista - GoT√°xi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
        }
        
        header {
            background-color: #000;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo span {
            color: #ffc107;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-left: 20px;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        nav ul li a:hover {
            background-color: #333;
        }
        
        #map {
            height: calc(100vh - 60px);
            width: 100%;
            display: none;
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            gap: 10px;
        }
        
        .btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #e0a800;
        }
        
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
        }
        
        .notification.error {
            background-color: #f44336;
        }
        
        .request-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1002;
            display: none;
            width: 90%;
            max-width: 400px;
        }
        
        .request-card h3 {
            margin-bottom: 15px;
            text-align: center;
        }
        
        .request-details {
            margin-bottom: 20px;
        }
        
        .request-actions {
            display: flex;
            justify-content: space-between;
        }
        
        .btn-accept {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-reject {
            background-color: #f44336;
            color: white;
        }
        
        .btn-reserve {
            background-color: #2196F3;
            color: white;
        }
        
        .timer {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #f44336;
            font-size: 18px;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: calc(100vh - 60px);
            background-color: #f5f5f5;
        }
        
        .login-form {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .login-btn {
            background-color: #ffc107;
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        .login-btn:hover {
            background-color: #e0a800;
        }

        .driver-name-badge {
            position: absolute;
            top: 80px;
            right: 20px;
            background-color: #ffc107;
            color: #000;
            padding: 10px 15px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .reservation-card {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1003;
            display: none;
            width: 90%;
            max-width: 400px;
        }

        .reservation-card h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .reservation-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .reservation-option {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .reservation-option:hover {
            background-color: #e0e0e0;
        }

        .reservation-option.selected {
            background-color: #2196F3;
            color: white;
            font-weight: bold;
        }

        .reservation-actions {
            display: flex;
            justify-content: space-between;
        }

        .btn-confirm {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .distance-info {
            background-color: #e3f2fd;
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background-color: #f5f5f5;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tab.active {
            background-color: #ffc107;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .register-link {
            text-align: center;
            margin-top: 20px;
        }

        .register-link a {
            color: #2196F3;
            text-decoration: none;
        }

        .register-link a:hover {
            text-decoration: underline;
        }

        .success-message {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .profile-container {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: 85%;
            max-width: 320px;
            display: none;
        }

        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .profile-header h3 {
            margin: 0;
            font-size: 14px;
        }

        .profile-actions {
            display: flex;
            gap: 5px;
        }

        .profile-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        }

        .btn-close {
            background-color: #f44336;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit {
            background-color: #2196F3;
            color: white;
        }

        .btn-save {
            background-color: #4CAF50;
            color: white;
        }

        .btn-cancel {
            background-color: #f44336;
            color: white;
        }

        .profile-field {
            margin-bottom: 8px;
        }

        .profile-field label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            font-size: 11px;
            color: #555;
        }

        .profile-field input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .profile-field input:read-only {
            background-color: #f9f9f9;
            color: #666;
        }

        .profile-footer {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .support-container {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 85%;
            max-width: 350px;
            display: none;
            max-height: 450px;
            overflow-y: auto;
        }

        .support-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .support-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .support-content {
            padding: 10px 0;
        }

        .support-item {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }

        .support-item h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .support-item p {
            margin: 0;
            color: #666;
        }

        .support-contact {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        .support-contact a {
            color: #2196F3;
            text-decoration: none;
            font-weight: bold;
        }

        .support-contact a:hover {
            text-decoration: underline;
        }

        .reservation-response-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1005;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .reservation-response-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .reservation-response-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .reservation-response-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .reservation-response-title {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .reservation-response-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .reservation-accepted {
            color: #4CAF50;
        }

        .reservation-rejected {
            color: #f44336;
        }

        .already-accepted-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1006;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .already-accepted-popup.active {
            opacity: 1;
            visibility: visible;
        }

        .already-accepted-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .already-accepted-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #ff9800;
        }

        .already-accepted-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #ff9800;
        }

        .already-accepted-message {
            font-size: 16px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .priority-badge {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
        }

        /* Menu Animado do Perfil - AGORA COM 3 OP√á√ïES */
        .profile-menu-container {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background-color: #ffc107;
            color: #000;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 25px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: none;
            align-items: flex-start;
            justify-content: flex-start;
            overflow: visible;
        }

        .profile-menu-container.active {
            width: 160px;
            height: 180px; /* Aumentado para 3 op√ß√µes */
            border-radius: 12px;
        }

        .profile-menu-icon {
            transition: all 0.3s;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            background-color: #ffc107;
            border-radius: 25px;
        }

        .profile-menu-container.active .profile-menu-icon {
            transform: rotate(0deg);
            left: 55px;
        }

        .profile-menu-options {
            position: absolute;
            top: 55px;
            left: 0;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            gap: 8px;
            padding-top: 8px;
        }

        .profile-menu-container.active .profile-menu-options {
            opacity: 1;
            pointer-events: all;
        }

        .profile-menu-option {
            width: 90%;
            text-align: center;
            padding: 8px 0;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .profile-menu-option:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .profile-menu-option:active {
            transform: translateY(0);
        }

        /* Controles da Corrida */
        .ride-controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            gap: 10px;
        }

        .btn-go {
            background-color: #f44336;
            color: white;
        }

        .btn-go.active {
            background-color: #4CAF50;
        }

        .btn-stop {
            background-color: #2196F3;
            color: white;
        }

        /* Relat√≥rio de Corridas */
        .report-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1004;
            display: none;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }

        .report-header h3 {
            margin: 0;
        }

        .close-report {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .rides-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .ride-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .ride-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .ride-date {
            color: #666;
            font-size: 14px;
        }

        .ride-details p {
            margin: 5px 0;
        }

        .no-rides {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        /* Adicionando anima√ß√£o para a rota√ß√£o do mapa */
        .map-rotation-hint {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 999;
            animation: pulse 2s infinite;
            display: none;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Go<span>T√°xi</span></div>
        <nav>
            <ul>
                <li><a href="#" id="logoutBtn" style="display: none;">Sair</a></li>
            </ul>
        </nav>
    </header>
    
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <div class="tab-container">
                <div class="tab active" id="loginTab">Login</div>
                <div class="tab" id="registerTab">Registrar</div>
            </div>
            
            <div class="success-message" id="successMessage">
                ‚úÖ Registro realizado com sucesso! Fa√ßa login para continuar.
            </div>
            
            <div class="tab-content active" id="loginContent">
                <h2>Login do Motorista</h2>
                <div class="form-group">
                    <label for="username">Usu√°rio ou Email</label>
                    <input type="text" id="username" placeholder="Digite seu usu√°rio ou email">
                </div>
                <div class="form-group">
                    <label for="password">Senha</label>
                    <input type="password" id="password" placeholder="Digite sua senha">
                </div>
                <button class="login-btn" onclick="login()">Entrar</button>
                <div id="loginError" style="color: #f44336; text-align: center; margin-top: 15px; display: none;">
                    Usu√°rio ou senha incorretos!
                </div>
                <div class="register-link">
                    <a href="#" id="showRegister">N√£o tem conta? Registre-se</a>
                </div>
            </div>
            
            <div class="tab-content" id="registerContent">
                <h2>Registro de Motorista</h2>
                <div class="form-group">
                    <label for="regName">Nome Completo</label>
                    <input type="text" id="regName" placeholder="Digite seu nome completo">
                </div>
                <div class="form-group">
                    <label for="regUsername">Usu√°rio</label>
                    <input type="text" id="regUsername" placeholder="Escolha um nome de usu√°rio">
                </div>
                <div class="form-group">
                    <label for="regLicensePlate">Matr√≠cula do Ve√≠culo</label>
                    <input type="text" id="regLicensePlate" placeholder="Ex: AA-00-00">
                </div>
                <div class="form-group">
                    <label for="regNif">NIF</label>
                    <input type="text" id="regNif" placeholder="Digite seu NIF">
                </div>
                <div class="form-group">
                    <label for="regPassword">Senha</label>
                    <input type="password" id="regPassword" placeholder="Crie uma senha">
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">Confirmar Senha</label>
                    <input type="password" id="regConfirmPassword" placeholder="Confirme sua senha">
                </div>
                <button class="login-btn" onclick="register()">Registrar</button>
                <div id="registerError" style="color: #f44336; text-align: center; margin-top: 15px; display: none;">
                </div>
                <div class="register-link">
                    <a href="#" id="showLogin">J√° tem conta? Fa√ßa login</a>
                </div>
            </div>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="driver-name-badge" id="driverNameBadge" style="display: none;">
        Motorista: <span id="driverNameDisplay"></span>
    </div>

    <!-- Dica de rota√ß√£o do mapa -->
    <div class="map-rotation-hint" id="mapRotationHint">
        Use dois dedos para girar o mapa
    </div>

    <div class="profile-menu-container" id="profileMenuContainer" style="display: none;">
        <div class="profile-menu-icon" onclick="toggleProfileMenu()">üë§</div>
        <div class="profile-menu-options">
            <div class="profile-menu-option" onclick="showProfile()">Meu Perfil</div>
            <div class="profile-menu-option" onclick="showSupport()">Suporte</div>
            <div class="profile-menu-option" onclick="showReport()">üìä Relat√≥rio</div>
        </div>
    </div>
    
    <div class="profile-container" id="profileContainer">
        <div class="profile-header">
            <h3>üë§ Meu Perfil</h3>
            <div class="profile-actions">
                <button class="profile-btn btn-close" onclick="closeProfile()">√ó</button>
            </div>
        </div>
        <div class="profile-fields">
            <div class="profile-field">
                <label for="profileName">Nome Completo</label>
                <input type="text" id="profileName" readonly>
            </div>
            <div class="profile-field">
                <label for="profileUsername">Usu√°rio</label>
                <input type="text" id="profileUsername" readonly>
            </div>
            <div class="profile-field">
                <label for="profileLicensePlate">Matr√≠cula do Ve√≠culo</label>
                <input type="text" id="profileLicensePlate" readonly>
            </div>
            <div class="profile-field">
                <label for="profileNif">NIF</label>
                <input type="text" id="profileNif" readonly>
            </div>
            <div class="profile-field">
                <label for="profilePhone">Telefone</label>
                <input type="tel" id="profilePhone" readonly>
            </div>
        </div>
        <div class="profile-footer">
            <button class="profile-btn btn-edit" id="editProfileBtn" onclick="enableEditMode()">Editar</button>
            <button class="profile-btn btn-save" id="saveProfileBtn" onclick="saveProfile()" style="display: none;">Salvar</button>
            <button class="profile-btn btn-cancel" id="cancelEditBtn" onclick="disableEditMode()" style="display: none;">Cancelar</button>
        </div>
    </div>

    <div class="support-container" id="supportContainer">
        <div class="support-header">
            <h3>üìû Suporte T√©cnico</h3>
            <div class="profile-actions">
                <button class="profile-btn btn-close" onclick="closeSupport()">√ó</button>
            </div>
        </div>
        <div class="support-content">
            <div class="support-item">
                <h4>Telefone de Suporte</h4>
                <p>Contato via WhatsApp:</p>
                <div class="support-contact">
                    <a href="tel:351000000000">üìû +351 000 000 000</a>
                </div>
            </div>
            <div class="support-item">
                <h4>Email de Suporte</h4>
                <p>Envie email para n√≥s:</p>
                <div class="support-contact">
                    <a href="mailto:gotaxipt@hotmail.com">üìß gotaxipt@hotmail.com</a>
                </div>
            </div>
            <div class="support-item">
                <h4>Hor√°rio de Atendimento</h4>
                <p>Segunda a Sexta: 9:00 - 18:00</p>
                <p>S√°bado: 10:00 - 14:00</p>
                <p>Domingo: Fechado</p>
            </div>
            <div class="support-item">
                <h4>Emerg√™ncias</h4>
                <p>Para situa√ß√µes de emerg√™ncia durante o servi√ßo, utilize o telefone de suporte que funciona 24/7.</p>
            </div>
        </div>
    </div>

    <div id="reportContainer" class="report-container">
        <div class="report-header">
            <h3>üìä Relat√≥rio de Corridas</h3>
            <button class="close-report" onclick="closeReport()">√ó</button>
        </div>
        <div class="rides-list" id="ridesList">
        </div>
    </div>
    
    <div class="controls" id="controls">
        <button id="startTracking" class="btn">Iniciar Rastreamento</button>
        <button id="stopTracking" class="btn" disabled>Parar Rastreamento</button>
    </div>
    
    <div class="ride-controls" id="rideControls">
        <button id="goBtn" class="btn btn-go">Go</button>
        <button id="stopBtn" class="btn btn-stop">Stop</button>
    </div>
    
    <div id="notification" class="notification"></div>
    
    <div id="requestCard" class="request-card">
        <h3>üöï Nova Solicita√ß√£o de T√°xi</h3>
        <div class="timer" id="timer">120 segundos</div>
        <div class="distance-info" id="distanceInfo">
            üìç Calculando dist√¢ncia...
        </div>
        <div class="request-details" id="requestDetails">
        </div>
        <div class="request-actions">
            <button id="acceptRequest" class="btn btn-accept">‚úÖ Aceitar</button>
            <button id="reserveRequest" class="btn btn-reserve">‚è∞ Reserva</button>
            <button id="rejectRequest" class="btn btn-reject">‚ùå Rejeitar</button>
        </div>
    </div>

    <div id="reservationCard" class="reservation-card">
        <h3>‚è∞ Propor Reserva</h3>
        <div class="request-details" id="reservationRequestDetails">
        </div>
        <div class="reservation-options">
            <button class="reservation-option" data-time="10">10 min</button>
            <button class="reservation-option" data-time="15">15 min</button>
            <button class="reservation-option" data-time="20">20 min</button>
            <button class="reservation-option" data-time="30">30 min</button>
            <button class="reservation-option" data-time="40">40 min</button>
        </div>
        <div class="reservation-actions">
            <button id="sendReservation" class="btn btn-confirm" disabled>üì§ Enviar Reserva</button>
            <button id="cancelReservation" class="btn btn-cancel">‚ùå Cancelar</button>
        </div>
    </div>

    <div id="reservationResponsePopup" class="reservation-response-popup">
        <div class="reservation-response-content">
            <div class="reservation-response-icon" id="reservationResponseIcon">‚è∞</div>
            <h3 class="reservation-response-title" id="reservationResponseTitle">Resposta da Reserva</h3>
            <p class="reservation-response-message" id="reservationResponseMessage">
                Aguardando resposta do cliente...
            </p>
            <button class="btn" onclick="closeReservationResponse()" style="margin-top: 20px;">
                üè† Voltar para o Mapa
            </button>
        </div>
    </div>

    <div id="alreadyAcceptedPopup" class="already-accepted-popup">
        <div class="already-accepted-content">
            <div class="already-accepted-icon">‚è∞</div>
            <h3 class="already-accepted-title">Corrida J√° Aceita</h3>
            <p class="already-accepted-message" id="alreadyAcceptedMessage">
                Esta corrida j√° foi aceita por outro motorista.
            </p>
            <button class="btn" onclick="closeAlreadyAcceptedPopup()" style="margin-top: 20px;">
                OK
            </button>
        </div>
    </div>

    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
    </audio>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAZ4YqmOZz0wUlhBvuSD_fBLcwq1av8yc8",
            authDomain: "gotaxi-4e391.firebaseapp.com",
            databaseURL: "https://gotaxi-4e391-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "gotaxi-4e391",
            storageBucket: "gotaxi-4e391.firebasestorage.app",
            messagingSenderId: "597857194128",
            appId: "1:597857194128:web:9b550abd9b5e98bb374815"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let map;
        let marker;
        let watchId;
        let isTracking = false;
        let countdown;
        let currentDriver = null;
        let currentRequestId = null;
        let currentRequest = null;
        let directionsService;
        let directionsRenderer;
        let selectedReservationTime = null;
        let reservationMarker;
        let geocoder;
        let lastPosition = null;
        let isEditingProfile = false;
        let originalProfileData = {};
        let currentReservationRequestId = null;
        let backgroundWatchId = null;
        let clientMarker = null;
        let destinationMarker = null;
        let isRouteDisplayed = false;
        let currentRoute = null;
        let isRideGoing = false;
        let isRideAccepted = false;
        let currentRideId = null;
        let mapRotationInterval = null;
        let isMapRotationEnabled = false;
        let lastMapRotationUpdate = 0;
        let isTwoFingerGestureActive = false;
        let mapRotationHintTimeout = null;

        const DRIVERS_STORAGE_KEY = 'gotaxi_drivers';
        const RIDES_HISTORY_KEY = 'gotaxi_rides_history';
        const SESSION_STORAGE_KEY = 'gotaxi_driver_session';
        
        function initializeDriversStorage() {
            if (!localStorage.getItem(DRIVERS_STORAGE_KEY)) {
                const defaultDrivers = {
                    'mega': {
                        name: 'Mega',
                        username: 'mega',
                        password: '12345',
                        licensePlate: 'AA-00-00',
                        nif: '123456789',
                        phone: '+351 912 345 678',
                        driverId: 'mega'
                    },
                    'heitor': {
                        name: 'Heitor',
                        username: 'heitor',
                        password: '12345',
                        licensePlate: 'BB-11-11',
                        nif: '987654321',
                        phone: '+351 923 456 789',
                        driverId: 'heitor'
                    }
                };
                localStorage.setItem(DRIVERS_STORAGE_KEY, JSON.stringify(defaultDrivers));
            }
        }

        function getAllDrivers() {
            const drivers = localStorage.getItem(DRIVERS_STORAGE_KEY);
            return drivers ? JSON.parse(drivers) : {};
        }

        function saveDriver(driverData) {
            const drivers = getAllDrivers();
            drivers[driverData.driverId] = driverData;
            localStorage.setItem(DRIVERS_STORAGE_KEY, JSON.stringify(drivers));
            return true;
        }

        function userExists(username) {
            const drivers = getAllDrivers();
            for (const driverId in drivers) {
                if (drivers[driverId].username === username) {
                    return true;
                }
            }
            return false;
        }

        function saveRideToHistory(rideData) {
            let ridesHistory = JSON.parse(localStorage.getItem(RIDES_HISTORY_KEY) || '{}');
            
            if (!ridesHistory[currentDriver.driverId]) {
                ridesHistory[currentDriver.driverId] = [];
            }
            
            ridesHistory[currentDriver.driverId].unshift(rideData);
            
            if (ridesHistory[currentDriver.driverId].length > 100) {
                ridesHistory[currentDriver.driverId] = ridesHistory[currentDriver.driverId].slice(0, 100);
            }
            
            localStorage.setItem(RIDES_HISTORY_KEY, JSON.stringify(ridesHistory));
        }

        function getRidesHistory() {
            const ridesHistory = JSON.parse(localStorage.getItem(RIDES_HISTORY_KEY) || '{}');
            return ridesHistory[currentDriver.driverId] || [];
        }

        function saveDriverSession(driverData) {
            localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify({
                driverId: driverData.driverId,
                username: driverData.username,
                lastLogin: new Date().toISOString()
            }));
        }

        function getSavedSession() {
            const session = localStorage.getItem(SESSION_STORAGE_KEY);
            return session ? JSON.parse(session) : null;
        }

        function clearSession() {
            localStorage.removeItem(SESSION_STORAGE_KEY);
        }
        
        document.getElementById('showRegister').addEventListener('click', function(e) {
            e.preventDefault();
            switchToRegister();
        });
        
        document.getElementById('showLogin').addEventListener('click', function(e) {
            e.preventDefault();
            switchToLogin();
        });

        function switchToRegister() {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
            document.getElementById('loginContent').classList.remove('active');
            document.getElementById('registerContent').classList.add('active');
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('registerError').style.display = 'none';
        }

        function switchToLogin() {
            document.getElementById('registerTab').classList.remove('active');
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerContent').classList.remove('active');
            document.getElementById('loginContent').classList.add('active');
            document.getElementById('loginError').style.display = 'none';
        }
        
        function register() {
            const name = document.getElementById('regName').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            const licensePlate = document.getElementById('regLicensePlate').value.trim();
            const nif = document.getElementById('regNif').value.trim();
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const registerError = document.getElementById('registerError');
            
            registerError.style.display = 'none';
            registerError.textContent = '';
            
            if (!name || !username || !licensePlate || !nif || !password || !confirmPassword) {
                registerError.textContent = "Todos os campos s√£o obrigat√≥rios!";
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                registerError.textContent = "As senhas n√£o coincidem!";
                registerError.style.display = 'block';
                return;
            }
            
            if (password.length < 4) {
                registerError.textContent = "A senha deve ter pelo menos 4 caracteres!";
                registerError.style.display = 'block';
                return;
            }
            
            if (userExists(username)) {
                registerError.textContent = "Este nome de usu√°rio j√° est√° em uso!";
                registerError.style.display = 'block';
                return;
            }
            
            const driverId = 'driver_' + Date.now();
            
            const driverData = {
                name: name,
                username: username,
                licensePlate: licensePlate,
                nif: nif,
                password: password,
                driverId: driverId,
                phone: '',
                createdAt: new Date().toISOString(),
                status: 'offline'
            };
            
            try {
                saveDriver(driverData);
                console.log('Motorista registrado com sucesso:', driverId);
                
                document.getElementById('successMessage').style.display = 'block';
                
                document.getElementById('regName').value = '';
                document.getElementById('regUsername').value = '';
                document.getElementById('regLicensePlate').value = '';
                document.getElementById('regNif').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regConfirmPassword').value = '';
                
                setTimeout(() => {
                    switchToLogin();
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao registrar motorista:', error);
                registerError.textContent = "Erro ao registrar. Tente novamente.";
                registerError.style.display = 'block';
            }
        }
        
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            
            loginError.style.display = 'none';
            
            if (!username || !password) {
                loginError.textContent = "Por favor, preencha todos os campos!";
                loginError.style.display = 'block';
                return;
            }
            
            const drivers = getAllDrivers();
            let loginSuccess = false;
            let driverData = null;
            
            for (const driverId in drivers) {
                const driver = drivers[driverId];
                if (driver.username === username && driver.password === password) {
                    loginSuccess = true;
                    driverData = driver;
                    break;
                }
            }
            
            if (loginSuccess) {
                currentDriver = driverData;
                
                saveDriverSession(currentDriver);
                
                initializeDriverInterface();
                
            } else {
                loginError.textContent = "Usu√°rio ou senha incorretos!";
                loginError.style.display = 'block';
            }
        }

        function initializeDriverInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('driverNameBadge').style.display = 'block';
            document.getElementById('profileMenuContainer').style.display = 'flex';
            document.getElementById('driverNameDisplay').textContent = currentDriver.name;
            
            initMap();
            
            showNotification(`Bem-vindo, ${currentDriver.name}!`);
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            const savedSession = getSavedSession();
            if (savedSession && savedSession.driverId === currentDriver.driverId) {
                startTracking();
            }
        }
        
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (isTracking) {
                stopTracking();
            }
            
            if (backgroundWatchId) {
                navigator.geolocation.clearWatch(backgroundWatchId);
                backgroundWatchId = null;
            }
            
            if (isRideGoing) {
                stopRide();
            }
            
            clearSession();
            
            currentDriver = null;
            
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('map').style.display = 'none';
            document.getElementById('controls').style.display = 'none';
            document.getElementById('rideControls').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('driverNameBadge').style.display = 'none';
            document.getElementById('profileMenuContainer').style.display = 'none';
            document.getElementById('profileContainer').style.display = 'none';
            document.getElementById('supportContainer').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'none';
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        });
        
        function initMap() {
            const lisbon = { lat: 38.7223, lng: -9.1393 };
            
            // CORRE√á√ÉO PRINCIPAL: Configurar o mapa corretamente para permitir gestos
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 14,
                center: lisbon,
                // Configura√ß√µes para permitir todos os gestos
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_BOTTOM
                },
                // IMPORTANTE: Permitir inclina√ß√£o e rota√ß√£o
                tilt: 0, // Inicialmente sem inclina√ß√£o
                heading: 0, // Inicialmente apontando para o norte
                // Configura√ß√µes cr√≠ticas para gestos
                gestureHandling: 'greedy', // ou 'cooperative' para melhor experi√™ncia m√≥vel
                disableDefaultUI: false, // N√£o desabilitar UI padr√£o
                disableDoubleClickZoom: false, // Permitir zoom com duplo clique
                draggable: true, // Permitir arrastar
                scrollwheel: true, // Permitir rolagem do mouse
                keyboardShortcuts: true, // Atalhos de teclado
                rotateControl: true, // Mostrar controle de rota√ß√£o
                scaleControl: true, // Mostrar escala
                panControl: true, // Mostrar controle de pan
                isFractionalZoomEnabled: true, // Permitir zoom fracion√°rio
                restriction: null, // Sem restri√ß√µes
                // Configurar limites m√≠nimos/m√°ximos de zoom
                minZoom: 8,
                maxZoom: 20,
                // Configurar estilo (opcional)
                styles: [
                    {
                        "featureType": "all",
                        "elementType": "geometry.fill",
                        "stylers": [{"weight": "2.00"}]
                    },
                    {
                        "featureType": "all",
                        "elementType": "geometry.stroke",
                        "stylers": [{"color": "#9c9c9c"}]
                    }
                ]
            });
            
            // Adicionar evento para mostrar dica de rota√ß√£o
            map.addListener('dragstart', function(event) {
                if (event.domEvent && event.domEvent.touches && event.domEvent.touches.length >= 2) {
                    isTwoFingerGestureActive = true;
                    showMapRotationHint();
                }
            });
            
            map.addListener('dragend', function() {
                isTwoFingerGestureActive = false;
                hideMapRotationHint();
            });
            
            // Adicionar listener para detectar gesto de rota√ß√£o
            const mapDiv = document.getElementById('map');
            mapDiv.addEventListener('touchstart', handleTouchStart, {passive: true});
            mapDiv.addEventListener('touchmove', handleTouchMove, {passive: true});
            mapDiv.addEventListener('touchend', handleTouchEnd, {passive: true});
            
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: null,
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#4285f4',
                    strokeOpacity: 0.8,
                    strokeWeight: 6
                }
            });
            
            geocoder = new google.maps.Geocoder();
            
            marker = new google.maps.Marker({
                position: lisbon,
                map: map,
                title: `Motorista: ${currentDriver.name}`,
                icon: {
                    url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                    scaledSize: new google.maps.Size(40, 60),
                    anchor: new google.maps.Point(20, 20)
                },
                optimized: false // Para melhor performance com anima√ß√µes
            });
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        marker.setPosition(pos);
                        map.setCenter(pos);
                        lastPosition = pos;
                        
                        if (isTracking && currentDriver) {
                            database.ref(`drivers/${currentDriver.driverId}`).update({
                                location: pos,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                        }
                    },
                    () => {
                        handleLocationError(true, map.getCenter());
                    }
                );
            } else {
                handleLocationError(false, map.getCenter());
            }
            
            loadProfileData();
            setupReservationButtons();
            listenForReservationNotifications();
            setupRideControls();
        }
        
        // Fun√ß√µes para detectar gestos de toque
        let lastTouchDistance = null;
        
        function handleTouchStart(event) {
            if (event.touches.length >= 2) {
                const touch1 = event.touches[0];
                const touch2 = event.touches[1];
                lastTouchDistance = Math.hypot(
                    touch1.clientX - touch2.clientX,
                    touch1.clientY - touch2.clientY
                );
                isTwoFingerGestureActive = true;
                showMapRotationHint();
            }
        }
        
        function handleTouchMove(event) {
            if (event.touches.length >= 2 && isTwoFingerGestureActive) {
                const touch1 = event.touches[0];
                const touch2 = event.touches[1];
                const currentDistance = Math.hypot(
                    touch1.clientX - touch2.clientX,
                    touch1.clientY - touch2.clientY
                );
                
                // Detecta movimento de rota√ß√£o (os dedos se movem em arco)
                if (lastTouchDistance !== null) {
                    const delta = currentDistance - lastTouchDistance;
                    // Se os dedos est√£o se movendo em c√≠rculo, podemos detectar como rota√ß√£o
                    if (Math.abs(delta) < 10) {
                        // Movimento de rota√ß√£o detectado
                        showMapRotationHint();
                    }
                }
                
                lastTouchDistance = currentDistance;
            }
        }
        
        function handleTouchEnd() {
            lastTouchDistance = null;
            isTwoFingerGestureActive = false;
            setTimeout(() => {
                hideMapRotationHint();
            }, 2000);
        }
        
        function showMapRotationHint() {
            const hint = document.getElementById('mapRotationHint');
            hint.style.display = 'block';
            
            if (mapRotationHintTimeout) {
                clearTimeout(mapRotationHintTimeout);
            }
            
            mapRotationHintTimeout = setTimeout(() => {
                hideMapRotationHint();
            }, 3000);
        }
        
        function hideMapRotationHint() {
            const hint = document.getElementById('mapRotationHint');
            hint.style.display = 'none';
        }
        
        function setupRideControls() {
            document.getElementById('goBtn').addEventListener('click', startRide);
            document.getElementById('stopBtn').addEventListener('click', stopRide);
        }
        
        function startRide() {
            if (!isRideAccepted) {
                showNotification("Voc√™ precisa aceitar uma corrida primeiro!", true);
                return;
            }
            
            isRideGoing = true;
            document.getElementById('goBtn').classList.add('active');
            
            // Ativar rota√ß√£o do mapa se dispon√≠vel
            if (map.setTilt && map.setHeading) {
                enableMapRotation();
            }
            
            // Atualizar o marcador
            marker.setIcon({
                url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                scaledSize: new google.maps.Size(40, 60),
                anchor: new google.maps.Point(20, 20)
            });
            
            // Notificar o cliente que a corrida come√ßou
            if (currentRequest && currentRequest.clientId) {
                database.ref(`notifications/clients/${currentRequest.clientId}`).push({
                    type: 'ride_started',
                    message: `üöï A corrida come√ßou! Motorista ${currentDriver.name} est√° a caminho.`,
                    driverName: currentDriver.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            showNotification("üöó Viagem iniciada! O cliente foi notificado.");
        }
        
        function stopRide() {
            if (!isRideGoing) {
                showNotification("A viagem ainda n√£o come√ßou!", true);
                return;
            }
            
            isRideGoing = false;
            isRideAccepted = false;
            document.getElementById('goBtn').classList.remove('active');
            
            // Desativar rota√ß√£o do mapa
            disableMapRotation();
            
            document.getElementById('rideControls').style.display = 'none';
            document.getElementById('controls').style.display = 'flex';
            
            // Restaurar marcador
            marker.setIcon({
                url: "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png",
                scaledSize: new google.maps.Size(40, 60),
                anchor: new google.maps.Point(20, 20)
            });
            
            // Limpar rota e marcadores
            if (directionsRenderer) {
                directionsRenderer.setMap(null);
            }
            
            if (clientMarker) {
                clientMarker.setMap(null);
            }
            
            if (destinationMarker) {
                destinationMarker.setMap(null);
            }
            
            isRouteDisplayed = false;
            currentRoute = null;
            currentRequest = null;
            
            // Notificar o cliente que a corrida terminou
            if (currentRequest && currentRequest.clientId) {
                database.ref(`notifications/clients/${currentRequest.clientId}`).push({
                    type: 'ride_completed',
                    message: `‚úÖ Corrida finalizada! Obrigado por viajar com ${currentDriver.name}.`,
                    driverName: currentDriver.name,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
            
            showNotification("‚úÖ Viagem finalizada! Voc√™ est√° dispon√≠vel para novas corridas.");
        }
        
        function enableMapRotation() {
            if (isMapRotationEnabled) return;
            
            isMapRotationEnabled = true;
            
            try {
                // Configurar mapa para modo navega√ß√£o (se suportado)
                if (map.setTilt) {
                    map.setTilt(45); // Inclinar para perspectiva 3D
                }
                if (map.setZoom) {
                    map.setZoom(17); // Zoom mais pr√≥ximo
                }
                
                // Iniciar intervalo para atualizar rota√ß√£o com base na dire√ß√£o do marcador
                mapRotationInterval = setInterval(() => {
                    if (isRideGoing && lastPosition && marker) {
                        const currentTime = Date.now();
                        
                        // Atualizar a cada 500ms para suavidade
                        if (currentTime - lastMapRotationUpdate > 500) {
                            // Tentar obter rota√ß√£o do marcador
                            const icon = marker.getIcon();
                            if (icon && icon.rotation !== undefined && map.setHeading) {
                                // Girar mapa para seguir a dire√ß√£o do ve√≠culo
                                map.setHeading(icon.rotation);
                            }
                            
                            // Centralizar no marcador
                            if (map.setCenter && marker.getPosition()) {
                                map.setCenter(marker.getPosition());
                            }
                            
                            lastMapRotationUpdate = currentTime;
                        }
                    }
                }, 100);
                
                console.log("Modo navega√ß√£o ativado");
                
            } catch (error) {
                console.warn("Recursos de rota√ß√£o do mapa n√£o dispon√≠veis:", error);
                isMapRotationEnabled = false;
            }
        }
        
        function disableMapRotation() {
            if (!isMapRotationEnabled) return;
            
            isMapRotationEnabled = false;
            
            // Parar intervalo de rota√ß√£o
            if (mapRotationInterval) {
                clearInterval(mapRotationInterval);
                mapRotationInterval = null;
            }
            
            try {
                // Restaurar configura√ß√µes normais do mapa
                if (map.setTilt) {
                    map.setTilt(0); // Voltar √† vista 2D
                }
                if (map.setHeading) {
                    map.setHeading(0); // Voltar ao norte
                }
                if (map.setZoom) {
                    map.setZoom(14); // Zoom padr√£o
                }
                
                console.log("Modo navega√ß√£o desativado");
                
            } catch (error) {
                console.warn("Erro ao restaurar mapa:", error);
            }
        }
        
        function handleLocationError(browserHasGeolocation, pos) {
            console.log(
                browserHasGeolocation
                    ? "Erro: O servi√ßo de geolocaliza√ß√£o falhou."
                    : "Erro: Seu navegador n√£o suporta geolocaliza√ß√£o."
            );
            
            showNotification("N√£o foi poss√≠vel obter sua localiza√ß√£o.", true);
        }
        
        function loadProfileData() {
            if (!currentDriver) return;
            
            document.getElementById('profileName').value = currentDriver.name || '';
            document.getElementById('profileUsername').value = currentDriver.username || '';
            document.getElementById('profileLicensePlate').value = currentDriver.licensePlate || '';
            document.getElementById('profileNif').value = currentDriver.nif || '';
            document.getElementById('profilePhone').value = currentDriver.phone || '';
            
            originalProfileData = {
                name: currentDriver.name || '',
                licensePlate: currentDriver.licensePlate || '',
                nif: currentDriver.nif || '',
                phone: currentDriver.phone || ''
            };
        }
        
        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenuContainer');
            menu.classList.toggle('active');
            
            // Se o menu est√° fechando (n√£o tem classe active)
            if (!menu.classList.contains('active')) {
                // Fecha todos os pain√©is sem mostrar notifica√ß√£o
                closeAllPanelsSilently();
            }
        }
        
        function showProfile() {
            closeAllPanelsSilently();
            document.getElementById('profileContainer').style.display = 'block';
        }
        
        function closeProfile() {
            if (isEditingProfile) {
                // Se estava editando, cancelar a edi√ß√£o
                disableEditMode();
            } else {
                // Se n√£o estava editando, apenas fechar
                document.getElementById('profileContainer').style.display = 'none';
                document.getElementById('profileMenuContainer').classList.remove('active');
            }
        }
        
        function showSupport() {
            closeAllPanelsSilently();
            document.getElementById('supportContainer').style.display = 'block';
        }
        
        function closeSupport() {
            document.getElementById('supportContainer').style.display = 'none';
            document.getElementById('profileMenuContainer').classList.remove('active');
        }
        
        function showReport() {
            closeAllPanelsSilently();
            
            const rides = getRidesHistory();
            const ridesList = document.getElementById('ridesList');
            
            if (rides.length === 0) {
                ridesList.innerHTML = '<div class="no-rides">Nenhuma corrida realizada ainda.</div>';
            } else {
                let html = '';
                rides.forEach((ride, index) => {
                    html += `
                        <div class="ride-item">
                            <div class="ride-item-header">
                                <span>Corrida #${index + 1}</span>
                                <span class="ride-date">${ride.date || 'Data n√£o dispon√≠vel'}</span>
                            </div>
                            <div class="ride-details">
                                <p><strong>Cliente:</strong> ${ride.clientName || 'N√£o informado'}</p>
                                <p><strong>Origem:</strong> ${ride.origin || 'N√£o informado'}</p>
                                <p><strong>Destino:</strong> ${ride.destination || 'N√£o informado'}</p>
                                <p><strong>Passageiros:</strong> ${ride.passengers || '1'}</p>
                                <p><strong>Contato:</strong> ${ride.contact || 'N√£o informado'}</p>
                                ${ride.reservationTime ? `<p><strong>Tempo de Reserva:</strong> ${ride.reservationTime} minutos</p>` : ''}
                                ${ride.type ? `<p><strong>Tipo:</strong> ${ride.type === 'reservation' ? 'Reserva' : 'Corrida Normal'}</p>` : ''}
                            </div>
                        </div>
                    `;
                });
                ridesList.innerHTML = html;
            }
            
            document.getElementById('reportContainer').style.display = 'block';
        }
        
        function closeReport() {
            document.getElementById('reportContainer').style.display = 'none';
            document.getElementById('profileMenuContainer').classList.remove('active');
        }
        
        function closeAllPanels() {
            document.getElementById('profileContainer').style.display = 'none';
            document.getElementById('supportContainer').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'none';
            if (isEditingProfile) {
                disableEditMode();
            }
        }
        
        function closeAllPanelsSilently() {
            document.getElementById('profileContainer').style.display = 'none';
            document.getElementById('supportContainer').style.display = 'none';
            document.getElementById('reportContainer').style.display = 'none';
            if (isEditingProfile) {
                silentDisableEditMode();
            }
        }
        
        function enableEditMode() {
            isEditingProfile = true;
            
            document.getElementById('profileName').readOnly = false;
            document.getElementById('profileLicensePlate').readOnly = false;
            document.getElementById('profileNif').readOnly = false;
            document.getElementById('profilePhone').readOnly = false;
            
            document.getElementById('profileName').style.backgroundColor = '#fff';
            document.getElementById('profileLicensePlate').style.backgroundColor = '#fff';
            document.getElementById('profileNif').style.backgroundColor = '#fff';
            document.getElementById('profilePhone').style.backgroundColor = '#fff';
            
            document.getElementById('editProfileBtn').style.display = 'none';
            document.getElementById('saveProfileBtn').style.display = 'block';
            document.getElementById('cancelEditBtn').style.display = 'block';
            
            showNotification("Modo de edi√ß√£o ativado. Fa√ßa suas altera√ß√µes e clique em Salvar.");
        }
        
        function disableEditMode() {
            isEditingProfile = false;
            
            document.getElementById('profileName').readOnly = true;
            document.getElementById('profileLicensePlate').readOnly = true;
            document.getElementById('profileNif').readOnly = true;
            document.getElementById('profilePhone').readOnly = true;
            
            document.getElementById('profileName').style.backgroundColor = '#f9f9f9';
            document.getElementById('profileLicensePlate').style.backgroundColor = '#f9f9f9';
            document.getElementById('profileNif').style.backgroundColor = '#f9f9f9';
            document.getElementById('profilePhone').style.backgroundColor = '#f9f9f9';
            
            document.getElementById('editProfileBtn').style.display = 'block';
            document.getElementById('saveProfileBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            if (originalProfileData) {
                document.getElementById('profileName').value = originalProfileData.name;
                document.getElementById('profileLicensePlate').value = originalProfileData.licensePlate;
                document.getElementById('profileNif').value = originalProfileData.nif;
                document.getElementById('profilePhone').value = originalProfileData.phone;
            }
            
            showNotification("Edi√ß√£o cancelada.");
        }
        
        function silentDisableEditMode() {
            isEditingProfile = false;
            
            document.getElementById('profileName').readOnly = true;
            document.getElementById('profileLicensePlate').readOnly = true;
            document.getElementById('profileNif').readOnly = true;
            document.getElementById('profilePhone').readOnly = true;
            
            document.getElementById('profileName').style.backgroundColor = '#f9f9f9';
            document.getElementById('profileLicensePlate').style.backgroundColor = '#f9f9f9';
            document.getElementById('profileNif').style.backgroundColor = '#f9f9f9';
            document.getElementById('profilePhone').style.backgroundColor = '#f9f9f9';
            
            document.getElementById('editProfileBtn').style.display = 'block';
            document.getElementById('saveProfileBtn').style.display = 'none';
            document.getElementById('cancelEditBtn').style.display = 'none';
            
            if (originalProfileData) {
                document.getElementById('profileName').value = originalProfileData.name;
                document.getElementById('profileLicensePlate').value = originalProfileData.licensePlate;
                document.getElementById('profileNif').value = originalProfileData.nif;
                document.getElementById('profilePhone').value = originalProfileData.phone;
            }
        }
        
        function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const licensePlate = document.getElementById('profileLicensePlate').value.trim();
            const nif = document.getElementById('profileNif').value.trim();
            const phone = document.getElementById('profilePhone').value.trim();
            
            if (!name) {
                showNotification("O nome √© obrigat√≥rio!", true);
                return;
            }
            
            if (!licensePlate) {
                showNotification("A matr√≠cula √© obrigat√≥ria!", true);
                return;
            }
            
            if (!nif) {
                showNotification("O NIF √© obrigat√≥rio!", true);
                return;
            }
            
            currentDriver.name = name;
            currentDriver.licensePlate = licensePlate;
            currentDriver.nif = nif;
            currentDriver.phone = phone;
            
            const drivers = getAllDrivers();
            drivers[currentDriver.driverId] = currentDriver;
            localStorage.setItem(DRIVERS_STORAGE_KEY, JSON.stringify(drivers));
            
            originalProfileData = {
                name: name,
                licensePlate: licensePlate,
                nif: nif,
                phone: phone
            };
            
            document.getElementById('driverNameDisplay').textContent = currentDriver.name;
            
            if (isTracking && currentDriver) {
                database.ref(`drivers/${currentDriver.driverId}`).update({
                    name: currentDriver.name,
                    licensePlate: currentDriver.licensePlate
                });
            }
            
            disableEditMode();
            
            showNotification("Perfil atualizado com sucesso!");
        }
        
        function setupReservationButtons() {
            document.getElementById("reserveRequest").addEventListener("click", function() {
                showReservationCard();
            });
            
            document.querySelectorAll('.reservation-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.reservation-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    selectedReservationTime = this.getAttribute('data-time');
                    
                    document.getElementById('sendReservation').disabled = false;
                });
            });
            
            document.getElementById('sendReservation').addEventListener('click', sendReservation);
            
            document.getElementById('cancelReservation').addEventListener('click', function() {
                document.getElementById('reservationCard').style.display = 'none';
                document.getElementById('requestCard').style.display = 'none';
                clearInterval(countdown);
                currentRequestId = null;
                currentRequest = null;
            });
        }
        
        function startTracking() {
            if (!navigator.geolocation) {
                showNotification("Seu navegador n√£o suporta geolocaliza√ß√£o.", true);
                return;
            }
            
            isTracking = true;
            document.getElementById("startTracking").disabled = true;
            document.getElementById("stopTracking").disabled = false;
            
            showNotification("Agora voc√™ est√° vis√≠vel para os clientes!");
            
            database.ref(`drivers/${currentDriver.driverId}`).update({
                name: currentDriver.name,
                licensePlate: currentDriver.licensePlate,
                status: 'online',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            startBackgroundTracking();
            
            listenForRequests();
        }
        
        function calculateHeading(from, to) {
            const lat1 = from.lat * Math.PI / 180;
            const lon1 = from.lng * Math.PI / 180;
            const lat2 = to.lat * Math.PI / 180;
            const lon2 = to.lng * Math.PI / 180;
            
            const y = Math.sin(lon2 - lon1) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                      Math.sin(lat1) * Math.cos(lat2) * Math.cos(lon2 - lon1);
            let brng = Math.atan2(y, x) * 180 / Math.PI;
            return (brng + 360) % 360;
        }
        
        function calculateStraightDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }
        
        function listenForRequests() {
            database.ref(`notifications/drivers/${currentDriver.driverId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                const notificationId = snapshot.key;
                
                console.log('Nova notifica√ß√£o recebida:', notification);
                
                if (notification.type === 'new_request') {
                    processDriverSpecificRequest(notification, notificationId);
                } else if (notification.type === 'new_request_all') {
                    processGeneralRequest(notification, notificationId);
                }
            });
            
            cleanupOldNotifications();
        }

        function processDriverSpecificRequest(notification, notificationId) {
            database.ref(`ride_requests/${notification.requestId}`).once('value').then((snapshot) => {
                const request = snapshot.val();
                
                if (request) {
                    if (request.status === 'accepted' && request.driverId !== currentDriver.driverId) {
                        showAlreadyAcceptedPopup();
                        database.ref(`notifications/drivers/${currentDriver.driverId}/${notificationId}`).remove();
                        return;
                    }
                    
                    if (request.status === 'pending') {
                        playNotificationSound();
                        showRequestCard(request, notification.requestId, true);
                        database.ref(`notifications/drivers/${currentDriver.driverId}/${notificationId}`).remove();
                    }
                }
            });
        }

        function processGeneralRequest(notification, notificationId) {
            database.ref(`ride_requests/${notification.requestId}`).once('value').then((snapshot) => {
                const request = snapshot.val();
                
                if (request) {
                    if (request.status === 'accepted') {
                        showAlreadyAcceptedPopup();
                        database.ref(`notifications/drivers/${currentDriver.driverId}/${notificationId}`).remove();
                        return;
                    }
                    
                    if (request && request.status === 'pending') {
                        if (request.assignedDriverId && request.assignedDriverId !== currentDriver.driverId) {
                            console.log('Solicita√ß√£o j√° atribu√≠da a outro motorista:', request.assignedDriverId);
                            return;
                        }
                        
                        if (request.clientLocation && lastPosition) {
                            const distance = calculateStraightDistance(
                                lastPosition.lat,
                                lastPosition.lng,
                                request.clientLocation.lat,
                                request.clientLocation.lng
                            );
                            
                            if (distance > 10) {
                                console.log('Motorista muito longe do cliente:', distance, 'km');
                                return;
                            }
                        }
                        
                        playNotificationSound();
                        showRequestCard(request, notification.requestId, false);
                        database.ref(`notifications/drivers/${currentDriver.driverId}/${notificationId}`).remove();
                    }
                }
            });
        }

        function cleanupOldNotifications() {
            const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
            
            database.ref(`notifications/drivers/${currentDriver.driverId}`).once('value').then((snapshot) => {
                const notifications = snapshot.val();
                
                if (!notifications) return;
                
                for (const notificationId in notifications) {
                    const notification = notifications[notificationId];
                    
                    if (notification.timestamp && notification.timestamp < tenMinutesAgo) {
                        database.ref(`notifications/drivers/${currentDriver.driverId}/${notificationId}`).remove();
                    }
                }
            });
        }

        function showAlreadyAcceptedPopup() {
            const popup = document.getElementById('alreadyAcceptedPopup');
            const message = document.getElementById('alreadyAcceptedMessage');
            
            message.textContent = 'Esta corrida j√° foi aceita por outro motorista.';
            
            popup.classList.add('active');
            
            setTimeout(() => {
                closeAlreadyAcceptedPopup();
            }, 3000);
        }

        function closeAlreadyAcceptedPopup() {
            document.getElementById('alreadyAcceptedPopup').classList.remove('active');
        }

        function showRequestCard(request, requestId, isPriority = false) {
            const requestCard = document.getElementById('requestCard');
            const requestDetails = document.getElementById('requestDetails');
            const timerElement = document.getElementById('timer');
            const distanceInfo = document.getElementById('distanceInfo');
            
            currentRequestId = requestId;
            currentRequest = request;
            
            database.ref(`ride_requests/${requestId}`).once('value').then((snapshot) => {
                const updatedRequest = snapshot.val();
                
                if (updatedRequest && updatedRequest.status === 'accepted' && updatedRequest.driverId !== currentDriver.driverId) {
                    showAlreadyAcceptedPopup();
                    return;
                }
                
                const priorityBadge = isPriority ? 
                    '<div class="priority-badge">üöó VOC√ä √â O MOTORISTA MAIS PR√ìXIMO!</div>' : 
                    '';
                
                if (request.clientLocation && lastPosition) {
                    const distance = calculateStraightDistance(
                        lastPosition.lat,
                        lastPosition.lng,
                        request.clientLocation.lat,
                        request.clientLocation.lng
                    );
                    
                    distanceInfo.innerHTML = `${priorityBadge}üìç Dist√¢ncia do cliente: <strong>${distance.toFixed(1)} km</strong>`;
                } else {
                    distanceInfo.innerHTML = `${priorityBadge}üìç Dist√¢ncia: N√£o dispon√≠vel`;
                }
                
                requestDetails.innerHTML = `
                    <p><strong>üë§ Cliente:</strong> ${request.name || 'N√£o informado'}</p>
                    <p><strong>üìç De:</strong> ${request.origin}</p>
                    <p><strong>üéØ Para:</strong> ${request.destination}</p>
                    <p><strong>üë• Passageiros:</strong> ${request.passengers || '1'}</p>
                    <p><strong>üìû Contato:</strong> ${request.contact || 'N√£o informado'}</p>
                    <p><strong>‚è∞ Chegada:</strong> ${request.arrivalTime || '10'} minutos</p>
                    <p><strong>üí≥ Pagamento:</strong> ${getPaymentMethodText(request.paymentMethod)}</p>
                    ${request.notes ? `<p><strong>üìù Observa√ß√µes:</strong> ${request.notes}</p>` : ''}
                `;
                
                requestCard.style.display = 'block';
                
                let timeLeft = 120;
                updateTimerDisplay(timerElement, timeLeft);
                
                countdown = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay(timerElement, timeLeft);
                    
                    if (timeLeft <= 0) {
                        clearInterval(countdown);
                        rejectRequest(requestId);
                    }
                }, 1000);
                
                document.getElementById('acceptRequest').onclick = () => acceptRequest(requestId, request);
                document.getElementById('rejectRequest').onclick = () => rejectRequest(requestId);
            });
        }
        
        function calculateDistance(originAddress) {
            return new Promise((resolve, reject) => {
                const driverLocation = marker.getPosition();
                
                geocoder.geocode({ address: originAddress }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const originLocation = results[0].geometry.location;
                        
                        const distanceInKm = calculateStraightDistance(
                            driverLocation.lat(),
                            driverLocation.lng(),
                            originLocation.lat(),
                            originLocation.lng()
                        );
                        
                        resolve(`${distanceInKm.toFixed(1)} km`);
                    } else {
                        directionsService.route({
                            origin: driverLocation,
                            destination: originAddress,
                            travelMode: google.maps.TravelMode.DRIVING
                        }, (response, status) => {
                            if (status === 'OK') {
                                const route = response.routes[0];
                                const distanceInMeters = route.legs[0].distance.value;
                                const distanceInKm = (distanceInMeters / 1000).toFixed(1);
                                resolve(`${distanceInKm} km`);
                            } else {
                                reject('N√£o foi poss√≠vel calcular a dist√¢ncia');
                            }
                        });
                    }
                });
            });
        }
        
        function updateTimerDisplay(timerElement, timeLeft) {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 30) {
                timerElement.style.color = '#f44336';
                timerElement.style.fontWeight = 'bold';
            } else if (timeLeft <= 60) {
                timerElement.style.color = '#ff9800';
            } else {
                timerElement.style.color = '#4CAF50';
            }
        }
        
        function showReservationCard() {
            const reservationCard = document.getElementById('reservationCard');
            const reservationDetails = document.getElementById('reservationRequestDetails');
            
            reservationDetails.innerHTML = `
                <p><strong>üë§ Cliente:</strong> ${currentRequest.name || 'N√£o informado'}</p>
                <p><strong>üìç De:</strong> ${currentRequest.origin}</p>
                <p><strong>üéØ Para:</strong> ${currentRequest.destination}</p>
            `;
            
            selectedReservationTime = null;
            document.querySelectorAll('.reservation-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.getElementById('sendReservation').disabled = true;
            
            reservationCard.style.display = 'block';
        }
        
        function sendReservation() {
            if (!selectedReservationTime) {
                showNotification("Selecione um tempo de reserva.", true);
                return;
            }
            
            clearInterval(countdown);
            
            const driverLocation = marker.getPosition();
            
            geocoder.geocode({ location: driverLocation }, (results, status) => {
                let locationName = "Local pr√≥ximo";
                
                if (status === "OK" && results[0]) {
                    locationName = results[0].formatted_address;
                }
                
                if (currentRequest.clientId) {
                    database.ref(`notifications/clients/${currentRequest.clientId}`).push({
                        type: 'reservation_proposal',
                        message: `‚è∞ O motorista ${currentDriver.name} prop√µe uma reserva de ${selectedReservationTime} minutos.`,
                        driverName: currentDriver.name,
                        driverId: currentDriver.driverId,
                        licensePlate: currentDriver.licensePlate,
                        reservationTime: selectedReservationTime,
                        reservationLocation: {
                            lat: driverLocation.lat(),
                            lng: driverLocation.lng()
                        },
                        reservationLocationName: locationName,
                        requestId: currentRequestId,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    console.log('Notifica√ß√£o de reserva enviada para o cliente:', currentRequest.clientId);
                    
                    database.ref(`ride_requests/${currentRequestId}`).update({
                        status: 'reservation_proposed',
                        reservationTime: selectedReservationTime,
                        driverId: currentDriver.driverId,
                        driverName: currentDriver.name,
                        licensePlate: currentDriver.licensePlate,
                        proposedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    document.getElementById('reservationCard').style.display = 'none';
                    document.getElementById('requestCard').style.display = 'none';
                    
                    showReservationResponsePopup('waiting');
                    
                    currentReservationRequestId = currentRequestId;
                    
                    listenForReservationResponse();
                    
                    currentRequestId = null;
                    currentRequest = null;
                    
                } else {
                    console.warn('Cliente ID n√£o encontrado na solicita√ß√£o');
                    showNotification("Erro: ID do cliente n√£o encontrado.", true);
                }
            });
        }
        
        function listenForReservationNotifications() {
            database.ref(`notifications/drivers/${currentDriver.driverId}`).on('child_added', (snapshot) => {
                const notification = snapshot.val();
                
                if (notification.type === 'reservation_accepted') {
                    showNotification(notification.message);
                    
                    if (notification.reservationLocation) {
                        addReservationMarker(notification.reservationLocation);
                    }
                    
                    snapshot.ref.remove();
                } else if (notification.type === 'reservation_rejected') {
                    showNotification(notification.message, true);
                    snapshot.ref.remove();
                }
            });
        }
        
        function listenForReservationResponse() {
            if (!currentReservationRequestId) return;
            
            database.ref(`ride_requests/${currentReservationRequestId}`).on('value', (snapshot) => {
                const request = snapshot.val();
                
                if (request) {
                    if (request.status === 'reservation_accepted') {
                        showReservationResponsePopup('accepted');
                        
                        const rideData = {
                            clientName: request.name,
                            origin: request.origin,
                            destination: request.destination,
                            passengers: request.passengers,
                            contact: request.contact,
                            date: new Date().toLocaleString('pt-PT'),
                            timestamp: Date.now(),
                            type: 'reservation',
                            reservationTime: request.reservationTime
                        };
                        
                        saveRideToHistory(rideData);
                        
                        database.ref(`ride_requests/${currentReservationRequestId}`).off();
                        currentReservationRequestId = null;
                        
                    } else if (request.status === 'reservation_rejected') {
                        showReservationResponsePopup('rejected');
                        
                        database.ref(`ride_requests/${currentReservationRequestId}`).off();
                        currentReservationRequestId = null;
                    }
                }
            });
        }
        
        function showReservationResponsePopup(status) {
            const popup = document.getElementById('reservationResponsePopup');
            const icon = document.getElementById('reservationResponseIcon');
            const title = document.getElementById('reservationResponseTitle');
            const message = document.getElementById('reservationResponseMessage');
            
            switch(status) {
                case 'waiting':
                    icon.textContent = '‚è∞';
                    icon.style.color = '#ff9800';
                    title.textContent = 'Aguardando Resposta';
                    title.className = 'reservation-response-title';
                    message.textContent = 'Sua proposta de reserva foi enviada ao cliente. Aguardando resposta...';
                    break;
                    
                case 'accepted':
                    icon.textContent = '‚úÖ';
                    icon.style.color = '#4CAF50';
                    title.textContent = 'Reserva Aceita!';
                    title.className = 'reservation-response-title reservation-accepted';
                    message.textContent = 'O cliente aceitou sua proposta de reserva! A corrida foi confirmada.';
                    break;
                    
                case 'rejected':
                    icon.textContent = '‚ùå';
                    icon.style.color = '#f44336';
                    title.textContent = 'Reserva Rejeitada';
                    title.className = 'reservation-response-title reservation-rejected';
                    message.textContent = 'O cliente rejeitou sua proposta de reserva.';
                    break;
            }
            
            popup.classList.add('active');
        }
        
        function closeReservationResponse() {
            document.getElementById('reservationResponsePopup').classList.remove('active');
        }
        
        function addReservationMarker(location) {
            if (reservationMarker) {
                reservationMarker.setMap(null);
            }
            
            reservationMarker = new google.maps.Marker({
                position: location,
                map: map,
                title: "Local de Encontro com Cliente",
                icon: {
                    url: "https://maps.google.com/mapfiles/ms/icons/green-dot.png"
                }
            });
            
            map.setCenter(location);
        }
        
        function acceptRequest(requestId, request) {
            database.ref(`ride_requests/${requestId}`).once('value').then((snapshot) => {
                const updatedRequest = snapshot.val();
                
                if (updatedRequest && updatedRequest.status === 'accepted') {
                    showAlreadyAcceptedPopup();
                    
                    document.getElementById('requestCard').style.display = 'none';
                    clearInterval(countdown);
                    currentRequestId = null;
                    currentRequest = null;
                    return;
                }
                
                clearInterval(countdown);
                
                const rideData = {
                    clientName: request.name,
                    origin: request.origin,
                    destination: request.destination,
                    passengers: request.passengers,
                    contact: request.contact,
                    date: new Date().toLocaleString('pt-PT'),
                    timestamp: Date.now()
                };
                
                saveRideToHistory(rideData);
                
                database.ref(`ride_requests/${requestId}`).update({
                    status: 'accepted',
                    driverId: currentDriver.driverId,
                    driverName: currentDriver.name,
                    licensePlate: currentDriver.licensePlate,
                    acceptedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                document.getElementById('requestCard').style.display = 'none';
                
                showNotification("‚úÖ Voc√™ aceitou a solicita√ß√£o!");
                
                // Mostrar controles da corrida
                isRideAccepted = true;
                document.getElementById('controls').style.display = 'none';
                document.getElementById('rideControls').style.display = 'flex';
                
                if (request.clientId) {
                    database.ref(`notifications/clients/${request.clientId}`).push({
                        type: 'request_accepted',
                        message: `üéâ Seu t√°xi foi aceito! Motorista: ${currentDriver.name} est√° a caminho.`,
                        driverName: currentDriver.name,
                        licensePlate: currentDriver.licensePlate,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                
                // Mostrar rota, marcador do cliente e marcador do destino
                displayRouteAndMarkers(request);
                
                currentRequestId = null;
                currentRequest = request;
            });
        }
        
        function displayRouteAndMarkers(request) {
            if (!request || !request.origin || !request.destination) {
                console.error('Dados de origem ou destino n√£o dispon√≠veis');
                return;
            }
            
            // Limpar rota anterior se existir
            if (directionsRenderer) {
                directionsRenderer.setMap(null);
            }
            
            // Limpar marcadores anteriores se existirem
            if (clientMarker) {
                clientMarker.setMap(null);
            }
            
            if (destinationMarker) {
                destinationMarker.setMap(null);
            }
            
            // Primeiro, obter coordenadas da origem (local do cliente)
            geocoder.geocode({ address: request.origin }, (originResults, originStatus) => {
                if (originStatus === 'OK' && originResults[0]) {
                    const clientLocation = originResults[0].geometry.location;
                    
                    // Adicionar marcador vermelho do Google no local do cliente
                    clientMarker = new google.maps.Marker({
                        position: clientLocation,
                        map: map,
                        title: "Local do Cliente",
                        icon: {
                            url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
                            scaledSize: new google.maps.Size(32, 32)
                        }
                    });
                    
                    // Depois, obter coordenadas do destino
                    geocoder.geocode({ address: request.destination }, (destinationResults, destinationStatus) => {
                        if (destinationStatus === 'OK' && destinationResults[0]) {
                            const destinationLocation = destinationResults[0].geometry.location;
                            
                            // Adicionar marcador azul do Google no destino
                            destinationMarker = new google.maps.Marker({
                                position: destinationLocation,
                                map: map,
                                title: "Destino",
                                icon: {
                                    url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png",
                                    scaledSize: new google.maps.Size(32, 32)
                                }
                            });
                            
                            // Calcular e exibir rota da origem ao destino
                            calculateAndDisplayRoute(clientLocation, destinationLocation);
                            
                        } else {
                            console.error('Erro ao geocodificar destino:', destinationStatus);
                            showNotification("N√£o foi poss√≠vel obter localiza√ß√£o do destino. A rota n√£o ser√° exibida.", true);
                        }
                    });
                    
                } else {
                    console.error('Erro ao geocodificar origem do cliente:', originStatus);
                    showNotification("N√£o foi poss√≠vel obter localiza√ß√£o do cliente. A rota n√£o ser√° exibida.", true);
                }
            });
        }
        
        function calculateAndDisplayRoute(origin, destination) {
            const request = {
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            };
            
            directionsService.route(request, (result, status) => {
                if (status === 'OK') {
                    // Salvar a rota atual
                    currentRoute = result;
                    
                    // Ativar o renderizador no mapa
                    directionsRenderer.setMap(map);
                    directionsRenderer.setDirections(result);
                    
                    // Ajustar mapa para mostrar a rota completa com marcadores
                    const bounds = new google.maps.LatLngBounds();
                    bounds.extend(origin);
                    bounds.extend(destination);
                    
                    // Incluir a posi√ß√£o atual do motorista se dispon√≠vel
                    if (marker && marker.getPosition()) {
                        bounds.extend(marker.getPosition());
                    }
                    
                    map.fitBounds(bounds);
                    
                    // Adicionar um pequeno padding para melhor visualiza√ß√£o
                    map.panBy(0, -50);
                    
                    showNotification("Rota calculada com sucesso! Marcadores adicionados.");
                    isRouteDisplayed = true;
                    
                } else {
                    console.error('Erro ao calcular rota:', status);
                    showNotification("N√£o foi poss√≠vel calcular a rota.", true);
                }
            });
        }
        
        function rejectRequest(requestId) {
            clearInterval(countdown);
            
            database.ref(`ride_requests/${requestId}`).update({
                status: 'rejected',
                rejectedAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            document.getElementById('requestCard').style.display = 'none';
            
            showNotification("‚ùå Voc√™ rejeitou a solicita√ß√£o.");
            
            currentRequestId = null;
            currentRequest = null;
        }
        
        function startBackgroundTracking() {
            if (!navigator.geolocation) return;
            
            backgroundWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                    };
                    
                    let heading = 0;
                    if (lastPosition) {
                        heading = calculateHeading(lastPosition, pos);
                    }
                    
                    if (marker) {
                        // Definir cor do marcador baseado no status da corrida
                        let iconUrl = "https://i.postimg.cc/d37TyxgN/Screenshot-7-removebg-preview-(1).png";
                        
                        // Sempre usar rota√ß√£o independente do status
                        marker.setIcon({
                            url: iconUrl,
                            scaledSize: new google.maps.Size(40, 60),
                            anchor: new google.maps.Point(20, 20),
                            rotation: heading
                        });
                        
                        marker.setPosition(pos);
                        
                        // N√£o centralizar automaticamente no motorista quando h√° uma rota ativa
                        // A n√£o ser que a rota√ß√£o do mapa esteja ativada
                        if (!isRouteDisplayed && !isMapRotationEnabled && map) {
                            map.setCenter(pos);
                        }
                    }
                    
                    database.ref(`drivers/${currentDriver.driverId}`).update({
                        location: pos,
                        heading: heading,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    lastPosition = pos;
                },
                (error) => {
                    console.error("Erro ao obter localiza√ß√£o:", error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 3000,
                    maximumAge: 1000
                }
            );
        }
        
        function stopTracking() {
            isTracking = false;
            document.getElementById("startTracking").disabled = false;
            document.getElementById("stopTracking").disabled = true;
            
            showNotification("Voc√™ n√£o est√° mais vis√≠vel para os clientes.");
            
            if (backgroundWatchId) {
                navigator.geolocation.clearWatch(backgroundWatchId);
                backgroundWatchId = null;
            }
            
            database.ref(`drivers/${currentDriver.driverId}`).update({
                status: 'offline',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }
        
        function getPaymentMethodText(method) {
            switch(method) {
                case 'cash': return 'üíµ Dinheiro';
                case 'card': return 'üí≥ Cart√£o';
                case 'mbway': return 'üì± MBWay';
                default: return method;
            }
        }
        
        function playNotificationSound() {
            const audio = document.getElementById('notificationSound');
            audio.currentTime = 0;
            audio.play().catch(e => console.log('Erro ao tocar som:', e));
        }
        
        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        document.getElementById('regConfirmPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                register();
            }
        });

        function checkSavedSession() {
            const savedSession = getSavedSession();
            if (savedSession && savedSession.driverId) {
                const drivers = getAllDrivers();
                const driverData = drivers[savedSession.driverId];
                
                if (driverData) {
                    currentDriver = driverData;
                    initializeDriverInterface();
                }
            }
        }

        document.getElementById("startTracking").addEventListener("click", startTracking);
        document.getElementById("stopTracking").addEventListener("click", stopTracking);

        window.addEventListener('load', function() {
            initializeDriversStorage();
            checkSavedSession();
        });

        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentDriver && backgroundWatchId) {
                console.log('P√°gina vis√≠vel - mantendo trabalho ativo');
            }
        });

        window.addEventListener('beforeunload', function() {
            if (currentDriver && backgroundWatchId) {
                console.log('Mantendo trabalho ativo ap√≥s recarregar p√°gina');
            }
        });
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmc6HTJo70N_ueR1qFVgyu74v7FIl7dU4&callback=initMap&libraries=places,directions">
    </script>
</body>
</html>